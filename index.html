<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#075e54">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gmail">
    <title>Gmail</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico">
    <link rel="apple-touch-icon" href="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #0088cc 0%, #0066aa 100%);
            --whatsapp-green: #25d366;
            --whatsapp-dark: #075e54;
            --whatsapp-light: #128c7e;
            --bg-dark: #0a1929;
            --bg-chat: #0d1b2a;
            --bg-message: #1b263b;
            --text-primary: #ffffff;
            --text-secondary: #8696a0;
            --border-color: #2a3a4f;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.15);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.2);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Cairo', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            color: var(--text-primary);
        }
        .hidden { display: none !important; }
        
        /* ==================== Gmail Fake UI ==================== */
        #fake-gmail { width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; }
        .gmail-header { height: 56px; background: #c71610; display: flex; align-items: center; padding: 0 16px; box-shadow: var(--shadow-sm); }
        .gmail-logo { width: 40px; height: 40px; cursor: pointer; user-select: none; transition: transform 0.2s; }
        .gmail-logo:active { transform: scale(0.95); }
        .gmail-search { flex: 1; margin: 0 16px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 20px; display: flex; align-items: center; padding: 0 16px; color: #fff; }
        .gmail-search i { margin-left: 8px; font-size: 18px; }
        .gmail-search input { flex: 1; background: transparent; border: none; outline: none; color: #fff; font-size: 15px; }
        .gmail-search input::placeholder { color: rgba(255,255,255,0.7); }
        .gmail-content { flex: 1; overflow-y: auto; background: #f8f9fa; }
        .gmail-email { background: #fff; margin-bottom: 1px; padding: 16px; display: flex; align-items: flex-start; cursor: pointer; transition: background 0.2s; }
        .gmail-email:hover { background: #f5f7fa; }
        .gmail-email-avatar { 
            width: 44px; height: 44px; border-radius: 50%; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff; display: flex; align-items: center; justify-content: center;
            font-weight: 700; margin-left: 14px; flex-shrink: 0; font-size: 18px;
        }
        .gmail-email-content { flex: 1; min-width: 0; }
        .gmail-email-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .gmail-email-sender { font-weight: 700; font-size: 14px; color: #202124; }
        .gmail-email-time { font-size: 12px; color: #5f6368; }
        .gmail-email-subject { font-size: 14px; color: #202124; margin-bottom: 4px; font-weight: 600; }
        .gmail-email-preview { font-size: 13px; color: #5f6368; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ==================== Login Screen ==================== */
        #code-screen { 
            width: 100%; height: 100%; 
            background: linear-gradient(135deg, #0a1929 0%, #1a237e 50%, #4a148c 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; position: relative; overflow: hidden;
        }
        #code-screen::before {
            content: ''; position: absolute; width: 200%; height: 200%;
            background: radial-gradient(circle at 20% 50%, rgba(37, 211, 102, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(102, 126, 234, 0.1) 0%, transparent 50%);
            animation: drift 25s ease-in-out infinite;
        }
        @keyframes drift { 
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, 30px) rotate(120deg); }
            66% { transform: translate(-30px, 50px) rotate(240deg); }
        }
        .code-container {
            background: rgba(255,255,255,0.98);
            backdrop-filter: blur(30px);
            border-radius: 28px;
            padding: 48px;
            max-width: 440px;
            width: 100%;
            box-shadow: 0 40px 120px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.1);
            animation: slideUp 0.7s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            z-index: 1;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(60px) scale(0.85); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .code-container h2 {
            text-align: center;
            margin-bottom: 35px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 32px;
            font-weight: 900;
            letter-spacing: -0.5px;
        }
        .code-container .lock-icon {
            font-size: 80px;
            text-align: center;
            display: block;
            margin-bottom: 28px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.08); opacity: 0.85; }
        }
        .code-input {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid #e8ecef;
            border-radius: 16px;
            font-size: 22px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 800;
            letter-spacing: 5px;
            text-transform: uppercase;
            background: #fafbfc;
            font-family: 'Cairo', monospace;
        }
        .code-input:focus {
            outline: none;
            border-color: #0088cc;
            box-shadow: 0 0 0 5px rgba(0, 136, 204, 0.15);
            background: #fff;
            transform: translateY(-2px);
        }
        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.25);
            transform: translateX(-100%);
            transition: transform 0.4s;
        }
        .btn:hover::before { transform: translateX(0); }
        .btn-primary {
            background: var(--primary-gradient);
            color: #fff;
            box-shadow: 0 10px 30px rgba(0, 136, 204, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 136, 204, 0.5);
        }
        .btn-primary:active { transform: translateY(-1px); }
        .btn-secondary {
            background: #f5f7fa;
            color: #333;
            margin-top: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .btn-secondary:hover {
            background: #e8ecef;
            transform: translateY(-2px);
        }
        .error-message {
            background: linear-gradient(135deg, #ff5252 0%, #f48fb1 100%);
            color: #fff;
            padding: 16px;
            border-radius: 14px;
            margin: 14px 0;
            text-align: center;
            font-size: 15px;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(255, 82, 82, 0.35);
            animation: shake 0.6s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-12px); }
            75% { transform: translateX(12px); }
        }
        .success-message {
            background: linear-gradient(135deg, var(--whatsapp-green) 0%, #20c997 100%);
            color: #fff;
            padding: 16px;
            border-radius: 14px;
            margin: 14px 0;
            text-align: center;
            font-size: 15px;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.35);
        }

        /* ==================== Admin Screen ==================== */
        #admin-screen { width: 100%; height: 100%; background: #f5f7fa; display: flex; flex-direction: column; }
        .admin-header {
            background: var(--primary-gradient);
            color: #fff;
            padding: 28px 24px;
            box-shadow: var(--shadow-md);
        }
        .admin-header h2 {
            font-size: 30px;
            margin-bottom: 8px;
            font-weight: 900;
            letter-spacing: -0.5px;
        }
        .admin-header p { opacity: 0.95; font-size: 15px; font-weight: 600; }
        .admin-tabs {
            display: flex;
            background: #fff;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .admin-tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 800;
            color: #666;
            font-size: 14px;
        }
        .admin-tab:hover { background: #f8f9fb; }
        .admin-tab.active {
            color: #0088cc;
            border-bottom-color: #0088cc;
            background: #f0f8ff;
        }
        .admin-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        .admin-panel { display: none; }
        .admin-panel.active {
            display: block;
            animation: fadeIn 0.4s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .form-group { margin-bottom: 22px; }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 800;
            color: #1a1a1a;
            font-size: 15px;
        }
        .form-control {
            width: 100%;
            padding: 16px 18px;
            border: 2px solid #e8ecef;
            border-radius: 14px;
            font-size: 16px;
            transition: all 0.3s;
            background: #fafbfc;
            font-weight: 600;
        }
        .form-control:focus {
            outline: none;
            border-color: #0088cc;
            box-shadow: 0 0 0 4px rgba(0, 136, 204, 0.12);
            background: #fff;
        }
        .user-card {
            background: #fff;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .user-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-4px);
            border-color: #0088cc;
        }
        .user-card-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #f0f0f0;
        }
        .user-card-info { flex: 1; }
        .user-card-name {
            font-weight: 800;
            font-size: 18px;
            margin-bottom: 7px;
            color: #1a1a1a;
        }
        .user-card-code {
            font-size: 14px;
            color: #666;
            font-family: 'Courier New', monospace;
            background: #f5f7fa;
            padding: 5px 12px;
            border-radius: 8px;
            display: inline-block;
            font-weight: 700;
        }
        .user-card-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 18px;
        }
        .btn-icon:hover {
            transform: scale(1.2);
            box-shadow: var(--shadow-sm);
        }
        .btn-icon:active { transform: scale(1.05); }
        .btn-icon.btn-view { background: #e3f2fd; color: #1976d2; }
        .btn-icon.btn-chat { background: #e8f5e9; color: #388e3c; }
        .btn-icon.btn-block { background: #fff3e0; color: #f57c00; }
        .btn-icon.btn-delete { background: #ffebee; color: #d32f2f; }

        /* ==================== Home Screen ==================== */
        #home-screen {
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
        }
        .home-header {
            background: linear-gradient(135deg, var(--whatsapp-dark) 0%, var(--whatsapp-light) 100%);
            color: #fff;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-md);
        }
        .home-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .home-header h2 {
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.3px;
        }
        .home-header-actions { display: flex; gap: 12px; }
        .home-header-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.18);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 19px;
        }
        .home-header-btn:hover {
            background: rgba(255,255,255,0.28);
            transform: scale(1.1);
        }
        .home-tabs {
            display: flex;
            background: var(--whatsapp-dark);
            color: #fff;
        }
        .home-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 700;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }
        .home-tab:hover { background: rgba(255,255,255,0.12); }
        .home-tab.active {
            color: #fff;
            border-bottom-color: #fff;
        }
        .home-content {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-dark);
        }
        .home-panel { display: none; }
        .home-panel.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        /* Stories Section */
        .stories-section {
            background: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
            padding: 16px;
            overflow-x: auto;
            white-space: nowrap;
            box-shadow: var(--shadow-md);
        }
        .stories-container {
            display: inline-flex;
            gap: 20px;
            padding: 0 10px;
        }
        .story-item {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .story-item:hover { transform: scale(1.1); }
        .story-avatar-container {
            position: relative;
            width: 76px;
            height: 76px;
        }
        .story-avatar-ring {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            padding: 3px;
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .story-avatar {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--bg-dark);
        }
        .story-add-btn {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--whatsapp-green);
            color: #fff;
            border: 3px solid var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            font-weight: 900;
            cursor: pointer;
        }
        .story-name {
            color: #fff;
            font-size: 13px;
            margin-top: 9px;
            max-width: 76px;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
            font-weight: 600;
        }

        /* Chat List */
        .chat-list { background: var(--bg-dark); }
        .chat-item {
            background: var(--bg-message);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 18px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .chat-item:hover { background: #243447; }
        .chat-item:active { background: #2a3a4f; }
        .chat-item-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            border: 2px solid var(--border-color);
        }
        .chat-item-content { flex: 1; min-width: 0; }
        .chat-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .chat-item-name {
            font-weight: 800;
            font-size: 17px;
            color: #fff;
        }
        .chat-item-time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .chat-item-message {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 7px;
        }
        .chat-item-badge {
            background: var(--whatsapp-green);
            color: #fff;
            border-radius: 50%;
            min-width: 24px;
            height: 24px;
            padding: 0 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 800;
        }
        .message-status {
            color: var(--text-secondary);
            font-size: 17px;
            margin-left: 5px;
        }
        .message-status.read { color: #53bdeb; }

        /* Friend Requests Tab */
        .request-item {
            background: var(--bg-message);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 18px;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .request-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        .btn-accept {
            background: var(--whatsapp-green);
            color: #fff;
            border: none;
            padding: 10px 22px;
            border-radius: 24px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-accept:hover {
            background: #20c997;
            transform: scale(1.05);
        }
        .btn-reject {
            background: #dc3545;
            color: #fff;
            border: none;
            padding: 10px 22px;
            border-radius: 24px;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-reject:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        /* Search Users Tab */
        .search-box {
            padding: 16px;
            background: var(--bg-message);
        }
        .search-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 28px;
            background: var(--bg-dark);
            color: #fff;
            font-size: 15px;
            font-weight: 600;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--whatsapp-green);
        }
        .search-input::placeholder { color: var(--text-secondary); }
        .user-item {
            background: var(--bg-message);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 18px;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .btn-add-friend {
            background: var(--whatsapp-green);
            color: #fff;
            border: none;
            padding: 10px 18px;
            border-radius: 24px;
            font-weight: 800;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.3s;
        }
        .btn-add-friend:hover {
            background: #20c997;
            transform: scale(1.08);
        }
        .btn-pending {
            background: var(--text-secondary);
            cursor: not-allowed;
        }
        .btn-friends { background: var(--whatsapp-dark); }

        /* ==================== Chat Screen ==================== */
        #chat-screen {
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background: linear-gradient(135deg, var(--whatsapp-dark) 0%, var(--whatsapp-light) 100%);
            color: #fff;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-md);
        }
        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 14px;
            flex: 1;
        }
        .chat-back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.18);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 19px;
            transition: all 0.3s;
        }
        .chat-back-btn:hover {
            background: rgba(255,255,255,0.28);
            transform: scale(1.1);
        }
        .chat-header-avatar {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255,255,255,0.35);
            cursor: pointer;
        }
        .chat-header-info {
            flex: 1;
            cursor: pointer;
        }
        .chat-header-info h3 {
            font-size: 19px;
            margin-bottom: 3px;
            font-weight: 800;
            letter-spacing: -0.2px;
        }
        .chat-header-info p {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 600;
        }
        .chat-header-actions { display: flex; gap: 10px; }
        .chat-header-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.18);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 19px;
        }
        .chat-header-btn:hover {
            background: rgba(255,255,255,0.28);
            transform: scale(1.1);
        }

        /* Chat Background */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 22px 12px;
            background: var(--bg-dark);
            position: relative;
        }
        .chat-messages::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="300" viewBox="0 0 100 100"><path d="M20,20 L80,20 L80,80 L20,80 Z" fill="none" stroke="rgba(255,255,255,0.02)" stroke-width="0.5"/></svg>');
            opacity: 0.35;
            pointer-events: none;
        }

        /* Messages */
        .message-group {
            margin-bottom: 18px;
            animation: messageIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes messageIn {
            from { opacity: 0; transform: translateY(24px) scale(0.88); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .message {
            max-width: 80%;
            padding: 10px 14px;
            border-radius: 14px;
            position: relative;
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
            margin-bottom: 5px;
        }
        .message.sent {
            background: linear-gradient(135deg, #005c4b 0%, #00856e 100%);
            color: #fff;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message.received {
            background: var(--bg-message);
            color: #fff;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .message-text {
            font-size: 15px;
            line-height: 1.6;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .message-image {
            max-width: 100%;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        .message-voice {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 5px;
        }
        .voice-play-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255,255,255,0.22);
            border: none;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            transition: all 0.3s;
        }
        .voice-play-btn:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.15);
        }
        .voice-waveform {
            flex: 1;
            height: 32px;
            background: rgba(255,255,255,0.12);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
        }
        .voice-progress {
            height: 100%;
            background: rgba(255,255,255,0.35);
            border-radius: 16px;
            transition: width 0.1s;
        }
        .voice-duration {
            font-size: 12px;
            opacity: 0.85;
            min-width: 48px;
            text-align: right;
            font-weight: 700;
        }
        .message-footer {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 7px;
            font-size: 11px;
            opacity: 0.85;
            margin-top: 5px;
            font-weight: 600;
        }
        .message-time { color: inherit; }
        .message-status-icon { font-size: 15px; }
        .message-deleted {
            background: #2a3a4f !important;
            font-style: italic;
            opacity: 0.75;
            padding: 14px;
            font-weight: 600;
        }
        .message-menu {
            position: absolute;
            top: 50%;
            right: -48px;
            transform: translateY(-50%);
            background: var(--bg-message);
            border-radius: 10px;
            padding: 5px;
            box-shadow: var(--shadow-md);
            display: none;
            z-index: 10;
        }
        .message:hover .message-menu { display: flex; }
        .message-menu button {
            background: none;
            border: none;
            color: #fff;
            padding: 9px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .message-menu button:hover { background: #2a3a4f; }

        /* Chat Input */
        .chat-input {
            background: var(--bg-message);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.25);
        }
        .chat-input-box {
            flex: 1;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 28px;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }
        .chat-input-box:focus-within { border-color: var(--whatsapp-green); }
        .chat-input-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.12);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 21px;
            transition: all 0.3s;
        }
        .chat-input-btn:hover {
            background: rgba(255,255,255,0.22);
            color: #fff;
            transform: scale(1.12);
        }
        .chat-input-field {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }
        .chat-input-field::placeholder { color: var(--text-secondary); }
        .chat-send-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--whatsapp-green) 0%, #20c997 100%);
            color: #fff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 21px;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.45);
        }
        .chat-send-btn:hover {
            transform: scale(1.15);
            box-shadow: 0 7px 20px rgba(37, 211, 102, 0.55);
        }
        .chat-send-btn:active { transform: scale(0.98); }

        /* Voice Recording */
        .voice-recording-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s;
        }
        .voice-recording-content {
            text-align: center;
            color: #fff;
        }
        .voice-recording-icon {
            font-size: 88px;
            color: var(--whatsapp-green);
            margin-bottom: 24px;
            animation: pulse 1.2s infinite;
        }
        .voice-recording-time {
            font-size: 52px;
            font-weight: 900;
            margin-bottom: 12px;
            font-family: 'Cairo', monospace;
            letter-spacing: 3px;
        }
        .voice-recording-text {
            font-size: 19px;
            opacity: 0.88;
            margin-bottom: 44px;
            font-weight: 600;
        }
        .voice-waveform-visual {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 65px;
            margin-bottom: 44px;
        }
        .voice-bar {
            width: 5px;
            background: var(--whatsapp-green);
            border-radius: 3px;
            animation: waveform 0.9s ease-in-out infinite;
        }
        .voice-bar:nth-child(2) { animation-delay: 0.1s; }
        .voice-bar:nth-child(3) { animation-delay: 0.2s; }
        .voice-bar:nth-child(4) { animation-delay: 0.3s; }
        .voice-bar:nth-child(5) { animation-delay: 0.4s; }
        @keyframes waveform {
            0%, 100% { height: 12px; }
            50% { height: 55px; }
        }
        .voice-recording-actions {
            display: flex;
            gap: 24px;
        }
        .voice-action-btn {
            width: 76px;
            height: 76px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 7px;
            font-size: 30px;
            transition: all 0.3s;
        }
        .voice-cancel-btn {
            background: #dc3545;
            color: #fff;
        }
        .voice-cancel-btn:hover {
            background: #c82333;
            transform: scale(1.15);
        }
        .voice-send-btn {
            background: var(--whatsapp-green);
            color: #fff;
        }
        .voice-send-btn:hover {
            background: #20c997;
            transform: scale(1.15);
        }
        .voice-btn-label {
            font-size: 13px;
            font-weight: 800;
        }

        /* Media Viewer */
        .media-viewer {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.96);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s;
        }
        .media-viewer-header {
            background: var(--whatsapp-dark);
            padding: 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .media-viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .media-viewer-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .media-close-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255,255,255,0.22);
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 26px;
            transition: all 0.3s;
        }
        .media-close-btn:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.1);
        }
        .media-download-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--whatsapp-green);
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 22px;
            transition: all 0.3s;
        }
        .media-download-btn:hover {
            background: #20c997;
            transform: scale(1.1);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.35);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 0.9s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: inherit;
        }

        /* Utility */
        .text-center { text-align: center; }
        .mt-2 { margin-top: 10px; }
        .mb-2 { margin-bottom: 10px; }
        .p-2 { padding: 10px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 9px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover { background: #3a4a5f; }
    </style>
</head>
<body>

    <!-- Gmail Fake UI -->
    <div id="fake-gmail">
        <div class="gmail-header">
            <svg class="gmail-logo" viewBox="0 0 24 24" fill="#fff">
                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
            </svg>
            <div class="gmail-search">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="بحث في Gmail" readonly>
            </div>
            <i class="fas fa-user-circle" style="font-size: 26px; color: #fff;"></i>
        </div>
        <div class="gmail-content" id="gmail-emails"></div>
    </div>

    <!-- Login Screen -->
    <div id="code-screen" class="hidden">
        <div class="code-container">
            <i class="fas fa-lock lock-icon"></i>
            <h2>أدخل الكود</h2>
            <input type="text" class="code-input" id="user-code" placeholder="الكود" maxlength="10">
            <div id="code-message"></div>
            <button class="btn btn-primary" id="login-btn">
                <i class="fas fa-sign-in-alt"></i>
                <span>دخول</span>
            </button>
            <button class="btn btn-secondary" id="qr-scan-btn">
                <i class="fas fa-qrcode"></i>
                <span>مسح QR Code</span>
            </button>
        </div>
    </div>

    <!-- Admin Screen -->
    <div id="admin-screen" class="hidden">
        <div class="admin-header">
            <h2><i class="fas fa-shield-alt"></i> لوحة الأدمن</h2>
            <p>إدارة كاملة للنظام</p>
        </div>
        <div class="admin-tabs">
            <div class="admin-tab active" data-tab="create"><i class="fas fa-user-plus"></i> إنشاء</div>
            <div class="admin-tab" data-tab="users"><i class="fas fa-users"></i> المستخدمين</div>
            <div class="admin-tab" data-tab="chats"><i class="fas fa-comments"></i> المحادثات</div>
            <div class="admin-tab" data-tab="settings"><i class="fas fa-cog"></i> إعدادات</div>
        </div>
        <div class="admin-content">
            <div class="admin-panel active" id="panel-create">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> اسم المستخدم</label>
                    <input type="text" class="form-control" id="new-user-name" placeholder="أدخل الاسم">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-key"></i> الكود (اختياري)</label>
                    <input type="text" class="form-control" id="new-user-code" placeholder="سيتم توليده تلقائياً">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-image"></i> رابط الصورة (اختياري)</label>
                    <input type="url" class="form-control" id="new-user-avatar" placeholder="https://example.com/avatar.jpg">
                </div>
                <button class="btn btn-primary" id="create-user-btn">
                    <i class="fas fa-plus-circle"></i>
                    <span>إنشاء مستخدم</span>
                </button>
                <div id="qr-code-display"></div>
            </div>

            <div class="admin-panel" id="panel-users">
                <div id="users-list"></div>
            </div>

            <div class="admin-panel" id="panel-chats">
                <div id="chats-list"></div>
            </div>

            <div class="admin-panel" id="panel-settings">
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> كود الأدمن الحالي</label>
                    <input type="password" class="form-control" id="current-admin-code" placeholder="أدخل الكود الحالي">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-key"></i> كود الأدمن الجديد</label>
                    <input type="password" class="form-control" id="new-admin-code" placeholder="أدخل الكود الجديد">
                </div>
                <button class="btn btn-primary" id="change-admin-code-btn">
                    <i class="fas fa-save"></i>
                    <span>تغيير الكود</span>
                </button>
                <button class="btn btn-secondary" id="admin-logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>تسجيل خروج</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Home Screen -->
    <div id="home-screen" class="hidden">
        <div class="home-header">
            <div class="home-header-left">
                <h2>WhatsApp</h2>
            </div>
            <div class="home-header-actions">
                <button class="home-header-btn"><i class="fas fa-search"></i></button>
                <button class="home-header-btn" id="home-menu-btn"><i class="fas fa-ellipsis-v"></i></button>
            </div>
        </div>
        <div class="home-tabs">
            <div class="home-tab active" data-tab="chats"><i class="fas fa-comment-dots"></i> المحادثات</div>
            <div class="home-tab" data-tab="requests"><i class="fas fa-user-plus"></i> الطلبات</div>
            <div class="home-tab" data-tab="search"><i class="fas fa-search"></i> بحث</div>
        </div>
        <div class="home-content">
            <div class="home-panel active" id="home-panel-chats">
                <div class="stories-section">
                    <div class="stories-container" id="stories-list"></div>
                </div>
                <div class="chat-list" id="home-chat-list"></div>
            </div>

            <div class="home-panel" id="home-panel-requests">
                <div id="friend-requests-list"></div>
            </div>

            <div class="home-panel" id="home-panel-search">
                <div class="search-box">
                    <input type="text" class="search-input" id="search-users-input" placeholder="ابحث عن مستخدمين...">
                </div>
                <div id="search-results-list"></div>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen" class="hidden">
        <div class="chat-header">
            <div class="chat-header-left">
                <button class="chat-back-btn" id="chat-back-btn"><i class="fas fa-arrow-right"></i></button>
                <img class="chat-header-avatar" id="chat-avatar" src="" alt="">
                <div class="chat-header-info">
                    <h3 id="chat-name"></h3>
                    <p id="chat-status">متصل</p>
                </div>
            </div>
            <div class="chat-header-actions">
                <button class="chat-header-btn"><i class="fas fa-video"></i></button>
                <button class="chat-header-btn"><i class="fas fa-phone"></i></button>
                <button class="chat-header-btn"><i class="fas fa-ellipsis-v"></i></button>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
            <div class="chat-input-box">
                <button class="chat-input-btn"><i class="fas fa-face-smile"></i></button>
                <input type="text" class="chat-input-field" id="message-input" placeholder="اكتب رسالة...">
                <input type="file" id="image-input" accept="image/*" style="display: none;">
                <button class="chat-input-btn" id="attach-btn"><i class="fas fa-paperclip"></i></button>
            </div>
            <button class="chat-send-btn" id="voice-btn"><i class="fas fa-microphone"></i></button>
            <button class="chat-send-btn hidden" id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- Voice Recording Overlay -->
    <div id="voice-recording-overlay" class="voice-recording-overlay hidden">
        <div class="voice-recording-content">
            <div class="voice-recording-icon"><i class="fas fa-microphone"></i></div>
            <div class="voice-recording-time" id="voice-timer">00:00</div>
            <div class="voice-recording-text">جاري التسجيل...</div>
            <div class="voice-waveform-visual">
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
                <div class="voice-bar"></div>
            </div>
            <div class="voice-recording-actions">
                <button class="voice-action-btn voice-cancel-btn" id="voice-cancel-btn">
                    <i class="fas fa-times"></i>
                    <span class="voice-btn-label">إلغاء</span>
                </button>
                <button class="voice-action-btn voice-send-btn" id="voice-send-btn">
                    <i class="fas fa-paper-plane"></i>
                    <span class="voice-btn-label">إرسال</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Media Viewer -->
    <div id="media-viewer" class="media-viewer hidden">
        <div class="media-viewer-header">
            <button class="media-close-btn" id="media-close-btn"><i class="fas fa-times"></i></button>
            <button class="media-download-btn" id="media-download-btn"><i class="fas fa-download"></i></button>
        </div>
        <div class="media-viewer-content">
            <img id="media-viewer-image" class="media-viewer-image" src="" alt="">
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let currentChatUser = null;
        let clickCount = 0;
        let clickTimer = null;
        let voiceRecorder = null;
        let voiceRecordingTime = 0;
        let voiceTimerInterval = null;
        let audioChunks = [];
        let activeMessageListeners = {};

        // Helper Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function generateCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function formatTime(date) {
            const now = new Date();
            const messageDate = new Date(date);
            const diff = now - messageDate;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (seconds < 60) return 'الآن';
            if (minutes < 60) return `منذ ${minutes} د`;
            if (hours < 24) return `منذ ${hours} س`;
            if (days === 1) return 'أمس';
            if (days < 7) return `منذ ${days} يوم`;
            return messageDate.toLocaleDateString('ar');
        }

        function formatMessageTime(date) {
            const d = new Date(date);
            const hours = d.getHours().toString().padStart(2, '0');
            const minutes = d.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}-message">${escapeHtml(message)}</div>`;
            setTimeout(() => element.innerHTML = '', 4000);
        }

        function showScreen(screenId) {
            ['fake-gmail', 'code-screen', 'admin-screen', 'home-screen', 'chat-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        // Gmail Fake UI
        const fakeEmails = [
            { sender: 'Google', subject: 'تحديث أمان مهم', preview: 'تم تسجيل دخول جديد إلى حسابك', time: -120, color: '#EA4335' },
            { sender: 'Facebook', subject: 'لديك 3 إشعارات جديدة', preview: 'أحمد وآخرون تفاعلوا مع منشورك', time: -180, color: '#4267B2' },
            { sender: 'Amazon', subject: 'طلبك في الطريق', preview: 'سيصل طلبك اليوم بين الساعة 2-4 مساءً', time: -240, color: '#FF9900' },
            { sender: 'Twitter', subject: 'نشاط جديد على حسابك', preview: 'لديك 5 إشعارات جديدة', time: -300, color: '#1DA1F2' },
            { sender: 'Instagram', subject: 'sarah.ahmed بدأت متابعتك', preview: 'وأشخاص آخرون يتابعونك', time: -360, color: '#E1306C' },
            { sender: 'Netflix', subject: 'إصدارات جديدة هذا الأسبوع', preview: 'شاهد أحدث المسلسلات والأفلام', time: -420, color: '#E50914' },
            { sender: 'PayPal', subject: 'استلمت دفعة', preview: 'تم إضافة 250.00 دولار إلى حسابك', time: -86400, color: '#00457C' },
            { sender: 'LinkedIn', subject: 'أحمد شاهد ملفك الشخصي', preview: 'وظائف جديدة قد تناسبك', time: -172800, color: '#0077B5' },
            { sender: 'YouTube', subject: 'فيديوهات جديدة من القنوات المفضلة', preview: 'Tech Channel رفع فيديو جديد', time: -259200, color: '#FF0000' },
            { sender: 'Spotify', subject: 'قائمة تشغيل جديدة لك', preview: 'استمع إلى أحدث الأغاني المختارة', time: -345600, color: '#1DB954' }
        ];

        function generateFakeEmails() {
            const container = document.getElementById('gmail-emails');
            container.innerHTML = fakeEmails.map(email => {
                const timeStr = formatTime(Date.now() + (email.time * 1000));
                const initial = email.sender.charAt(0);
                return `
                    <div class="gmail-email">
                        <div class="gmail-email-avatar" style="background: ${email.color}">${initial}</div>
                        <div class="gmail-email-content">
                            <div class="gmail-email-header">
                                <span class="gmail-email-sender">${email.sender}</span>
                                <span class="gmail-email-time">${timeStr}</span>
                            </div>
                            <div class="gmail-email-subject">${email.subject}</div>
                            <div class="gmail-email-preview">${email.preview}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        setInterval(() => {
            if (!document.getElementById('fake-gmail').classList.contains('hidden')) {
                generateFakeEmails();
            }
        }, 60000);

        document.querySelector('.gmail-logo').addEventListener('click', () => {
            clickCount++;
            clearTimeout(clickTimer);
            clickTimer = setTimeout(() => clickCount = 0, 2000);
            if (clickCount === 5) {
                showScreen('code-screen');
                clickCount = 0;
            }
        });

        // Login System
        document.getElementById('login-btn').addEventListener('click', async () => {
            const code = document.getElementById('user-code').value.trim().toUpperCase();
            if (!code) {
                showMessage('code-message', 'الرجاء إدخال الكود', 'error');
                return;
            }

            const adminSnapshot = await database.ref('admin/code').once('value');
            const adminCode = adminSnapshot.val() || 'ADMIN';
            
            if (code === adminCode) {
                currentUser = { id: 'admin', name: 'الأدمن', isAdmin: true };
                showScreen('admin-screen');
                loadAdminData();
                return;
            }

            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val() || {};
            const user = Object.entries(users).find(([id, u]) => u.code === code);

            if (user) {
                const [userId, userData] = user;
                if (userData.blocked) {
                    showMessage('code-message', 'هذا الحساب محظور', 'error');
                    return;
                }
                currentUser = { id: userId, ...userData };
                showScreen('home-screen');
                loadHomeData();
            } else {
                showMessage('code-message', 'كود غير صحيح', 'error');
            }
        });

        // Admin Functions
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
                
                if (tab.dataset.tab === 'users') loadUsersList();
                if (tab.dataset.tab === 'chats') loadChatsList();
            });
        });

        document.getElementById('create-user-btn').addEventListener('click', async () => {
            const name = document.getElementById('new-user-name').value.trim();
            const code = document.getElementById('new-user-code').value.trim().toUpperCase() || generateCode();
            const avatar = document.getElementById('new-user-avatar').value.trim() || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&size=200&bold=true`;

            if (!name) {
                alert('الرجاء إدخال اسم المستخدم');
                return;
            }

            const newUser = {
                name,
                code,
                avatar,
                createdAt: Date.now(),
                blocked: false,
                friends: {},
                friendRequests: {}
            };

            const newUserRef = database.ref('users').push();
            await newUserRef.set(newUser);

            showMessage('code-message', `تم إنشاء المستخدم بنجاح!\nالكود: ${code}`, 'success');
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-code').value = '';
            document.getElementById('new-user-avatar').value = '';

            document.getElementById('qr-code-display').innerHTML = `
                <div style="background: #fff; border-radius: 18px; padding: 28px; margin-top: 24px; text-align: center; box-shadow: 0 4px 16px rgba(0,0,0,0.1);">
                    <h3 style="color: #333; margin-bottom: 18px; font-size: 20px;">QR Code للمستخدم</h3>
                    <div style="font-size: 56px; font-weight: 900; padding: 44px; background: linear-gradient(135deg, #f5f7fa 0%, #e8ecef 100%); border-radius: 16px; margin: 22px 0; letter-spacing: 8px;">
                        ${code}
                    </div>
                    <p style="color: #666; font-size: 16px; font-weight: 700;">الكود: <strong style="color: #0088cc; font-size: 20px;">${code}</strong></p>
                </div>
            `;
        });

        async function loadUsersList() {
            const snapshot = await database.ref('users').once('value');
            const users = snapshot.val() || {};
            const container = document.getElementById('users-list');
            
            container.innerHTML = Object.entries(users).map(([id, user]) => `
                <div class="user-card">
                    <img class="user-card-avatar" src="${user.avatar}" alt="${user.name}">
                    <div class="user-card-info">
                        <div class="user-card-name">${escapeHtml(user.name)}</div>
                        <div class="user-card-code">${user.code}</div>
                    </div>
                    <div class="user-card-actions">
                        <button class="btn-icon btn-view" onclick="showUserQR('${user.code}')"><i class="fas fa-qrcode"></i></button>
                        <button class="btn-icon btn-chat" onclick="openAdminChat('${id}', '${escapeHtml(user.name)}', '${user.avatar}')"><i class="fas fa-comment"></i></button>
                        <button class="btn-icon btn-block" onclick="toggleBlockUser('${id}', ${user.blocked || false})">
                            <i class="fas fa-${user.blocked ? 'unlock' : 'ban'}"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="deleteUser('${id}')"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        async function loadChatsList() {
            const snapshot = await database.ref('chats').once('value');
            const chats = snapshot.val() || {};
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val() || {};
            const container = document.getElementById('chats-list');
            
            const chatsList = Object.entries(chats).map(([chatId, chatData]) => {
                const participants = chatId.split('_');
                const user1 = users[participants[0]];
                const user2 = users[participants[1]];
                if (!user1 || !user2) return '';
                
                const messages = chatData.messages ? Object.values(chatData.messages) : [];
                const lastMessage = messages[messages.length - 1];
                
                return `
                    <div class="user-card" style="cursor: pointer;" onclick="openAdminChat('${participants[1]}', '${escapeHtml(user2.name)}', '${user2.avatar}')">
                        <img class="user-card-avatar" src="${user1.avatar}" alt="${user1.name}">
                        <div class="user-card-info">
                            <div class="user-card-name">${escapeHtml(user1.name)} ↔ ${escapeHtml(user2.name)}</div>
                            <div class="user-card-code">${messages.length} رسالة</div>
                            ${lastMessage ? `<div style="font-size: 14px; color: #666; margin-top: 6px; font-weight: 600;">${lastMessage.text ? escapeHtml(lastMessage.text.substring(0, 50)) : '📷 صورة'}</div>` : ''}
                        </div>
                    </div>
                `;
            }).filter(Boolean);
            
            container.innerHTML = chatsList.length ? chatsList.join('') : '<div class="text-center p-2" style="color: #666; font-size: 16px; margin-top: 40px;">لا توجد محادثات بعد</div>';
        }

        window.showUserQR = (code) => {
            alert(`كود المستخدم:\n\n${code}\n\nيمكن استخدام هذا الكود للدخول`);
        };

        window.toggleBlockUser = async (userId, isBlocked) => {
            if (confirm(`هل أنت متأكد من ${isBlocked ? 'إلغاء حظر' : 'حظر'} هذا المستخدم؟`)) {
                await database.ref(`users/${userId}/blocked`).set(!isBlocked);
                loadUsersList();
            }
        };

        window.deleteUser = async (userId) => {
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟\nلا يمكن التراجع عن هذا الإجراء!')) {
                await database.ref(`users/${userId}`).remove();
                loadUsersList();
            }
        };

        window.openAdminChat = (userId, userName, userAvatar) => {
            currentUser = { id: 'admin', name: 'الأدمن', isAdmin: true };
            currentChatUser = { id: userId, name: userName, avatar: userAvatar };
            openChat(currentChatUser);
        };

        document.getElementById('admin-logout-btn').addEventListener('click', () => {
            currentUser = null;
            showScreen('fake-gmail');
        });

        document.getElementById('change-admin-code-btn').addEventListener('click', async () => {
            const currentCode = document.getElementById('current-admin-code').value.trim();
            const newCode = document.getElementById('new-admin-code').value.trim();
            
            if (!currentCode || !newCode) {
                alert('الرجاء إدخال الكودين');
                return;
            }

            const adminSnapshot = await database.ref('admin/code').once('value');
            const adminCode = adminSnapshot.val() || 'ADMIN';

            if (currentCode !== adminCode) {
                alert('الكود الحالي غير صحيح');
                return;
            }

            if (newCode.length < 5) {
                alert('الكود الجديد يجب أن يكون 5 أحرف على الأقل');
                return;
            }

            await database.ref('admin/code').set(newCode.toUpperCase());
            alert('تم تغيير كود الأدمن بنجاح!');
            document.getElementById('current-admin-code').value = '';
            document.getElementById('new-admin-code').value = '';
        });

        function loadAdminData() {
            loadUsersList();
        }

        // Home Screen Functions
        document.querySelectorAll('.home-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.home-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.home-panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`home-panel-${tab.dataset.tab}`).classList.add('active');
                
                if (tab.dataset.tab === 'requests') loadFriendRequests();
            });
        });

        document.getElementById('home-menu-btn').addEventListener('click', () => {
            if (confirm('تسجيل الخروج؟')) {
                currentUser = null;
                currentChatUser = null;
                Object.keys(activeMessageListeners).forEach(key => {
                    database.ref(key).off();
                });
                activeMessageListeners = {};
                showScreen('fake-gmail');
            }
        });

        async function loadHomeData() {
            loadChatsList_User();
            loadStories();
            loadFriendRequests();
            setupSearchUsers();
        }

        async function loadChatsList_User() {
            const friendsSnapshot = await database.ref(`users/${currentUser.id}/friends`).once('value');
            const friends = friendsSnapshot.val() || {};
            const friendIds = Object.keys(friends);

            if (friendIds.length === 0) {
                document.getElementById('home-chat-list').innerHTML = '<div class="text-center p-2" style="color: #8696a0; margin-top: 50px; font-size: 17px; font-weight: 600;">لا توجد محادثات بعد<br><br>ابحث عن مستخدمين وأضفهم كأصدقاء</div>';
                return;
            }

            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val() || {};

            const chatsList = [];
            for (const friendId of friendIds) {
                const friend = users[friendId];
                if (!friend) continue;

                const chatId = [currentUser.id, friendId].sort().join('_');
                const chatSnapshot = await database.ref(`chats/${chatId}/messages`).once('value');
                const messages = chatSnapshot.val() || {};
                const messagesList = Object.values(messages).sort((a, b) => a.timestamp - b.timestamp);
                const lastMessage = messagesList[messagesList.length - 1];

                const unreadCount = messagesList.filter(msg => 
                    msg.senderId === friendId && !msg.read
                ).length;

                chatsList.push({
                    friend,
                    lastMessage,
                    unreadCount,
                    timestamp: lastMessage ? lastMessage.timestamp : 0
                });
            }

            chatsList.sort((a, b) => b.timestamp - a.timestamp);

            const container = document.getElementById('home-chat-list');
            container.innerHTML = chatsList.map(chat => {
                const lastMsgText = chat.lastMessage 
                    ? (chat.lastMessage.text ? chat.lastMessage.text.substring(0, 42) : 
                       chat.lastMessage.image ? '📷 صورة' : 
                       chat.lastMessage.voice ? '🎤 رسالة صوتية' : '')
                    : 'لا توجد رسائل بعد';
                
                const statusIcon = chat.lastMessage && chat.lastMessage.senderId === currentUser.id
                    ? (chat.lastMessage.read ? '<i class="fas fa-check-double message-status read"></i>' : '<i class="fas fa-check-double message-status"></i>')
                    : '';

                return `
                    <div class="chat-item" onclick="openChat({id: '${chat.friend.id || ''}', name: '${escapeHtml(chat.friend.name)}', avatar: '${chat.friend.avatar}'})">
                        <img class="chat-item-avatar" src="${chat.friend.avatar}" alt="${chat.friend.name}">
                        <div class="chat-item-content">
                            <div class="chat-item-header">
                                <div class="chat-item-name">${escapeHtml(chat.friend.name)}</div>
                                <div class="chat-item-time">${chat.lastMessage ? formatTime(chat.lastMessage.timestamp) : ''}</div>
                            </div>
                            <div class="chat-item-message">
                                ${statusIcon}
                                <span>${escapeHtml(lastMsgText)}</span>
                            </div>
                        </div>
                        ${chat.unreadCount > 0 ? `<div class="chat-item-badge">${chat.unreadCount}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function loadStories() {
            const storiesSnapshot = await database.ref('stories').once('value');
            const stories = storiesSnapshot.val() || {};
            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val() || {};

            const now = Date.now();
            const validStories = Object.entries(stories).filter(([id, story]) => {
                return now - story.timestamp < 86400000; // 24 hours
            });

            const container = document.getElementById('stories-list');
            
            const myStory = validStories.find(([id, story]) => story.userId === currentUser.id);
            const myStoryHtml = `
                <div class="story-item" onclick="createStory()">
                    <div class="story-avatar-container">
                        ${myStory ? `
                            <div class="story-avatar-ring">
                                <img class="story-avatar" src="${currentUser.avatar}" alt="أنا">
                            </div>
                        ` : `
                            <img class="story-avatar" src="${currentUser.avatar}" alt="أنا" style="border: 3px solid #2a3a4f;">
                            <div class="story-add-btn"><i class="fas fa-plus"></i></div>
                        `}
                    </div>
                    <div class="story-name">ستوريك</div>
                </div>
            `;

            const friendsStories = validStories
                .filter(([id, story]) => story.userId !== currentUser.id)
                .map(([id, story]) => {
                    const user = users[story.userId];
                    if (!user) return '';
                    return `
                        <div class="story-item" onclick="viewStory('${id}')">
                            <div class="story-avatar-container">
                                <div class="story-avatar-ring">
                                    <img class="story-avatar" src="${user.avatar}" alt="${user.name}">
                                </div>
                            </div>
                            <div class="story-name">${escapeHtml(user.name)}</div>
                        </div>
                    `;
                })
                .join('');

            container.innerHTML = myStoryHtml + friendsStories;
        }

        window.createStory = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const isVideo = file.type.startsWith('video/');
                const storageRef = storage.ref(`stories/${currentUser.id}/${Date.now()}_${file.name}`);
                
                try {
                    const snapshot = await storageRef.put(file);
                    const url = await snapshot.ref.getDownloadURL();
                    
                    const storyData = {
                        userId: currentUser.id,
                        type: isVideo ? 'video' : 'image',
                        url,
                        timestamp: Date.now(),
                        privacy: 'public'
                    };

                    await database.ref('stories').push().set(storyData);
                    loadStories();
                    alert('تم نشر الستوري بنجاح! ✨');
                } catch (error) {
                    console.error(error);
                    alert('حدث خطأ أثناء نشر الستوري');
                }
            };
            input.click();
        };

        window.viewStory = async (storyId) => {
            alert('عرض الستوري (قريباً)');
        };

        async function loadFriendRequests() {
            const requestsSnapshot = await database.ref(`users/${currentUser.id}/friendRequests`).once('value');
            const requests = requestsSnapshot.val() || {};
            const requestIds = Object.keys(requests).filter(id => requests[id].status === 'pending');

            if (requestIds.length === 0) {
                document.getElementById('friend-requests-list').innerHTML = '<div class="text-center p-2" style="color: #8696a0; margin-top: 50px; font-size: 17px; font-weight: 600;">لا توجد طلبات صداقة</div>';
                return;
            }

            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val() || {};

            const container = document.getElementById('friend-requests-list');
            container.innerHTML = requestIds.map(userId => {
                const user = users[userId];
                if (!user) return '';
                return `
                    <div class="request-item">
                        <img class="chat-item-avatar" src="${user.avatar}" alt="${user.name}">
                        <div class="chat-item-content">
                            <div class="chat-item-name">${escapeHtml(user.name)}</div>
                            <div class="request-actions">
                                <button class="btn-accept" onclick="acceptFriendRequest('${userId}')">قبول</button>
                                <button class="btn-reject" onclick="rejectFriendRequest('${userId}')">رفض</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.acceptFriendRequest = async (userId) => {
            await database.ref(`users/${currentUser.id}/friends/${userId}`).set(true);
            await database.ref(`users/${userId}/friends/${currentUser.id}`).set(true);
            
            await database.ref(`users/${currentUser.id}/friendRequests/${userId}`).remove();
            await database.ref(`users/${userId}/friendRequests/${currentUser.id}`).remove();
            
            loadFriendRequests();
            loadChatsList_User();
            alert('تم قبول طلب الصداقة ✅');
        };

        window.rejectFriendRequest = async (userId) => {
            await database.ref(`users/${currentUser.id}/friendRequests/${userId}`).remove();
            await database.ref(`users/${userId}/friendRequests/${currentUser.id}`).remove();
            loadFriendRequests();
            alert('تم رفض طلب الصداقة');
        };

        function setupSearchUsers() {
            const searchInput = document.getElementById('search-users-input');
            let searchTimeout;

            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(searchUsers, 500);
            });
        }

        async function searchUsers() {
            const query = document.getElementById('search-users-input').value.trim().toLowerCase();
            if (!query) {
                document.getElementById('search-results-list').innerHTML = '';
                return;
            }

            const usersSnapshot = await database.ref('users').once('value');
            const users = usersSnapshot.val() || {};
            
            const friendsSnapshot = await database.ref(`users/${currentUser.id}/friends`).once('value');
            const friends = friendsSnapshot.val() || {};
            
            const requestsSnapshot = await database.ref(`users/${currentUser.id}/friendRequests`).once('value');
            const requests = requestsSnapshot.val() || {};

            const results = Object.entries(users)
                .filter(([id, user]) => {
                    if (id === currentUser.id) return false;
                    return user.name.toLowerCase().includes(query) || user.code.toLowerCase().includes(query);
                })
                .map(([id, user]) => {
                    const isFriend = friends[id];
                    const hasSentRequest = requests[id] && requests[id].status === 'sent';
                    const hasReceivedRequest = requests[id] && requests[id].status === 'pending';

                    let buttonHtml = '';
                    if (isFriend) {
                        buttonHtml = '<button class="btn-add-friend btn-friends">صديق ✓</button>';
                    } else if (hasSentRequest) {
                        buttonHtml = '<button class="btn-add-friend btn-pending">قيد الانتظار...</button>';
                    } else if (hasReceivedRequest) {
                        buttonHtml = '<button class="btn-add-friend btn-accept" onclick="acceptFriendRequest(\'' + id + '\')">قبول الطلب</button>';
                    } else {
                        buttonHtml = '<button class="btn-add-friend" onclick="sendFriendRequest(\'' + id + '\')">إضافة +</button>';
                    }

                    return `
                        <div class="user-item">
                            <img class="chat-item-avatar" src="${user.avatar}" alt="${user.name}">
                            <div class="chat-item-content">
                                <div class="chat-item-name">${escapeHtml(user.name)}</div>
                                <div class="user-card-code">${user.code}</div>
                            </div>
                            ${buttonHtml}
                        </div>
                    `;
                });

            document.getElementById('search-results-list').innerHTML = results.length 
                ? results.join('') 
                : '<div class="text-center p-2" style="color: #8696a0; margin-top: 30px; font-size: 16px; font-weight: 600;">لم يتم العثور على نتائج</div>';
        }

        window.sendFriendRequest = async (userId) => {
            await database.ref(`users/${userId}/friendRequests/${currentUser.id}`).set({
                status: 'pending',
                timestamp: Date.now()
            });
            await database.ref(`users/${currentUser.id}/friendRequests/${userId}`).set({
                status: 'sent',
                timestamp: Date.now()
            });
            searchUsers();
            alert('تم إرسال طلب الصداقة ✅');
        };

        // Chat Functions
        function openChat(user) {
            currentChatUser = user;
            document.getElementById('chat-name').textContent = user.name;
            document.getElementById('chat-avatar').src = user.avatar;
            document.getElementById('chat-status').textContent = 'متصل';
            document.getElementById('chat-messages').innerHTML = '';
            
            showScreen('chat-screen');
            loadMessages();
            
            // Setup real-time listener
            const chatId = [currentUser.id, currentChatUser.id].sort().join('_');
            const messagesRef = database.ref(`chats/${chatId}/messages`);
            
            // Remove old listeners
            Object.keys(activeMessageListeners).forEach(key => {
                database.ref(key).off();
            });
            activeMessageListeners = {};
            
            // Add new listener
            activeMessageListeners[`chats/${chatId}/messages`] = true;
            messagesRef.on('value', (snapshot) => {
                if (!document.getElementById('chat-screen').classList.contains('hidden')) {
                    loadMessages();
                    markMessagesAsRead();
                }
            });
        }

        async function loadMessages() {
            const chatId = [currentUser.id, currentChatUser.id].sort().join('_');
            const messagesSnapshot = await database.ref(`chats/${chatId}/messages`).once('value');
            const messages = messagesSnapshot.val() || {};
            const messagesList = Object.entries(messages).sort((a, b) => a[1].timestamp - b[1].timestamp);

            const container = document.getElementById('chat-messages');
            const scrollAtBottom = container.scrollHeight - container.scrollTop === container.clientHeight;
            
            container.innerHTML = messagesList.map(([msgId, msg]) => {
                const isSent = msg.senderId === currentUser.id;
                const messageClass = isSent ? 'sent' : 'received';
                
                let messageContent = '';
                if (msg.deleted) {
                    messageContent = '<div class="message-deleted">🚫 تم حذف هذه الرسالة</div>';
                } else if (msg.deletedForMe && msg.deletedForMe.includes(currentUser.id)) {
                    return '';
                } else if (msg.image) {
                    messageContent = `<img class="message-image" src="${msg.image}" alt="صورة" onclick="viewImage('${msg.image}')">`;
                } else if (msg.voice) {
                    messageContent = `
                        <div class="message-voice">
                            <button class="voice-play-btn" onclick="playVoice('${msg.voice}')"><i class="fas fa-play"></i></button>
                            <div class="voice-waveform"><div class="voice-progress" style="width: 0%"></div></div>
                            <div class="voice-duration">${msg.duration || '0:00'}</div>
                        </div>
                    `;
                } else if (msg.text) {
                    messageContent = `<div class="message-text">${escapeHtml(msg.text)}</div>`;
                }

                const statusIcon = isSent 
                    ? (msg.read ? '<i class="fas fa-check-double message-status-icon" style="color: #53bdeb;"></i>' : '<i class="fas fa-check message-status-icon"></i>')
                    : '';

                return `
                    <div class="message-group">
                        <div class="message ${messageClass}">
                            ${messageContent}
                            <div class="message-footer">
                                <span class="message-time">${formatMessageTime(msg.timestamp)}</span>
                                ${statusIcon}
                            </div>
                            ${!msg.deleted ? `
                                <div class="message-menu">
                                    <button onclick="deleteMessage('${msgId}', false)" title="حذف لدي فقط"><i class="fas fa-trash"></i></button>
                                    ${isSent ? `<button onclick="deleteMessage('${msgId}', true)" title="حذف للطرفين"><i class="fas fa-trash-alt"></i></button>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            if (scrollAtBottom || messagesList.length < 5) {
                container.scrollTop = container.scrollHeight;
            }
        }

        async function markMessagesAsRead() {
            const chatId = [currentUser.id, currentChatUser.id].sort().join('_');
            const messagesSnapshot = await database.ref(`chats/${chatId}/messages`).once('value');
            const messages = messagesSnapshot.val() || {};

            const updates = {};
            Object.entries(messages).forEach(([msgId, msg]) => {
                if (msg.senderId === currentChatUser.id && !msg.read) {
                    updates[`chats/${chatId}/messages/${msgId}/read`] = true;
                }
            });

            if (Object.keys(updates).length > 0) {
                await database.ref().update(updates);
            }
        }

        window.deleteMessage = async (msgId, forBoth) => {
            const chatId = [currentUser.id, currentChatUser.id].sort().join('_');
            
            if (forBoth) {
                if (confirm('هل تريد حذف هذه الرسالة للطرفين؟')) {
                    await database.ref(`chats/${chatId}/messages/${msgId}`).update({ deleted: true });
                }
            } else {
                await database.ref(`chats/${chatId}/messages/${msgId}/deletedForMe`).set([currentUser.id]);
            }
        };

        window.viewImage = (url) => {
            document.getElementById('media-viewer-image').src = url;
            document.getElementById('media-viewer').classList.remove('hidden');
        };

        window.playVoice = (url) => {
            const audio = new Audio(url);
            audio.play();
        };

        document.getElementById('chat-back-btn').addEventListener('click', () => {
            const chatId = [currentUser.id, currentChatUser.id].sort().join('_');
            database.ref(`chats/${chatId}/messages`).off();
            delete activeMessageListeners[`chats/${chatId}/messages`];
            currentChatUser = null;
            showScreen('home-screen');
            loadChatsList_User();
        });

        // Message Input
        document.getElementById('message-input').addEventListener('input', (e) => {
            const hasText = e.target.value.trim().length > 0;
            document.getElementById('voice-btn').classList.toggle('hidden', hasText);
            document.getElementById('send-btn').classList.toggle('hidden', !hasText);
        });

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        document.getElementById('message-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            if (!text) return;

            const chatId = [currentUser.id, currentChatUser.id].sort().join('_');
            const messageData = {
                senderId: currentUser.id,
                text,
                timestamp: Date.now(),
                read: false
            };

            await database.ref(`chats/${chatId}/messages`).push().set(messageData);
            input.value = '';
            document.getElementById('voice-btn').classList.remove('hidden');
            document.getElementById('send-btn').classList.add('hidden');
        }

        // Image Upload
        document.getElementById('attach-btn').addEventListener('click', () => {
            document.getElementById('image-input').click();
        });

        document.getElementById('image-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const chatId = [currentUser.id, currentChatUser.id].sort().join('_');
            const storageRef = storage.ref(`chats/${chatId}/${Date.now()}_${file.name}`);
            
            try {
                const snapshot = await storageRef.put(file);
                const url = await snapshot.ref.getDownloadURL();
                
                const messageData = {
                    senderId: currentUser.id,
                    image: url,
                    timestamp: Date.now(),
                    read: false
                };

                await database.ref(`chats/${chatId}/messages`).push().set(messageData);
                e.target.value = '';
            } catch (error) {
                console.error(error);
                alert('حدث خطأ أثناء رفع الصورة');
            }
        });

        // Voice Recording
        document.getElementById('voice-btn').addEventListener('click', startVoiceRecording);
        document.getElementById('voice-cancel-btn').addEventListener('click', cancelVoiceRecording);
        document.getElementById('voice-send-btn').addEventListener('click', sendVoiceMessage);

        async function startVoiceRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                voiceRecorder = new MediaRecorder(stream);
                audioChunks = [];
                voiceRecordingTime = 0;

                voiceRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };

                voiceRecorder.start();
                document.getElementById('voice-recording-overlay').classList.remove('hidden');
                
                voiceTimerInterval = setInterval(() => {
                    voiceRecordingTime++;
                    const minutes = Math.floor(voiceRecordingTime / 60).toString().padStart(2, '0');
                    const seconds = (voiceRecordingTime % 60).toString().padStart(2, '0');
                    document.getElementById('voice-timer').textContent = `${minutes}:${seconds}`;
                }, 1000);
            } catch (error) {
                console.error(error);
                alert('لا يمكن الوصول إلى الميكروفون\nتأكد من منح الإذن');
            }
        }

        function cancelVoiceRecording() {
            if (voiceRecorder && voiceRecorder.state !== 'inactive') {
                voiceRecorder.stop();
                voiceRecorder.stream.getTracks().forEach(track => track.stop());
            }
            clearInterval(voiceTimerInterval);
            audioChunks = [];
            voiceRecordingTime = 0;
            document.getElementById('voice-recording-overlay').classList.add('hidden');
            document.getElementById('voice-timer').textContent = '00:00';
        }

        async function sendVoiceMessage() {
            if (!voiceRecorder || voiceRecorder.state === 'inactive') return;

            voiceRecorder.stop();
            voiceRecorder.stream.getTracks().forEach(track => track.stop());
            clearInterval(voiceTimerInterval);

            voiceRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                const chatId = [currentUser.id, currentChatUser.id].sort().join('_');
                const storageRef = storage.ref(`voices/${chatId}/${Date.now()}.mp3`);

                try {
                    const snapshot = await storageRef.put(audioBlob);
                    const url = await snapshot.ref.getDownloadURL();
                    
                    const minutes = Math.floor(voiceRecordingTime / 60);
                    const seconds = voiceRecordingTime % 60;
                    const duration = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                    const messageData = {
                        senderId: currentUser.id,
                        voice: url,
                        duration,
                        timestamp: Date.now(),
                        read: false
                    };

                    await database.ref(`chats/${chatId}/messages`).push().set(messageData);
                    
                    audioChunks = [];
                    voiceRecordingTime = 0;
                    document.getElementById('voice-recording-overlay').classList.add('hidden');
                    document.getElementById('voice-timer').textContent = '00:00';
                } catch (error) {
                    console.error(error);
                    alert('حدث خطأ أثناء إرسال الرسالة الصوتية');
                }
            };
        }

        // Media Viewer
        document.getElementById('media-close-btn').addEventListener('click', () => {
            document.getElementById('media-viewer').classList.add('hidden');
        });

        document.getElementById('media-download-btn').addEventListener('click', () => {
            const url = document.getElementById('media-viewer-image').src;
            const a = document.createElement('a');
            a.href = url;
            a.download = 'image.jpg';
            a.click();
        });

        // Initialize
        generateFakeEmails();
        showScreen('fake-gmail');

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('✓ Service Worker'))
                .catch(err => console.error('✗ Service Worker:', err));
        }
    </script>
</body>
</html>
