<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#c71610">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gmail">
    <title>Gmail</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico">
    <link rel="apple-touch-icon" href="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; 
            background: #e5ddd5;
            overflow: hidden; 
            position: fixed; 
            width: 100%; 
            height: 100%; 
        }
        .hidden { display: none !important; }
        
        /* WhatsApp-like Chat Background */
        .chat-bg {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400"><defs><pattern id="whatsapp-pattern" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse"><circle cx="3" cy="3" r="1" fill="%23d9d9d9" opacity="0.3"/></pattern></defs><rect width="400" height="400" fill="%23e5ddd5"/><rect width="400" height="400" fill="url(%23whatsapp-pattern)"/></svg>');
            background-size: 400px 400px;
        }
        
        /* Gmail Fake */
        #fake-gmail { width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; }
        .gmail-header { height: 56px; background: #c71610; display: flex; align-items: center; padding: 0 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .gmail-logo { width: 40px; height: 40px; cursor: pointer; transition: transform 0.2s; }
        .gmail-logo:active { transform: scale(0.95); }
        .gmail-search { flex: 1; margin: 0 16px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; padding: 0 12px; color: #fff; }
        .gmail-search input { flex: 1; background: transparent; border: none; outline: none; color: #fff; font-size: 16px; }
        .gmail-search input::placeholder { color: rgba(255,255,255,0.7); }
        .gmail-content { flex: 1; overflow-y: auto; background: #f8f9fa; }
        .gmail-email { background: #fff; margin-bottom: 1px; padding: 16px; display: flex; cursor: pointer; transition: background 0.2s; }
        .gmail-email:hover { background: #f8f9fa; }
        .gmail-email.unread { background: #f0f4ff; }
        .gmail-email-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-left: 12px; }
        .gmail-email-content { flex: 1; }
        .gmail-email-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .gmail-email-sender { font-weight: 600; font-size: 14px; color: #202124; }
        .gmail-email-time { font-size: 12px; color: #5f6368; }
        .gmail-email-subject { font-size: 14px; color: #202124; margin-bottom: 4px; font-weight: 500; }
        .gmail-email-preview { font-size: 13px; color: #5f6368; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Email Modal */
        #email-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .email-modal-content { background: #fff; border-radius: 12px; max-width: 600px; width: 100%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .email-modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; }
        .email-modal-close { width: 36px; height: 36px; border-radius: 50%; background: transparent; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #5f6368; }
        .email-modal-body { padding: 20px; overflow-y: auto; }
        
        /* Code Screen */
        #code-screen { width: 100%; height: 100%; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .code-container { background: #fff; border-radius: 20px; padding: 40px 30px; max-width: 400px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .code-container .logo-icon { width: 80px; height: 80px; margin: 0 auto 20px; background: #25D366; border-radius: 20px; display: flex; align-items: center; justify-content: center; }
        .code-container .logo-icon i { font-size: 40px; color: #fff; }
        .code-container h2 { text-align: center; margin-bottom: 10px; color: #333; font-size: 24px; }
        .code-container p { text-align: center; color: #666; font-size: 14px; margin-bottom: 30px; }
        .code-input { width: 100%; padding: 14px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 18px; text-align: center; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 4px; }
        .code-input:focus { outline: none; border-color: #25D366; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #25D366; color: #fff; margin-bottom: 10px; }
        .btn-primary:hover { background: #20bd5a; transform: translateY(-2px); }
        .btn-secondary { background: #fff; color: #25D366; border: 2px solid #25D366; }
        .error-message { background: #ffebee; color: #c62828; padding: 12px; border-radius: 8px; margin: 10px 0; text-align: center; font-size: 13px; }
        
        /* Main Screen */
        #main-screen { width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; }
        .main-header { background: #075E54; color: #fff; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; }
        .main-header h2 { font-size: 20px; font-weight: 600; }
        .main-header-actions { display: flex; gap: 20px; }
        .header-btn { background: transparent; border: none; color: #fff; font-size: 20px; cursor: pointer; }
        .main-tabs { display: flex; background: #075E54; }
        .main-tab { flex: 1; padding: 14px; text-align: center; color: rgba(255,255,255,0.7); cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; }
        .main-tab.active { color: #fff; border-bottom-color: #fff; }
        .tab-content { display: none; flex: 1; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; }
        
        /* Contacts List */
        .contact-item { padding: 12px 16px; display: flex; align-items: center; gap: 12px; cursor: pointer; background: #fff; border-bottom: 1px solid #f0f0f0; }
        .contact-item:hover { background: #f5f5f5; }
        .contact-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .contact-info { flex: 1; min-width: 0; }
        .contact-name { font-weight: 600; font-size: 16px; color: #000; margin-bottom: 4px; }
        .contact-status { font-size: 13px; color: #667781; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .contact-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .contact-time { font-size: 12px; color: #667781; }
        .unread-badge { min-width: 20px; height: 20px; background: #25D366; color: #fff; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; padding: 0 6px; }
        
        /* Search & Add User */
        .search-container { padding: 12px 16px; background: #fff; border-bottom: 1px solid #e0e0e0; }
        .search-box { width: 100%; padding: 10px 16px; background: #f0f2f5; border: none; border-radius: 20px; font-size: 15px; }
        .search-box:focus { outline: none; background: #fff; box-shadow: 0 0 0 2px #25D366; }
        .add-user-btn { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: #25D366; color: #fff; border: none; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; z-index: 100; }
        
        /* Friend Request */
        .request-item { padding: 16px; background: #fff; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 12px; }
        .request-info { flex: 1; }
        .request-actions { display: flex; gap: 8px; }
        .btn-accept { padding: 8px 16px; background: #25D366; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
        .btn-reject { padding: 8px 16px; background: #f0f0f0; color: #666; border: none; border-radius: 8px; cursor: pointer; }
        
        /* Conversation */
        #conversation-screen { width: 100%; height: 100%; background: #e5ddd5; display: flex; flex-direction: column; }
        .conversation-header { background: #075E54; color: #fff; padding: 10px 16px; display: flex; align-items: center; gap: 12px; }
        .back-btn { background: transparent; border: none; color: #fff; font-size: 20px; cursor: pointer; }
        .conversation-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .conversation-info { flex: 1; }
        .conversation-name { font-size: 17px; font-weight: 600; }
        .conversation-status { font-size: 12px; opacity: 0.9; }
        .messages-container { flex: 1; overflow-y: auto; padding: 12px; }
        
        /* Messages */
        .message { display: flex; margin-bottom: 8px; }
        .message.sent { justify-content: flex-end; }
        .message-bubble { max-width: 75%; padding: 6px 10px; border-radius: 8px; position: relative; word-wrap: break-word; }
        .message.received .message-bubble { background: #fff; border-radius: 0 8px 8px 8px; }
        .message.sent .message-bubble { background: #dcf8c6; border-radius: 8px 0 8px 8px; }
        .message-text { font-size: 14px; line-height: 1.4; color: #000; margin-bottom: 4px; }
        .message-image { max-width: 280px; border-radius: 8px; cursor: pointer; }
        .message-image img { width: 100%; border-radius: 8px; }
        .message-meta { display: flex; align-items: center; justify-content: flex-end; gap: 4px; font-size: 11px; color: #667781; }
        .message-status { display: flex; align-items: center; }
        .message-status i { font-size: 14px; }
        .status-read { color: #53bdeb; }
        .status-delivered { color: #8696a0; }
        
        /* Image Preview Modal */
        #image-preview-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; }
        .preview-header { background: #075E54; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; }
        .preview-close { background: transparent; border: none; color: #fff; font-size: 24px; cursor: pointer; }
        .preview-content { flex: 1; overflow-y: auto; padding: 20px; }
        .preview-images-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-bottom: 20px; }
        .preview-image-item { position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden; }
        .preview-image-item img { width: 100%; height: 100%; object-fit: cover; }
        .remove-image-btn { position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 50%; cursor: pointer; }
        .preview-footer { background: #075E54; padding: 12px 16px; }
        .preview-send-btn { width: 100%; padding: 12px; background: #25D366; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
        
        /* Input Area */
        .input-area { background: #f0f2f5; padding: 8px 12px; display: flex; align-items: flex-end; gap: 8px; }
        .input-btn { width: 36px; height: 36px; background: transparent; border: none; color: #54656f; font-size: 24px; cursor: pointer; border-radius: 50%; }
        .input-btn:hover { background: #e9edef; }
        .message-input-wrapper { flex: 1; background: #fff; border-radius: 20px; padding: 8px 12px; max-height: 120px; overflow-y: auto; }
        .message-input { width: 100%; border: none; outline: none; font-size: 15px; resize: none; font-family: inherit; }
        .send-btn { width: 44px; height: 44px; background: #25D366; color: #fff; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; }
        .voice-record-btn { width: 44px; height: 44px; background: #25D366; color: #fff; border: none; border-radius: 50%; font-size: 20px; cursor: pointer; }
        
        /* Voice Recording */
        #voice-recording { background: #f0f2f5; padding: 12px; display: flex; align-items: center; gap: 12px; }
        .recording-indicator { width: 12px; height: 12px; background: #f44336; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .recording-duration { flex: 1; font-size: 16px; font-weight: 600; color: #000; }
        .recording-actions { display: flex; gap: 8px; }
        .cancel-btn { padding: 8px 16px; background: #f44336; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
        .send-voice-btn { padding: 8px 16px; background: #25D366; color: #fff; border: none; border-radius: 8px; cursor: pointer; }
        
        /* Profile Modal */
        #profile-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 1000; display: flex; flex-direction: column; }
        .profile-header { background: #075E54; color: #fff; padding: 12px 16px; display: flex; align-items: center; gap: 12px; }
        .profile-content { flex: 1; overflow-y: auto; }
        .profile-cover { height: 200px; background: linear-gradient(135deg, #075E54, #128C7E); display: flex; align-items: center; justify-content: center; }
        .profile-avatar-large { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; }
        .profile-info { padding: 20px; text-align: center; }
        .profile-name { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .profile-bio { color: #667781; font-size: 14px; margin-bottom: 20px; }
        .profile-actions { display: flex; gap: 12px; justify-content: center; }
        .profile-btn { padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; }
        .profile-btn-primary { background: #25D366; color: #fff; }
        .profile-btn-secondary { background: #f0f2f5; color: #000; }
        
        /* QR Scanner */
        #qr-scanner { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; }
        .scanner-header { background: rgba(0,0,0,0.9); padding: 16px; display: flex; align-items: center; justify-content: space-between; }
        .scanner-close { background: transparent; border: none; color: #fff; font-size: 24px; cursor: pointer; }
        .scanner-content { flex: 1; position: relative; }
        #scanner-video { width: 100%; height: 100%; object-fit: cover; }
        .scanner-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 250px; border: 3px solid #25D366; border-radius: 16px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.6); }
        
        /* Admin */
        #admin-screen { width: 100%; height: 100%; background: #f5f7fa; display: flex; flex-direction: column; }
        .admin-header { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 20px; }
        .admin-tabs { display: flex; background: #fff; border-bottom: 2px solid #e0e0e0; }
        .admin-tab { flex: 1; padding: 14px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #666; }
        .admin-tab.active { color: #667eea; border-bottom-color: #667eea; }
        .admin-content { flex: 1; overflow-y: auto; padding: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; }
        .form-control:focus { outline: none; border-color: #667eea; }
        
        /* Utilities */
        .text-center { text-align: center; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    </style>
</head>
<body>
    <!-- Fake Gmail -->
    <div id="fake-gmail">
        <div class="gmail-header">
            <img src="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/logo_gmail_lockup_default_1x_r5.png" class="gmail-logo" id="gmailLogo">
            <div class="gmail-search">
                <i class="fas fa-search" style="margin-left: 8px;"></i>
                <input type="text" placeholder="بحث في البريد" id="gmailSearchInput">
            </div>
            <button class="header-btn"><i class="fas fa-ellipsis-v"></i></button>
        </div>
        <div class="gmail-content" id="gmailEmails"></div>
    </div>

    <!-- Email Modal -->
    <div id="email-modal" class="hidden">
        <div class="email-modal-content">
            <div class="email-modal-header">
                <h3 id="emailModalSubject"></h3>
                <button class="email-modal-close" onclick="closeEmailModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="email-modal-body">
                <div style="margin-bottom: 15px;">
                    <strong id="emailModalFrom"></strong><br>
                    <span style="color: #666; font-size: 14px;" id="emailModalTime"></span>
                </div>
                <div id="emailModalText"></div>
            </div>
        </div>
    </div>

    <!-- Code Screen -->
    <div id="code-screen" class="hidden">
        <div class="code-container">
            <div class="logo-icon"><i class="fas fa-comments"></i></div>
            <h2>مرحباً بك</h2>
            <p>أدخل الكود السري للدخول</p>
            <input type="text" class="code-input" id="codeInput" placeholder="XXXXX" maxlength="5">
            <button class="btn btn-primary" onclick="verifyCode()">
                <i class="fas fa-sign-in-alt"></i> دخول
            </button>
            <button class="btn btn-secondary" onclick="showQRScanner()">
                <i class="fas fa-qrcode"></i> مسح QR Code
            </button>
            <div id="codeError" class="error-message hidden"></div>
        </div>
    </div>

    <!-- Main Screen -->
    <div id="main-screen" class="hidden">
        <div class="main-header">
            <h2 id="appTitle">المحادثات</h2>
            <div class="main-header-actions">
                <button class="header-btn" onclick="showSearchUsers()"><i class="fas fa-search"></i></button>
                <button class="header-btn" onclick="showProfile(currentUser.id)"><i class="fas fa-user-circle"></i></button>
                <button class="header-btn" onclick="showMainMenu()"><i class="fas fa-ellipsis-v"></i></button>
            </div>
        </div>
        <div class="main-tabs">
            <div class="main-tab active" onclick="switchTab('chats')">المحادثات</div>
            <div class="main-tab" onclick="switchTab('requests')">
                الطلبات <span id="requestsBadge"></span>
            </div>
        </div>
        
        <!-- Chats Tab -->
        <div id="chatsTab" class="tab-content active">
            <div class="search-container">
                <input type="text" class="search-box" placeholder="بحث في المحادثات..." id="chatsSearch">
            </div>
            <div id="chatsList"></div>
        </div>
        
        <!-- Requests Tab -->
        <div id="requestsTab" class="tab-content">
            <div id="requestsList"></div>
        </div>
        
        <!-- Add User Button -->
        <button class="add-user-btn" onclick="showSearchUsers()"><i class="fas fa-user-plus"></i></button>
    </div>

    <!-- Conversation Screen -->
    <div id="conversation-screen" class="hidden chat-bg">
        <div class="conversation-header">
            <button class="back-btn" onclick="backToMain()"><i class="fas fa-arrow-right"></i></button>
            <img id="conversationAvatar" class="conversation-avatar" src="">
            <div class="conversation-info">
                <div class="conversation-name" id="conversationName"></div>
                <div class="conversation-status" id="conversationStatus">متصل الآن</div>
            </div>
            <button class="header-btn" onclick="showConversationMenu()"><i class="fas fa-ellipsis-v"></i></button>
        </div>
        <div class="messages-container" id="messagesContainer"></div>
        <div class="input-area" id="normalInput">
            <button class="input-btn" onclick="selectImages()"><i class="fas fa-image"></i></button>
            <button class="input-btn" onclick="selectCamera()"><i class="fas fa-camera"></i></button>
            <div class="message-input-wrapper">
                <textarea class="message-input" id="messageInput" placeholder="اكتب رسالة..." rows="1"></textarea>
            </div>
            <button class="send-btn hidden" id="sendBtn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            <button class="voice-record-btn" id="voiceBtn" onclick="startVoiceRecording()"><i class="fas fa-microphone"></i></button>
        </div>
        
        <!-- Voice Recording -->
        <div id="voice-recording" class="hidden">
            <div class="recording-indicator"></div>
            <div class="recording-duration" id="recordingDuration">0:00</div>
            <div class="recording-actions">
                <button class="cancel-btn" onclick="cancelVoiceRecording()">إلغاء</button>
                <button class="send-voice-btn" onclick="sendVoiceMessage()"><i class="fas fa-paper-plane"></i> إرسال</button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="hidden">
        <div class="preview-header">
            <h3 style="color: #fff; font-size: 18px;">إرسال الصور</h3>
            <button class="preview-close" onclick="closeImagePreview()"><i class="fas fa-times"></i></button>
        </div>
        <div class="preview-content">
            <div class="preview-images-grid" id="previewGrid"></div>
            <div style="margin-bottom: 20px;">
                <input type="text" class="search-box" placeholder="إضافة تعليق..." id="imageCaption">
            </div>
        </div>
        <div class="preview-footer">
            <button class="preview-send-btn" onclick="sendImages()">
                <i class="fas fa-paper-plane"></i> إرسال (<span id="imageCount">0</span>)
            </button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="hidden">
        <div class="profile-header">
            <button class="back-btn" onclick="closeProfile()"><i class="fas fa-arrow-right"></i></button>
            <h3>الملف الشخصي</h3>
        </div>
        <div class="profile-content">
            <div class="profile-cover">
                <img id="profileAvatar" class="profile-avatar-large" src="">
            </div>
            <div class="profile-info">
                <div class="profile-name" id="profileName"></div>
                <div class="profile-bio" id="profileBio">مرحباً! أنا أستخدم هذا التطبيق</div>
                <div class="profile-actions" id="profileActions"></div>
            </div>
        </div>
    </div>

    <!-- Search Users Modal -->
    <div id="search-users-modal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #fff; z-index: 1000; display: flex; flex-direction: column;">
        <div class="profile-header">
            <button class="back-btn" onclick="closeSearchUsers()"><i class="fas fa-arrow-right"></i></button>
            <h3>البحث عن مستخدمين</h3>
        </div>
        <div style="padding: 16px;">
            <input type="text" class="search-box" placeholder="أدخل كود المستخدم..." id="userCodeSearch">
            <button class="btn btn-primary" style="margin-top: 12px;" onclick="searchUserByCode()">
                <i class="fas fa-search"></i> بحث
            </button>
            <div style="text-align: center; margin: 20px 0;">
                <p style="color: #667781; margin-bottom: 10px;">أو</p>
                <button class="btn btn-secondary" onclick="scanQRForUser()">
                    <i class="fas fa-qrcode"></i> مسح QR Code
                </button>
            </div>
        </div>
        <div id="searchResults" style="flex: 1; overflow-y: auto;"></div>
    </div>

    <!-- QR Scanner -->
    <div id="qr-scanner" class="hidden">
        <div class="scanner-header">
            <h3 style="color: #fff; font-size: 18px;">مسح QR Code</h3>
            <button class="scanner-close" onclick="closeQRScanner()"><i class="fas fa-times"></i></button>
        </div>
        <div class="scanner-content">
            <video id="scanner-video" autoplay playsinline></video>
            <div class="scanner-overlay"></div>
        </div>
    </div>

    <!-- Admin Screen -->
    <div id="admin-screen" class="hidden">
        <div class="admin-header">
            <h2><i class="fas fa-shield-alt"></i> لوحة التحكم</h2>
        </div>
        <div class="admin-tabs">
            <div class="admin-tab active" onclick="switchAdminTab('create')">إنشاء</div>
            <div class="admin-tab" onclick="switchAdminTab('users')">المستخدمين</div>
            <div class="admin-tab" onclick="switchAdminTab('settings')">الإعدادات</div>
        </div>
        <div class="admin-content">
            <div id="createPanel" class="admin-panel" style="display: block;">
                <form onsubmit="createUser(event)">
                    <div class="form-group">
                        <label>اسم المستخدم</label>
                        <input type="text" class="form-control" id="userName" required>
                    </div>
                    <div class="form-group">
                        <label>صورة المستخدم</label>
                        <input type="file" class="form-control" id="userAvatarFile" accept="image/*" onchange="previewAvatar(event)">
                        <img id="avatarPreview" style="width: 100px; height: 100px; border-radius: 50%; margin-top: 10px; display: none;">
                    </div>
                    <button type="submit" class="btn btn-primary">إنشاء مستخدم</button>
                </form>
                <div id="createMessage" style="margin-top: 20px;"></div>
                <div id="qrCodeDisplay" style="margin-top: 20px; text-align: center; display: none;">
                    <canvas id="qrCanvas"></canvas>
                    <p id="generatedCode" style="font-size: 18px; font-weight: bold; margin-top: 10px;"></p>
                </div>
            </div>
            <div id="usersPanel" class="admin-panel" style="display: none;">
                <div id="usersList"></div>
            </div>
            <div id="settingsPanel" class="admin-panel" style="display: none;">
                <button class="btn btn-secondary" onclick="logout()">تسجيل الخروج</button>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" onchange="handleImageSelect(event)">
    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handleImageSelect(event)">

    <!-- Firebase & Libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // Global Variables
        const ADMIN_CODE = 'ADMIN';
        const CLICK_THRESHOLD = 5;
        const CLICK_TIMEOUT = 3000;
        
        let clickCount = 0;
        let clickTimer = null;
        let currentUser = null;
        let currentChatId = null;
        let currentChatUser = null;
        let selectedImages = [];
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let recordingInterval = null;
        let qrScanMode = null;
        let selectedAvatarFile = null;

        // Initialize App
        initApp();

        function initApp() {
            showFakeGmail();
            generateFakeEmails();
            setupGmailLogoClick();
            setupGmailSearch();
            updateEmailTimes();
            setInterval(updateEmailTimes, 60000);
            setupMessageInput();
        }

        // ===== Gmail Functions =====
        function showFakeGmail() {
            document.getElementById('fake-gmail').classList.remove('hidden');
            hideAllScreens();
        }

        function hideAllScreens() {
            ['code-screen', 'main-screen', 'conversation-screen', 'admin-screen', 
             'email-modal', 'profile-modal', 'search-users-modal', 'qr-scanner',
             'image-preview-modal'].forEach(id => {
                document.getElementById(id)?.classList.add('hidden');
            });
        }

        function generateFakeEmails() {
            const emails = [
                { sender: 'Google Security', avatar: 'G', subject: 'تنبيه أمني لحسابك', preview: 'لقد لاحظنا نشاطاً غير عادي...', time: Date.now() - 2*3600000, unread: true, body: 'عزيزي المستخدم،\n\nلقد لاحظنا محاولة تسجيل دخول من موقع غير معروف. إذا لم تكن أنت، يرجى تأمين حسابك.\n\nالموقع: العراق\nالوقت: منذ ساعتين\n\nفريق أمان Google' },
                { sender: 'Facebook', avatar: 'F', subject: 'لديك 5 إشعارات جديدة', preview: 'أحمد وعلي أعجبوا بمنشورك', time: Date.now() - 5*3600000, unread: true, body: 'لديك نشاط جديد:\n• أحمد أعجب بمنشورك\n• علي علّق على صورتك\n• سارة شاركت منشورك\n\nفريق Facebook' },
                { sender: 'Amazon', avatar: 'A', subject: 'طلبك في الطريق', preview: 'سيصل اليوم بين 2-4 مساءً', time: Date.now() - 86400000, unread: false, body: 'طلبك #12345 خرج للتوصيل!\n\nالمنتج: هاتف Samsung\nموعد التسليم: اليوم\n\nAmazon' },
                { sender: 'WhatsApp', avatar: 'W', subject: 'رسالة جديدة', preview: 'أحمد: متى نلتقي؟', time: Date.now() - 2*86400000, unread: false, body: 'لديك رسالة جديدة:\n\nأحمد: متى نلتقي؟\n\nWhatsApp' }
            ];
            
            document.getElementById('gmailEmails').innerHTML = emails.map((e, i) => `
                <div class="gmail-email ${e.unread ? 'unread' : ''}" onclick="showEmailModal(${i})">
                    <div class="gmail-email-avatar">${e.avatar}</div>
                    <div class="gmail-email-content">
                        <div class="gmail-email-header">
                            <span class="gmail-email-sender">${e.sender}</span>
                            <span class="gmail-email-time" data-timestamp="${e.time}">${formatEmailTime(e.time)}</span>
                        </div>
                        <div class="gmail-email-subject">${e.subject}</div>
                        <div class="gmail-email-preview">${e.preview}</div>
                    </div>
                </div>
            `).join('');
            
            window.emailsData = emails;
        }

        function showEmailModal(index) {
            const email = window.emailsData[index];
            document.getElementById('emailModalSubject').textContent = email.subject;
            document.getElementById('emailModalFrom').textContent = email.sender;
            document.getElementById('emailModalTime').textContent = formatEmailTime(email.time);
            document.getElementById('emailModalText').textContent = email.body;
            document.getElementById('email-modal').classList.remove('hidden');
        }

        function closeEmailModal() {
            document.getElementById('email-modal').classList.add('hidden');
        }

        function setupGmailSearch() {
            document.getElementById('gmailSearchInput').addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (!query) { generateFakeEmails(); return; }
                const filtered = window.emailsData.filter(email => 
                    email.sender.toLowerCase().includes(query) ||
                    email.subject.toLowerCase().includes(query) ||
                    email.preview.toLowerCase().includes(query)
                );
                document.getElementById('gmailEmails').innerHTML = filtered.length > 0 
                    ? filtered.map((e, i) => `
                        <div class="gmail-email" onclick="showEmailModal(${window.emailsData.indexOf(e)})">
                            <div class="gmail-email-avatar">${e.avatar}</div>
                            <div class="gmail-email-content">
                                <div class="gmail-email-header">
                                    <span class="gmail-email-sender">${e.sender}</span>
                                    <span class="gmail-email-time">${formatEmailTime(e.time)}</span>
                                </div>
                                <div class="gmail-email-subject">${e.subject}</div>
                                <div class="gmail-email-preview">${e.preview}</div>
                            </div>
                        </div>
                    `).join('')
                    : '<p style="text-align: center; padding: 50px; color: #666;">لا توجد نتائج</p>';
            });
        }

        function formatEmailTime(ts) {
            const diff = Date.now() - ts;
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            if (hours < 1) return `منذ ${Math.floor(diff / 60000)} د`;
            if (hours < 24) return `منذ ${hours} س`;
            if (days === 1) return 'أمس';
            if (days < 7) return `منذ ${days} أيام`;
            return `منذ ${Math.floor(days / 7)} أسابيع`;
        }

        function updateEmailTimes() {
            document.querySelectorAll('.gmail-email-time[data-timestamp]').forEach(el => {
                el.textContent = formatEmailTime(parseInt(el.getAttribute('data-timestamp')));
            });
        }

        function setupGmailLogoClick() {
            document.getElementById('gmailLogo').addEventListener('click', () => {
                clickCount++;
                if (clickTimer) clearTimeout(clickTimer);
                if (clickCount >= CLICK_THRESHOLD) {
                    showCodeScreen();
                    clickCount = 0;
                } else {
                    clickTimer = setTimeout(() => clickCount = 0, CLICK_TIMEOUT);
                }
            });
        }

        // ===== Code Screen =====
        function showCodeScreen() {
            document.getElementById('fake-gmail').classList.add('hidden');
            document.getElementById('code-screen').classList.remove('hidden');
            document.getElementById('codeInput').value = '';
            document.getElementById('codeError').classList.add('hidden');
        }

        function verifyCode() {
            const code = document.getElementById('codeInput').value.trim().toUpperCase();
            const errorDiv = document.getElementById('codeError');
            
            if (!code) {
                errorDiv.textContent = 'الرجاء إدخال الكود';
                errorDiv.classList.remove('hidden');
                return;
            }
            
            if (code === ADMIN_CODE) {
                currentUser = { 
                    isAdmin: true, 
                    code: ADMIN_CODE, 
                    name: 'المدير', 
                    avatar: 'https://ui-avatars.com/api/?name=Admin&background=25D366&color=fff',
                    id: 'admin_' + Date.now()
                };
                showAdminScreen();
            } else {
                database.ref('users').orderByChild('code').equalTo(code).once('value')
                    .then(snapshot => {
                        if (snapshot.exists()) {
                            const userId = Object.keys(snapshot.val())[0];
                            const userData = snapshot.val()[userId];
                            if (userData.blocked) {
                                errorDiv.textContent = 'هذا الحساب محظور';
                                errorDiv.classList.remove('hidden');
                                return;
                            }
                            currentUser = { ...userData, id: userId };
                            showMainScreen();
                        } else {
                            errorDiv.textContent = 'الكود غير صحيح';
                            errorDiv.classList.remove('hidden');
                        }
                    });
            }
        }

        // ===== QR Scanner =====
        function showQRScanner() {
            qrScanMode = 'login';
            startQRScanner();
        }

        function scanQRForUser() {
            qrScanMode = 'search';
            closeSearchUsers();
            startQRScanner();
        }

        function startQRScanner() {
            document.getElementById('qr-scanner').classList.remove('hidden');
            const video = document.getElementById('scanner-video');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                    requestAnimationFrame(scanQRCode);
                })
                .catch(() => alert('لا يمكن الوصول إلى الكاميرا'));
        }

        function scanQRCode() {
            const video = document.getElementById('scanner-video');
            const canvas = document.createElement('canvas');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                if (typeof jsQR !== 'undefined') {
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) {
                        handleQRCode(code.data);
                        return;
                    }
                }
            }
            
            if (!document.getElementById('qr-scanner').classList.contains('hidden')) {
                requestAnimationFrame(scanQRCode);
            }
        }

        function handleQRCode(code) {
            closeQRScanner();
            
            if (qrScanMode === 'login') {
                document.getElementById('codeInput').value = code;
                verifyCode();
            } else if (qrScanMode === 'search') {
                document.getElementById('userCodeSearch').value = code;
                searchUserByCode();
            }
        }

        function closeQRScanner() {
            const video = document.getElementById('scanner-video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            document.getElementById('qr-scanner').classList.add('hidden');
        }

        // ===== Main Screen =====
        function showMainScreen() {
            hideAllScreens();
            document.getElementById('main-screen').classList.remove('hidden');
            loadChats();
            loadFriendRequests();
        }

        function switchTab(tab) {
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            if (tab === 'chats') {
                document.getElementById('appTitle').textContent = 'المحادثات';
                loadChats();
            } else if (tab === 'requests') {
                document.getElementById('appTitle').textContent = 'طلبات الصداقة';
                loadFriendRequests();
            }
        }

        function loadChats() {
            if (!currentUser.friends || currentUser.friends.length === 0) {
                document.getElementById('chatsList').innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #667781;">
                        <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>لا توجد محادثات بعد</p>
                        <p style="font-size: 14px; margin-top: 8px;">ابحث عن أصدقاء وابدأ المحادثة!</p>
                    </div>
                `;
                return;
            }

            const friendsData = [];
            let loaded = 0;

            currentUser.friends.forEach(friendId => {
                database.ref('users/' + friendId).once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        const friend = { id: friendId, ...snapshot.val() };
                        const chatId = getChatId(currentUser.id, friendId);
                        
                        database.ref('chats/' + chatId + '/messages').limitToLast(1).once('value')
                            .then(msgSnapshot => {
                                let lastMsg = null;
                                let unread = 0;
                                
                                if (msgSnapshot.exists()) {
                                    lastMsg = Object.values(msgSnapshot.val())[0];
                                    
                                    return database.ref('chats/' + chatId + '/messages')
                                        .orderByChild('read').equalTo(false).once('value')
                                        .then(unreadSnap => {
                                            if (unreadSnap.exists()) {
                                                Object.values(unreadSnap.val()).forEach(msg => {
                                                    if (msg.sender !== currentUser.id) unread++;
                                                });
                                            }
                                            return { friend, lastMsg, unread };
                                        });
                                }
                                return { friend, lastMsg, unread };
                            })
                            .then(data => {
                                friendsData.push(data);
                                loaded++;
                                
                                if (loaded === currentUser.friends.length) {
                                    renderChats(friendsData);
                                }
                            });
                    } else {
                        loaded++;
                        if (loaded === currentUser.friends.length) {
                            renderChats(friendsData);
                        }
                    }
                });
            });
        }

        function renderChats(chatsData) {
            chatsData.sort((a, b) => {
                if (!a.lastMsg) return 1;
                if (!b.lastMsg) return -1;
                return b.lastMsg.timestamp - a.lastMsg.timestamp;
            });
            
            document.getElementById('chatsList').innerHTML = chatsData.map(chat => {
                const preview = chat.lastMsg 
                    ? (chat.lastMsg.text || '<i class="fas fa-image"></i> صورة')
                    : 'ابدأ المحادثة';
                const time = chat.lastMsg ? formatTime(chat.lastMsg.timestamp) : '';
                
                return `
                    <div class="contact-item" onclick='openChat("${chat.friend.id}", ${JSON.stringify(chat.friend).replace(/'/g, "\\'")} )'>
                        <img src="${chat.friend.avatar}" class="contact-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(chat.friend.name)}'">
                        <div class="contact-info">
                            <div class="contact-name">${chat.friend.name}</div>
                            <div class="contact-status">${preview}</div>
                        </div>
                        <div class="contact-meta">
                            ${time ? `<div class="contact-time">${time}</div>` : ''}
                            ${chat.unread > 0 ? `<div class="unread-badge">${chat.unread}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadFriendRequests() {
            database.ref('friendRequests').orderByChild('to').equalTo(currentUser.id).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        document.getElementById('requestsList').innerHTML = `
                            <div style="text-align: center; padding: 50px; color: #667781;">
                                <i class="fas fa-user-friends" style="font-size: 48px; margin-bottom: 16px;"></i>
                                <p>لا توجد طلبات صداقة</p>
                            </div>
                        `;
                        document.getElementById('requestsBadge').textContent = '';
                        return;
                    }
                    
                    const requests = [];
                    snapshot.forEach(child => {
                        const req = { id: child.key, ...child.val() };
                        if (req.status === 'pending') requests.push(req);
                    });
                    
                    document.getElementById('requestsBadge').textContent = requests.length > 0 ? ` (${requests.length})` : '';
                    
                    if (requests.length === 0) {
                        document.getElementById('requestsList').innerHTML = `
                            <div style="text-align: center; padding: 50px; color: #667781;">
                                <p>لا توجد طلبات جديدة</p>
                            </div>
                        `;
                        return;
                    }
                    
                    Promise.all(requests.map(req => 
                        database.ref('users/' + req.from).once('value')
                            .then(userSnap => ({ ...req, fromUser: userSnap.val() }))
                    )).then(requestsWithUsers => {
                        document.getElementById('requestsList').innerHTML = requestsWithUsers.map(req => `
                            <div class="request-item">
                                <img src="${req.fromUser.avatar}" class="contact-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(req.fromUser.name)}'">
                                <div class="request-info">
                                    <div class="contact-name">${req.fromUser.name}</div>
                                    <div class="contact-status">يريد إضافتك كصديق</div>
                                </div>
                                <div class="request-actions">
                                    <button class="btn-accept" onclick="acceptFriendRequest('${req.id}', '${req.from}')">قبول</button>
                                    <button class="btn-reject" onclick="rejectFriendRequest('${req.id}')">رفض</button>
                                </div>
                            </div>
                        `).join('');
                    });
                });
        }

        function acceptFriendRequest(requestId, fromId) {
            database.ref('friendRequests/' + requestId).update({ status: 'accepted' })
                .then(() => {
                    const updates = {};
                    updates['users/' + currentUser.id + '/friends/' + fromId] = true;
                    updates['users/' + fromId + '/friends/' + currentUser.id] = true;
                    return database.ref().update(updates);
                })
                .then(() => {
                    if (!currentUser.friends) currentUser.friends = [];
                    if (!currentUser.friends.includes(fromId)) currentUser.friends.push(fromId);
                    loadFriendRequests();
                    loadChats();
                });
        }

        function rejectFriendRequest(requestId) {
            database.ref('friendRequests/' + requestId).update({ status: 'rejected' })
                .then(() => loadFriendRequests());
        }

        function getChatId(id1, id2) {
            return [id1, id2].sort().join('_');
        }

        function formatTime(ts) {
            const diff = Date.now() - ts;
            if (diff < 60000) return 'الآن';
            if (diff < 3600000) return `${Math.floor(diff / 60000)} د`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)} س`;
            if (diff < 172800000) return 'أمس';
            const date = new Date(ts);
            return date.toLocaleDateString('ar', { month: 'short', day: 'numeric' });
        }

        // ===== Search Users =====
        function showSearchUsers() {
            document.getElementById('search-users-modal').classList.remove('hidden');
            document.getElementById('userCodeSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
        }

        function closeSearchUsers() {
            document.getElementById('search-users-modal').classList.add('hidden');
        }

        function searchUserByCode() {
            const code = document.getElementById('userCodeSearch').value.trim().toUpperCase();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!code) {
                resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #667781;">أدخل كود المستخدم</p>';
                return;
            }
            
            resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> جاري البحث...</p>';
            
            database.ref('users').orderByChild('code').equalTo(code).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #667781;">لم يتم العثور على مستخدم بهذا الكود</p>';
                        return;
                    }
                    
                    const userId = Object.keys(snapshot.val())[0];
                    if (userId === currentUser.id) {
                        resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px; color: #667781;">هذا أنت!</p>';
                        return;
                    }
                    
                    const user = { id: userId, ...snapshot.val()[userId] };
                    const isFriend = currentUser.friends && currentUser.friends.includes(userId);
                    
                    database.ref('friendRequests')
                        .orderByChild('from').equalTo(currentUser.id)
                        .once('value')
                        .then(reqSnapshot => {
                            let hasPending = false;
                            if (reqSnapshot.exists()) {
                                reqSnapshot.forEach(child => {
                                    const req = child.val();
                                    if (req.to === userId && req.status === 'pending') {
                                        hasPending = true;
                                    }
                                });
                            }
                            
                            resultsDiv.innerHTML = `
                                <div class="contact-item">
                                    <img src="${user.avatar}" class="contact-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}'">
                                    <div class="contact-info">
                                        <div class="contact-name">${user.name}</div>
                                        <div class="contact-status">${user.code}</div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        ${isFriend 
                                            ? '<button class="btn-accept" onclick="closeSearchUsers(); showProfile(\'' + userId + '\')">عرض</button>'
                                            : hasPending
                                            ? '<button class="btn-reject" disabled>طلب معلق</button>'
                                            : '<button class="btn-accept" onclick="sendFriendRequest(\'' + userId + '\')">إضافة</button>'
                                        }
                                    </div>
                                </div>
                            `;
                        });
                });
        }

        function sendFriendRequest(toUserId) {
            database.ref('friendRequests').push({
                from: currentUser.id,
                to: toUserId,
                status: 'pending',
                timestamp: Date.now()
            }).then(() => {
                alert('تم إرسال طلب الصداقة!');
                searchUserByCode();
            });
        }

        // ===== Profile =====
        function showProfile(userId) {
            database.ref('users/' + userId).once('value').then(snapshot => {
                if (!snapshot.exists()) return;
                
                const user = { id: userId, ...snapshot.val() };
                document.getElementById('profile-modal').classList.remove('hidden');
                document.getElementById('profileAvatar').src = user.avatar;
                document.getElementById('profileName').textContent = user.name;
                document.getElementById('profileBio').textContent = user.bio || 'مرحباً! أنا أستخدم هذا التطبيق';
                
                const isSelf = userId === currentUser.id;
                const isFriend = currentUser.friends && currentUser.friends.includes(userId);
                
                const actionsDiv = document.getElementById('profileActions');
                if (isSelf) {
                    actionsDiv.innerHTML = '<button class="profile-btn profile-btn-secondary" onclick="showSettings()"><i class="fas fa-cog"></i> الإعدادات</button>';
                } else if (isFriend) {
                    actionsDiv.innerHTML = `
                        <button class="profile-btn profile-btn-primary" onclick="closeProfile(); openChat('${userId}', ${JSON.stringify(user).replace(/'/g, "\\'")})">
                            <i class="fas fa-comment"></i> محادثة
                        </button>
                    `;
                } else {
                    actionsDiv.innerHTML = `
                        <button class="profile-btn profile-btn-primary" onclick="sendFriendRequest('${userId}')">
                            <i class="fas fa-user-plus"></i> إضافة صديق
                        </button>
                    `;
                }
            });
        }

        function closeProfile() {
            document.getElementById('profile-modal').classList.add('hidden');
        }

        // ===== Conversation =====
        function openChat(friendId, friendData) {
            currentChatUser = { id: friendId, ...friendData };
            currentChatId = getChatId(currentUser.id, friendId);
            
            document.getElementById('main-screen').classList.add('hidden');
            document.getElementById('conversation-screen').classList.remove('hidden');
            
            document.getElementById('conversationName').textContent = friendData.name;
            document.getElementById('conversationAvatar').src = friendData.avatar;
            
            loadMessages();
        }

        function backToMain() {
            if (currentChatId) {
                database.ref('chats/' + currentChatId + '/messages').off();
            }
            document.getElementById('conversation-screen').classList.add('hidden');
            showMainScreen();
        }

        function loadMessages() {
            const container = document.getElementById('messagesContainer');
            
            database.ref('chats/' + currentChatId + '/messages').on('value', snapshot => {
                container.innerHTML = '';
                
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="text-align: center; padding: 50px; color: #667781;"><i class="fas fa-comments"></i><br><br>لا توجد رسائل<br>ابدأ المحادثة!</p>';
                    return;
                }
                
                snapshot.forEach(child => {
                    renderMessage(child.val(), child.key);
                });
                
                container.scrollTop = container.scrollHeight;
                updateReadStatus();
            });
        }

        function renderMessage(msg, msgId) {
            const container = document.getElementById('messagesContainer');
            const isSent = msg.sender === currentUser.id;
            const div = document.createElement('div');
            div.className = `message ${isSent ? 'sent' : 'received'}`;
            
            if (msg.deleted) {
                div.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-text" style="font-style: italic; color: #8696a0;">
                            <i class="fas fa-ban"></i> تم حذف هذه الرسالة
                        </div>
                        <div class="message-meta">${formatTime(msg.timestamp)}</div>
                    </div>
                `;
            } else if (msg.image) {
                div.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-image" onclick="showImageViewer('${msg.image}')">
                            <img src="${msg.image}">
                        </div>
                        ${msg.text ? `<div class="message-text">${escapeHtml(msg.text)}</div>` : ''}
                        <div class="message-meta">
                            <span>${formatTime(msg.timestamp)}</span>
                            ${isSent ? getStatusIcon(msg) : ''}
                        </div>
                    </div>
                `;
            } else if (msg.audio) {
                div.innerHTML = `
                    <div class="message-bubble">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <button onclick="playAudio('${msg.audio}')" style="background: transparent; border: none; cursor: pointer; font-size: 20px;">
                                <i class="fas fa-play-circle"></i>
                            </button>
                            <div style="flex: 1; color: #8696a0;">${msg.duration || '0:00'}</div>
                        </div>
                        <div class="message-meta">
                            <span>${formatTime(msg.timestamp)}</span>
                            ${isSent ? getStatusIcon(msg) : ''}
                        </div>
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-text">${escapeHtml(msg.text)}</div>
                        <div class="message-meta">
                            <span>${formatTime(msg.timestamp)}</span>
                            ${isSent ? getStatusIcon(msg) : ''}
                        </div>
                    </div>
                `;
            }
            
            container.appendChild(div);
        }

        function getStatusIcon(msg) {
            if (msg.read) return '<div class="message-status status-read"><i class="fas fa-check-double"></i></div>';
            if (msg.delivered) return '<div class="message-status status-delivered"><i class="fas fa-check-double"></i></div>';
            return '<div class="message-status"><i class="fas fa-check"></i></div>';
        }

        function updateReadStatus() {
            database.ref('chats/' + currentChatId + '/messages')
                .orderByChild('read').equalTo(false).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        const updates = {};
                        snapshot.forEach(child => {
                            if (child.val().sender !== currentUser.id) {
                                updates[child.key + '/read'] = true;
                            }
                        });
                        database.ref('chats/' + currentChatId + '/messages').update(updates);
                    }
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== Message Input =====
        function setupMessageInput() {
            const input = document.getElementById('messageInput');
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                
                const sendBtn = document.getElementById('sendBtn');
                const voiceBtn = document.getElementById('voiceBtn');
                
                if (this.value.trim()) {
                    sendBtn.classList.remove('hidden');
                    voiceBtn.classList.add('hidden');
                } else {
                    sendBtn.classList.add('hidden');
                    voiceBtn.classList.remove('hidden');
                }
            });
            
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            
            const msg = {
                text,
                sender: currentUser.id,
                timestamp: Date.now(),
                sent: true,
                delivered: false,
                read: false
            };
            
            database.ref('chats/' + currentChatId + '/messages').push(msg)
                .then(() => {
                    input.value = '';
                    input.style.height = 'auto';
                    document.getElementById('sendBtn').classList.add('hidden');
                    document.getElementById('voiceBtn').classList.remove('hidden');
                    
                    setTimeout(() => {
                        database.ref('chats/' + currentChatId + '/messages')
                            .orderByChild('timestamp').limitToLast(1).once('value')
                            .then(snapshot => {
                                snapshot.forEach(child => child.ref.update({ delivered: true }));
                            });
                    }, 500);
                });
        }

        // ===== Images =====
        function selectImages() {
            document.getElementById('imageInput').click();
        }

        function selectCamera() {
            document.getElementById('cameraInput').click();
        }

        function handleImageSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            selectedImages = [];
            const grid = document.getElementById('previewGrid');
            grid.innerHTML = '';
            
            files.forEach((file, index) => {
                if (!file.type.startsWith('image/')) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImages.push(file);
                    
                    const div = document.createElement('div');
                    div.className = 'preview-image-item';
                    div.innerHTML = `
                        <img src="${e.target.result}">
                        <button class="remove-image-btn" onclick="removeImage(${selectedImages.length - 1})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    grid.appendChild(div);
                    
                    document.getElementById('imageCount').textContent = selectedImages.length;
                };
                reader.readAsDataURL(file);
            });
            
            document.getElementById('image-preview-modal').classList.remove('hidden');
            event.target.value = '';
        }

        function removeImage(index) {
            selectedImages.splice(index, 1);
            const grid = document.getElementById('previewGrid');
            grid.removeChild(grid.children[index]);
            document.getElementById('imageCount').textContent = selectedImages.length;
            
            if (selectedImages.length === 0) {
                closeImagePreview();
            }
        }

        function closeImagePreview() {
            document.getElementById('image-preview-modal').classList.add('hidden');
            selectedImages = [];
            document.getElementById('imageCaption').value = '';
        }

        function sendImages() {
            if (selectedImages.length === 0) return;
            
            const caption = document.getElementById('imageCaption').value.trim();
            closeImagePreview();
            
            selectedImages.forEach((file, index) => {
                const storageRef = storage.ref('chat-images/' + Date.now() + '_' + index + '_' + file.name);
                storageRef.put(file)
                    .then(snapshot => snapshot.ref.getDownloadURL())
                    .then(url => {
                        const msg = {
                            image: url,
                            text: index === 0 ? caption : '',
                            sender: currentUser.id,
                            timestamp: Date.now(),
                            sent: true,
                            delivered: false,
                            read: false
                        };
                        return database.ref('chats/' + currentChatId + '/messages').push(msg);
                    })
                    .catch(error => {
                        console.error('Upload error:', error);
                        alert('خطأ في رفع الصورة');
                    });
            });
        }

        function showImageViewer(url) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; align-items: center; justify-content: center;';
            modal.onclick = () => modal.remove();
            
            modal.innerHTML = `
                <div style="max-width: 95%; max-height: 95%;">
                    <img src="${url}" style="max-width: 100%; max-height: 90vh; border-radius: 8px;">
                </div>
                <button style="position: absolute; top: 16px; right: 16px; width: 40px; height: 40px; background: rgba(255,255,255,0.2); border: none; border-radius: 50%; color: #fff; font-size: 20px; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(modal);
        }

        // ===== Voice Recording (مُصلح) =====
        function startVoiceRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    isRecording = true;
                    audioChunks = [];
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.addEventListener('dataavailable', e => {
                        audioChunks.push(e.data);
                    });
                    
                    mediaRecorder.start();
                    recordingStartTime = Date.now();
                    
                    document.getElementById('normalInput').classList.add('hidden');
                    document.getElementById('voice-recording').classList.remove('hidden');
                    
                    updateRecordingDuration();
                    recordingInterval = setInterval(updateRecordingDuration, 1000);
                })
                .catch(error => {
                    console.error('Microphone error:', error);
                    alert('لا يمكن الوصول إلى الميكروفون');
                });
        }

        function updateRecordingDuration() {
            const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            document.getElementById('recordingDuration').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function cancelVoiceRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                clearInterval(recordingInterval);
                audioChunks = [];
                
                document.getElementById('voice-recording').classList.add('hidden');
                document.getElementById('normalInput').classList.remove('hidden');
            }
        }

        function sendVoiceMessage() {
            if (!mediaRecorder || !isRecording) return;
            
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            clearInterval(recordingInterval);
            
            const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
            const durationText = `${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`;
            
            mediaRecorder.addEventListener('stop', () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                const storageRef = storage.ref('voice/' + Date.now() + '.mp3');
                
                storageRef.put(audioBlob)
                    .then(snapshot => snapshot.ref.getDownloadURL())
                    .then(url => {
                        const msg = {
                            audio: url,
                            duration: durationText,
                            sender: currentUser.id,
                            timestamp: Date.now(),
                            sent: true,
                            delivered: false,
                            read: false
                        };
                        return database.ref('chats/' + currentChatId + '/messages').push(msg);
                    })
                    .then(() => {
                        isRecording = false;
                        audioChunks = [];
                        document.getElementById('voice-recording').classList.add('hidden');
                        document.getElementById('normalInput').classList.remove('hidden');
                    })
                    .catch(error => {
                        console.error('Voice upload error:', error);
                        alert('خطأ في رفع الرسالة الصوتية');
                    });
            });
        }

        function playAudio(url) {
            const audio = new Audio(url);
            audio.play();
        }

        // ===== Admin Functions =====
        function showAdminScreen() {
            hideAllScreens();
            document.getElementById('admin-screen').classList.remove('hidden');
            loadUsers();
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-panel').forEach(p => p.style.display = 'none');
            event.target.classList.add('active');
            document.getElementById(tab + 'Panel').style.display = 'block';
            
            if (tab === 'users') loadUsers();
        }

        function previewAvatar(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedAvatarFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('avatarPreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function generateUserCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            return Array(5).fill(0).map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
        }

        function createUser(e) {
            e.preventDefault();
            
            const name = document.getElementById('userName').value.trim();
            const msgDiv = document.getElementById('createMessage');
            
            if (!selectedAvatarFile) {
                msgDiv.innerHTML = '<p style="color: #f44336;">الرجاء اختيار صورة</p>';
                return;
            }
            
            const code = generateUserCode();
            msgDiv.innerHTML = '<p style="color: #25D366;"><i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...</p>';
            
            const storageRef = storage.ref('avatars/' + Date.now() + '_' + selectedAvatarFile.name);
            storageRef.put(selectedAvatarFile)
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(avatarUrl => {
                    return database.ref('users').push({
                        name,
                        avatar: avatarUrl,
                        code,
                        createdAt: Date.now(),
                        isAdmin: false,
                        blocked: false,
                        friends: {}
                    });
                })
                .then(() => {
                    msgDiv.innerHTML = '<p style="color: #25D366;"><i class="fas fa-check-circle"></i> تم الإنشاء بنجاح!</p>';
                    document.getElementById('userName').value = '';
                    document.getElementById('userAvatarFile').value = '';
                    document.getElementById('avatarPreview').style.display = 'none';
                    selectedAvatarFile = null;
                    
                    generateQRCode(code);
                    loadUsers();
                })
                .catch(error => {
                    msgDiv.innerHTML = '<p style="color: #f44336;">خطأ: ' + error.message + '</p>';
                });
        }

        function generateQRCode(code) {
            const display = document.getElementById('qrCodeDisplay');
            const canvas = document.getElementById('qrCanvas');
            display.style.display = 'block';
            document.getElementById('generatedCode').textContent = code;
            
            canvas.width = 256;
            canvas.height = 256;
            canvas.innerHTML = '';
            
            new QRCode(canvas, {
                text: code,
                width: 256,
                height: 256,
                colorDark: '#075E54',
                colorLight: '#ffffff'
            });
        }

        function loadUsers() {
            database.ref('users').once('value').then(snapshot => {
                const list = document.getElementById('usersList');
                if (!snapshot.exists()) {
                    list.innerHTML = '<p style="text-align: center; padding: 20px;">لا يوجد مستخدمون</p>';
                    return;
                }
                
                const users = [];
                snapshot.forEach(child => {
                    if (!child.val().isAdmin) {
                        users.push({ id: child.key, ...child.val() });
                    }
                });
                
                list.innerHTML = users.map(u => `
                    <div class="contact-item">
                        <img src="${u.avatar}" class="contact-avatar">
                        <div class="contact-info">
                            <div class="contact-name">${u.name}</div>
                            <div class="contact-status">${u.code}</div>
                        </div>
                    </div>
                `).join('');
            });
        }

        // ===== Other Functions =====
        function showMainMenu() {
            const actions = ['الإعدادات', 'تسجيل الخروج'];
            const action = prompt('اختر:\n1. الإعدادات\n2. تسجيل الخروج');
            if (action === '2') logout();
        }

        function showConversationMenu() {
            alert('📋 قائمة المحادثة\nقريباً...');
        }

        function showSettings() {
            alert('⚙️ الإعدادات\nقريباً...');
        }

        function logout() {
            if (confirm('تسجيل الخروج؟')) {
                currentUser = null;
                showFakeGmail();
            }
        }

        // ===== Service Worker =====
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js').catch(() => {});
        }

        console.log('✅ التطبيق جاهز!');
    </script>
</body>
</html>
