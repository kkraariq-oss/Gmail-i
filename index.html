<!-- =========================================
تطبيق المحادثة السري - النسخة 4.0
تحديث شامل بجميع الميزات المطلوبة
========================================= -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#075e54">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gmail">
    <title>Gmail</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico">
    <link rel="apple-touch-icon" href="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; background: #f5f5f5; overflow: hidden; position: fixed; width: 100%; height: 100%; }
        .hidden { display: none !important; }
        
        /* Gmail Fake UI */
        #fake-gmail { width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; }
        .gmail-header { height: 56px; background: #c71610; display: flex; align-items: center; padding: 0 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .gmail-logo { width: 40px; height: 40px; cursor: pointer; user-select: none; transition: transform 0.2s; }
        .gmail-logo:active { transform: scale(0.95); }
        .gmail-search { flex: 1; margin: 0 16px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; padding: 0 12px; color: #fff; }
        .gmail-search i { margin-left: 8px; font-size: 18px; }
        .gmail-search input { flex: 1; background: transparent; border: none; outline: none; color: #fff; font-size: 16px; }
        .gmail-search input::placeholder { color: rgba(255,255,255,0.7); }
        .gmail-content { flex: 1; overflow-y: auto; background: #f8f9fa; }
        .gmail-email { background: #fff; margin-bottom: 1px; padding: 16px; display: flex; align-items: flex-start; cursor: pointer; transition: background 0.2s; }
        .gmail-email:hover { background: #f8f9fa; }
        .gmail-email-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-left: 12px; flex-shrink: 0; }
        .gmail-email-content { flex: 1; min-width: 0; }
        .gmail-email-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .gmail-email-sender { font-weight: 600; font-size: 14px; color: #202124; }
        .gmail-email-time { font-size: 12px; color: #5f6368; }
        .gmail-email-subject { font-size: 14px; color: #202124; margin-bottom: 4px; font-weight: 500; }
        .gmail-email-preview { font-size: 13px; color: #5f6368; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Code Screen */
        #code-screen { width: 100%; height: 100%; background: linear-gradient(135deg, #128C7E 0%, #075e54 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .code-container { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px; max-width: 400px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: slideUp 0.5s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .code-container h2 { text-align: center; margin-bottom: 30px; color: #333; font-size: 24px; }
        .code-container i.fa-lock { font-size: 64px; text-align: center; display: block; margin-bottom: 20px; background: linear-gradient(135deg, #128C7E 0%, #075e54 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .code-input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 18px; text-align: center; margin-bottom: 20px; transition: all 0.3s; font-weight: 600; letter-spacing: 3px; text-transform: uppercase; }
        .code-input:focus { outline: none; border-color: #128C7E; box-shadow: 0 0 0 3px rgba(18, 140, 126, 0.1); }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: linear-gradient(135deg, #128C7E 0%, #075e54 100%); color: #fff; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(18, 140, 126, 0.4); }
        .btn-secondary { background: #f5f5f5; color: #333; margin-top: 10px; }
        .btn-secondary:hover { background: #e0e0e0; }
        .error-message { background: #ffebee; color: #c62828; padding: 12px; border-radius: 8px; margin: 10px 0; text-align: center; font-size: 14px; }
        .success-message { background: #e8f5e9; color: #2e7d32; padding: 12px; border-radius: 8px; margin: 10px 0; text-align: center; font-size: 14px; }

        /* Home Screen - WhatsApp Style */
        #home-screen { width: 100%; height: 100%; background: #f0f2f5; display: flex; flex-direction: column; }
        .home-header { background: #075e54; color: #fff; padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .home-header h2 { font-size: 20px; font-weight: 500; }
        .home-header-actions { display: flex; gap: 20px; }
        .home-header-btn { background: transparent; border: none; color: #fff; cursor: pointer; font-size: 20px; transition: opacity 0.3s; }
        .home-header-btn:hover { opacity: 0.8; }
        
        /* Tabs - WhatsApp Style */
        .home-tabs { background: #075e54; display: flex; padding: 0 16px; }
        .home-tab { flex: 1; padding: 14px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; color: rgba(255,255,255,0.7); font-weight: 500; font-size: 14px; }
        .home-tab:hover { background: rgba(255,255,255,0.1); }
        .home-tab.active { color: #fff; border-bottom-color: #fff; }
        
        /* Search Bar */
        .search-bar { background: #fff; padding: 10px 16px; border-bottom: 1px solid #e9edef; }
        .search-input-wrapper { background: #f0f2f5; border-radius: 8px; display: flex; align-items: center; padding: 8px 12px; }
        .search-input-wrapper i { color: #667781; margin-left: 8px; }
        .search-input-wrapper input { flex: 1; background: transparent; border: none; outline: none; font-size: 15px; color: #3b4a54; }
        .search-input-wrapper input::placeholder { color: #667781; }
        
        /* Chat List */
        .chat-list { flex: 1; overflow-y: auto; background: #fff; }
        .chat-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid #f0f2f5; }
        .chat-item:hover { background: #f5f6f6; }
        .chat-item-avatar-wrapper { position: relative; margin-left: 12px; }
        .chat-item-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .chat-item-status { position: absolute; bottom: 0; left: 0; width: 14px; height: 14px; border-radius: 50%; background: #25d366; border: 2px solid #fff; }
        .chat-item-content { flex: 1; min-width: 0; }
        .chat-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
        .chat-item-name { font-weight: 500; font-size: 16px; color: #111b21; }
        .chat-item-time { font-size: 12px; color: #667781; }
        .chat-item-message { font-size: 14px; color: #667781; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: flex; align-items: center; gap: 5px; }
        .chat-item-badge { background: #25d366; color: #fff; border-radius: 50%; min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 500; }
        
        /* Friend Requests */
        .friend-request-item { display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #f0f2f5; background: #fff; }
        .friend-request-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-left: 12px; }
        .friend-request-content { flex: 1; min-width: 0; }
        .friend-request-name { font-weight: 500; font-size: 16px; color: #111b21; margin-bottom: 5px; }
        .friend-request-text { font-size: 14px; color: #667781; margin-bottom: 10px; }
        .friend-request-actions { display: flex; gap: 10px; }
        .friend-request-btn { padding: 8px 20px; border: none; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .friend-request-btn.accept { background: #25d366; color: #fff; }
        .friend-request-btn.reject { background: #f0f2f5; color: #54656f; }
        
        /* Chat Screen - WhatsApp Style */
        #chat-screen { width: 100%; height: 100%; background: #efeae2; display: flex; flex-direction: column; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoV2luZG93cykiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OTlBMDREQUI5OEZGMTFFNEI4RkI5MDk5OTlGNThFOTAiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OTlBMDREQUM5OEZGMTFFNEI4RkI5MDk5OTlGNThFOTAiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5OUEwNERBOTk4RkYxMUU0QjhGQjkwOTk5OUY1OEU5MCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5OUEwNERBQTk4RkYxMUU0QjhGQjkwOTk5OUY1OEU5MCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqgRLaYAAAAmSURBVHjaYvz//z8DsQAggJiQOQwMQ4coQAAQIECAAEAAAQAA//8DAAHDAgEhYbGHAAAAAElFTkSuQmCC'); }
        .chat-header { background: #075e54; color: #fff; padding: 10px 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .chat-header-left { display: flex; align-items: center; gap: 12px; flex: 1; }
        .chat-back-btn { background: transparent; border: none; color: #fff; cursor: pointer; font-size: 24px; padding: 0; }
        .chat-header-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .chat-header-info { flex: 1; }
        .chat-header-info h3 { font-size: 16px; margin-bottom: 2px; font-weight: 500; }
        .chat-header-info p { font-size: 13px; opacity: 0.8; }
        .chat-header-actions { display: flex; gap: 20px; }
        .chat-header-btn { background: transparent; border: none; color: #fff; cursor: pointer; font-size: 18px; }
        
        /* Messages Container */
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px 16px; }
        .message { display: flex; margin-bottom: 8px; animation: messageSlide 0.3s ease; }
        @keyframes messageSlide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.sent { justify-content: flex-end; }
        .message.received { justify-content: flex-start; }
        .message-content { max-width: 75%; position: relative; }
        .message-bubble { padding: 6px 7px 8px 9px; border-radius: 7.5px; position: relative; word-wrap: break-word; }
        .message.sent .message-bubble { background: #d9fdd3; border-top-left-radius: 7.5px; border-top-right-radius: 0; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .message.received .message-bubble { background: #fff; border-top-left-radius: 0; border-top-right-radius: 7.5px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); }
        .message-text { font-size: 14.2px; color: #111b21; line-height: 19px; margin-bottom: 4px; }
        .message-image { max-width: 100%; border-radius: 7.5px; cursor: pointer; display: block; }
        .message-voice { display: flex; align-items: center; gap: 10px; padding: 4px; }
        .voice-play-btn { width: 36px; height: 36px; border-radius: 50%; background: #25d366; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .voice-waveform { flex: 1; height: 30px; display: flex; align-items: center; gap: 2px; }
        .voice-wave { width: 3px; height: 100%; background: #667781; border-radius: 2px; opacity: 0.5; }
        .voice-duration { font-size: 12px; color: #667781; }
        .message-footer { display: flex; align-items: center; justify-content: flex-end; gap: 4px; margin-top: 4px; }
        .message-time { font-size: 11px; color: #667781; }
        .message.sent .message-time { color: #667781; }
        .message-status { font-size: 16px; }
        .message-status.sending { color: #8696a0; }
        .message-status.sent { color: #8696a0; }
        .message-status.delivered { color: #8696a0; }
        .message-status.read { color: #53bdeb; }
        .message-deleted { font-style: italic; opacity: 0.6; }
        .message-options { position: absolute; top: 5px; left: 5px; opacity: 0; transition: opacity 0.3s; }
        .message:hover .message-options { opacity: 1; }
        .message-menu-btn { background: rgba(0,0,0,0.1); border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; color: #54656f; }
        .message-menu { position: absolute; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 8px 0; min-width: 150px; z-index: 100; }
        .message-menu-item { padding: 10px 16px; cursor: pointer; font-size: 14px; color: #3b4a54; transition: background 0.2s; display: flex; align-items: center; gap: 12px; }
        .message-menu-item:hover { background: #f0f2f5; }
        .message-menu-item.danger { color: #df3333; }
        
        /* Input Area */
        .chat-input { background: #f0f2f5; padding: 10px 16px; display: flex; align-items: center; gap: 10px; }
        .chat-input-actions { display: flex; gap: 5px; }
        .chat-input-btn { background: transparent; border: none; color: #54656f; cursor: pointer; font-size: 24px; padding: 5px; transition: transform 0.2s; }
        .chat-input-btn:active { transform: scale(0.9); }
        .chat-input-field { flex: 1; background: #fff; border-radius: 21px; padding: 9px 12px; border: none; outline: none; font-size: 15px; max-height: 100px; overflow-y: auto; resize: none; }
        .chat-send-btn { background: #25d366; border: none; color: #fff; cursor: pointer; font-size: 20px; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .chat-send-btn:active { transform: scale(0.9); }
        .chat-send-btn:disabled { background: #d0d0d0; cursor: not-allowed; }
        
        /* Voice Recording */
        .voice-recording { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #075e54; display: flex; align-items: center; padding: 0 16px; gap: 15px; }
        .voice-recording-time { color: #fff; font-size: 18px; font-weight: 500; min-width: 60px; }
        .voice-recording-waves { flex: 1; display: flex; align-items: center; justify-content: center; gap: 3px; height: 40px; }
        .voice-recording-wave { width: 4px; background: #fff; border-radius: 2px; animation: waveAnimation 1s ease-in-out infinite; }
        @keyframes waveAnimation { 0%, 100% { height: 10px; } 50% { height: 30px; } }
        .voice-recording-wave:nth-child(2) { animation-delay: 0.1s; }
        .voice-recording-wave:nth-child(3) { animation-delay: 0.2s; }
        .voice-recording-wave:nth-child(4) { animation-delay: 0.3s; }
        .voice-recording-wave:nth-child(5) { animation-delay: 0.4s; }
        .voice-recording-actions { display: flex; gap: 15px; }
        .voice-recording-btn { width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .voice-cancel-btn { background: #df3333; color: #fff; }
        .voice-send-btn { background: #25d366; color: #fff; }
        
        /* Loading Overlay */
        .upload-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: #fff; padding: 20px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 1000; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Story Viewer */
        .story-viewer { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; }
        .story-viewer-header { padding: 15px; display: flex; align-items: center; justify-content: space-between; position: relative; z-index: 10; }
        .story-progress-bars { position: absolute; top: 5px; left: 0; right: 0; display: flex; gap: 4px; padding: 0 10px; }
        .story-progress-bar { flex: 1; height: 2px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden; }
        .story-progress-fill { height: 100%; background: #fff; width: 0; transition: width 0.1s linear; }
        .story-viewer-user { display: flex; align-items: center; gap: 10px; color: #fff; margin-top: 20px; }
        .story-viewer-avatar { width: 35px; height: 35px; border-radius: 50%; }
        .story-viewer-name { font-size: 15px; font-weight: 500; }
        .story-viewer-time { font-size: 13px; opacity: 0.8; }
        .story-close-btn { background: transparent; border: none; color: #fff; cursor: pointer; font-size: 28px; }
        .story-viewer-content { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .story-viewer-media { max-width: 100%; max-height: 100%; object-fit: contain; }
        .story-navigation { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; }
        .story-nav-area { flex: 1; cursor: pointer; }
        
        /* Modals */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1500; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: #fff; border-radius: 12px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-between; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: transparent; border: none; font-size: 24px; color: #666; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; justify-content: flex-end; }
        
        /* Search Users Modal */
        .search-users-list { max-height: 400px; overflow-y: auto; }
        .search-user-item { display: flex; align-items: center; padding: 12px; cursor: pointer; transition: background 0.2s; border-radius: 8px; }
        .search-user-item:hover { background: #f0f2f5; }
        .search-user-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-left: 12px; }
        .search-user-info { flex: 1; }
        .search-user-name { font-weight: 500; font-size: 16px; color: #111b21; }
        .search-user-btn { padding: 8px 20px; border: none; border-radius: 20px; font-size: 14px; font-weight: 500; cursor: pointer; background: #25d366; color: #fff; }
        .search-user-btn.requested { background: #d0d0d0; cursor: not-allowed; }
        
        /* Admin Screen */
        #admin-screen { width: 100%; height: 100%; background: #f5f7fa; display: flex; flex-direction: column; }
        .admin-header { background: linear-gradient(135deg, #128C7E 0%, #075e54 100%); color: #fff; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .admin-header h2 { font-size: 24px; margin-bottom: 5px; }
        .admin-tabs { display: flex; background: #fff; border-bottom: 1px solid #e0e0e0; }
        .admin-tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; font-weight: 600; color: #666; }
        .admin-tab:hover { background: #f5f5f5; }
        .admin-tab.active { color: #128C7E; border-bottom-color: #128C7E; }
        .admin-content { flex: 1; overflow-y: auto; padding: 20px; }
        .admin-panel { display: none; }
        .admin-panel.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: all 0.3s; }
        .form-control:focus { outline: none; border-color: #128C7E; box-shadow: 0 0 0 3px rgba(18, 140, 126, 0.1); }
        .user-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 15px; transition: all 0.3s; }
        .user-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.12); transform: translateY(-2px); }
        .user-card-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .user-card-info { flex: 1; }
        .user-card-name { font-weight: 600; font-size: 16px; margin-bottom: 5px; }
        .user-card-code { font-size: 13px; color: #666; font-family: monospace; background: #f5f5f5; padding: 3px 8px; border-radius: 4px; display: inline-block; }
        .user-card-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn-icon { width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 14px; }
        .btn-icon:hover { transform: scale(1.1); }
        .btn-icon.btn-view { background: #e3f2fd; color: #1976d2; }
        .btn-icon.btn-chat { background: #e8f5e9; color: #388e3c; }
        .btn-icon.btn-block { background: #fff3e0; color: #f57c00; }
        .btn-icon.btn-delete { background: #ffebee; color: #d32f2f; }
        .qr-code-container { text-align: center; padding: 20px; background: #fff; border-radius: 12px; margin-top: 20px; }
        .qr-code-container canvas { max-width: 250px; margin: 20px auto; display: block; }
        
        /* QR Scanner */
        #qr-scanner { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; }
        .scanner-header { padding: 20px; display: flex; align-items: center; justify-content: space-between; }
        .scanner-header h3 { color: #fff; font-size: 20px; }
        .scanner-close { background: transparent; border: none; color: #fff; cursor: pointer; font-size: 28px; }
        .scanner-video { width: 100%; height: 100%; object-fit: cover; }
        .scanner-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 250px; height: 250px; border: 3px solid #fff; border-radius: 20px; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); }
        .scanner-line { position: absolute; top: 0; left: 0; right: 0; height: 3px; background: #25d366; animation: scan 2s linear infinite; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: #667781; }
        .empty-state i { font-size: 64px; margin-bottom: 15px; opacity: 0.3; }
        .empty-state p { font-size: 16px; margin-bottom: 10px; }
        .empty-state small { font-size: 14px; opacity: 0.7; }
        
        /* Image Viewer */
        .image-viewer { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; flex-direction: column; }
        .image-viewer-header { padding: 15px; display: flex; align-items: center; justify-content: space-between; }
        .image-viewer-close { background: transparent; border: none; color: #fff; cursor: pointer; font-size: 28px; }
        .image-viewer-content { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .image-viewer-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .image-viewer-actions { padding: 15px; display: flex; justify-content: center; gap: 20px; }
        .image-viewer-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; cursor: pointer; padding: 12px 24px; border-radius: 8px; font-size: 16px; }
        
        /* Responsive */
        @media (max-width: 600px) {
            .modal-content { max-width: 100%; border-radius: 0; max-height: 100vh; }
        }
    </style>
</head>
<body>
    <!-- Fake Gmail -->
    <div id="fake-gmail">
        <div class="gmail-header">
            <svg class="gmail-logo" viewBox="0 0 40 40" fill="#fff">
                <path d="M8 8v24h24V8H8zm20 20H12V16l8 5 8-5v12z"/>
            </svg>
            <div class="gmail-search">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="البحث في الرسائل">
            </div>
        </div>
        <div class="gmail-content" id="gmail-emails"></div>
    </div>

    <!-- Code Screen -->
    <div id="code-screen" class="hidden">
        <div class="code-container">
            <i class="fas fa-lock"></i>
            <h2>أدخل الكود</h2>
            <input type="text" class="code-input" id="code-input" placeholder="الكود" maxlength="20">
            <div id="code-error" class="error-message hidden"></div>
            <button class="btn btn-primary" onclick="submitCode()">
                <i class="fas fa-sign-in-alt"></i>
                دخول
            </button>
            <button class="btn btn-secondary" onclick="showQRScanner()">
                <i class="fas fa-qrcode"></i>
                مسح QR Code
            </button>
            <button class="btn btn-secondary" onclick="backToGmail()">
                <i class="fas fa-arrow-right"></i>
                رجوع
            </button>
        </div>
    </div>

    <!-- Home Screen -->
    <div id="home-screen" class="hidden">
        <div class="home-header">
            <h2>الرسائل</h2>
            <div class="home-header-actions">
                <button class="home-header-btn" onclick="showSearchUsers()"><i class="fas fa-user-plus"></i></button>
                <button class="home-header-btn" onclick="openSettings()"><i class="fas fa-ellipsis-v"></i></button>
            </div>
        </div>
        <div class="home-tabs">
            <div class="home-tab active" data-tab="chats">المحادثات</div>
            <div class="home-tab" data-tab="requests">الطلبات <span id="requests-badge" class="hidden"></span></div>
        </div>
        <div class="search-bar">
            <div class="search-input-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="ابحث أو ابدأ محادثة جديدة" id="home-search">
            </div>
        </div>
        <div id="chats-tab" class="chat-list"></div>
        <div id="requests-tab" class="chat-list hidden"></div>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen" class="hidden">
        <div class="chat-header">
            <div class="chat-header-left">
                <button class="chat-back-btn" onclick="backToHome()"><i class="fas fa-arrow-right"></i></button>
                <img class="chat-header-avatar" id="chat-header-avatar" src="" alt="">
                <div class="chat-header-info">
                    <h3 id="chat-header-name"></h3>
                    <p id="chat-header-status">متصل</p>
                </div>
            </div>
            <div class="chat-header-actions">
                <button class="chat-header-btn"><i class="fas fa-video"></i></button>
                <button class="chat-header-btn"><i class="fas fa-phone"></i></button>
                <button class="chat-header-btn"><i class="fas fa-ellipsis-v"></i></button>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input" id="chat-input-container">
            <div class="chat-input-actions">
                <button class="chat-input-btn" onclick="triggerImageUpload()"><i class="fas fa-image"></i></button>
                <button class="chat-input-btn" onclick="startVoiceRecording()"><i class="fas fa-microphone"></i></button>
                <input type="file" id="image-input" accept="image/*" style="display: none" onchange="handleImageSelect(event)">
            </div>
            <textarea class="chat-input-field" id="message-input" placeholder="اكتب رسالة..." rows="1"></textarea>
            <button class="chat-send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
        <div class="voice-recording hidden" id="voice-recording">
            <div class="voice-recording-time" id="recording-time">00:00</div>
            <div class="voice-recording-waves">
                <div class="voice-recording-wave"></div>
                <div class="voice-recording-wave"></div>
                <div class="voice-recording-wave"></div>
                <div class="voice-recording-wave"></div>
                <div class="voice-recording-wave"></div>
            </div>
            <div class="voice-recording-actions">
                <button class="voice-recording-btn voice-cancel-btn" onclick="cancelVoiceRecording()"><i class="fas fa-times"></i></button>
                <button class="voice-recording-btn voice-send-btn" onclick="sendVoiceRecording()"><i class="fas fa-check"></i></button>
            </div>
        </div>
    </div>

    <!-- Admin Screen -->
    <div id="admin-screen" class="hidden">
        <div class="admin-header">
            <h2>لوحة التحكم</h2>
            <p>مرحباً بك في لوحة الإدارة</p>
        </div>
        <div class="admin-tabs">
            <div class="admin-tab active" data-tab="create">إنشاء مستخدم</div>
            <div class="admin-tab" data-tab="users">المستخدمين</div>
            <div class="admin-tab" data-tab="conversations">المحادثات</div>
            <div class="admin-tab" data-tab="settings">الإعدادات</div>
        </div>
        <div class="admin-content">
            <div class="admin-panel active" id="admin-create">
                <div class="form-group">
                    <label>اسم المستخدم</label>
                    <input type="text" class="form-control" id="new-username" placeholder="أدخل اسم المستخدم">
                </div>
                <div class="form-group">
                    <label>الكود</label>
                    <input type="text" class="form-control" id="new-usercode" placeholder="أدخل الكود (5 أحرف على الأقل)">
                </div>
                <div class="form-group">
                    <label>رابط الصورة الشخصية</label>
                    <input type="text" class="form-control" id="new-useravatar" placeholder="https://example.com/avatar.jpg">
                </div>
                <button class="btn btn-primary" onclick="createUser()">
                    <i class="fas fa-user-plus"></i>
                    إنشاء مستخدم
                </button>
                <div id="create-message" class="hidden"></div>
                <div id="qr-display" class="qr-code-container hidden"></div>
            </div>
            <div class="admin-panel" id="admin-users"></div>
            <div class="admin-panel" id="admin-conversations"></div>
            <div class="admin-panel" id="admin-settings">
                <div class="form-group">
                    <label>كود الأدمن الحالي</label>
                    <input type="password" class="form-control" id="current-admin-code" placeholder="أدخل الكود الحالي">
                </div>
                <div class="form-group">
                    <label>كود الأدمن الجديد</label>
                    <input type="text" class="form-control" id="new-admin-code" placeholder="أدخل الكود الجديد">
                </div>
                <button class="btn btn-primary" onclick="changeAdminCode()">
                    <i class="fas fa-key"></i>
                    تغيير الكود
                </button>
                <div id="settings-message" class="hidden"></div>
                <div style="margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Users Modal -->
    <div id="search-users-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>البحث عن مستخدمين</h3>
                <button class="modal-close" onclick="closeSearchUsers()">×</button>
            </div>
            <div class="modal-body">
                <div class="search-bar">
                    <div class="search-input-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="ابحث بالاسم..." id="search-users-input" oninput="searchUsers()">
                    </div>
                </div>
                <div class="search-users-list" id="search-users-list"></div>
            </div>
        </div>
    </div>

    <!-- QR Scanner -->
    <div id="qr-scanner" class="hidden">
        <div class="scanner-header">
            <h3>مسح QR Code</h3>
            <button class="scanner-close" onclick="closeQRScanner()">×</button>
        </div>
        <video id="scanner-video" class="scanner-video" playsinline></video>
        <div class="scanner-overlay">
            <div class="scanner-line"></div>
        </div>
    </div>

    <!-- Image Viewer -->
    <div id="image-viewer" class="image-viewer hidden">
        <div class="image-viewer-header">
            <button class="image-viewer-close" onclick="closeImageViewer()">×</button>
            <div></div>
        </div>
        <div class="image-viewer-content">
            <img id="viewer-image" class="image-viewer-img" src="" alt="">
        </div>
        <div class="image-viewer-actions">
            <button class="image-viewer-btn" onclick="downloadImage()"><i class="fas fa-download"></i> تحميل</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="upload-loading" class="upload-loading hidden">
        <div class="spinner"></div>
        <p>جاري الرفع...</p>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEMiAI",
            authDomain: "messageemeapp.firebaseapp.com",
            databaseURL: "https://messageemeapp-default-rtdb.firebaseio.com",
            projectId: "messageemeapp",
            storageBucket: "messageemeapp.appspot.com",
            messagingSenderId: "255034474844",
            appId: "1:255034474844:web:5e3b7a6bc4b2fb94cc4199"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let isAdmin = false;
        let clickCount = 0;
        let clickTimer = null;
        let currentChatUser = null;
        let messagesListener = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimer = null;
        let recordingSeconds = 0;
        let currentMessageMenu = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showGmail();
            setupGmailEmails();
            setupTabs();
            setupMessageInput();
            
            // Register Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js');
            }
        });

        // Gmail Logo Click Handler
        document.querySelector('.gmail-logo').addEventListener('click', () => {
            clickCount++;
            if (clickTimer) clearTimeout(clickTimer);
            
            if (clickCount >= 5) {
                clickCount = 0;
                showCodeScreen();
            } else {
                clickTimer = setTimeout(() => {
                    clickCount = 0;
                }, 500);
            }
        });

        // Setup Gmail Emails
        function setupGmailEmails() {
            const emails = [
                { sender: 'Google', subject: 'تنبيه أمني', preview: 'تم تسجيل دخول جديد إلى حسابك', time: new Date(Date.now() - 2 * 60 * 60 * 1000) },
                { sender: 'Facebook', subject: 'لديك إشعارات جديدة', preview: 'أحمد أعجب بمنشورك', time: new Date(Date.now() - 5 * 60 * 60 * 1000) },
                { sender: 'Amazon', subject: 'طلبك في الطريق', preview: 'سيصل طلبك غداً', time: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000) },
                { sender: 'Netflix', subject: 'تذكير الدفع', preview: 'موعد الدفع القادم بعد 3 أيام', time: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000) },
                { sender: 'WhatsApp', subject: 'رمز التحقق', preview: 'رمز التحقق الخاص بك: 123-456', time: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000) },
                { sender: 'Twitter', subject: 'ملخص الأسبوع', preview: 'إليك أهم التغريدات هذا الأسبوع', time: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000) },
                { sender: 'LinkedIn', subject: 'لديك 5 مشاهدات جديدة', preview: 'شاهد من زار ملفك الشخصي', time: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000) },
                { sender: 'Apple', subject: 'فاتورة App Store', preview: 'فاتورة شهر ديسمبر', time: new Date(Date.now() - 6 * 24 * 60 * 60 * 1000) },
                { sender: 'Instagram', subject: 'اقتراحات لك', preview: 'حسابات قد تهمك', time: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) },
                { sender: 'YouTube', subject: 'فيديوهات جديدة', preview: 'قناتك المفضلة نشرت فيديو جديد', time: new Date(Date.now() - 8 * 24 * 60 * 60 * 1000) }
            ];

            const container = document.getElementById('gmail-emails');
            container.innerHTML = emails.map(email => `
                <div class="gmail-email">
                    <div class="gmail-email-avatar">${email.sender[0]}</div>
                    <div class="gmail-email-content">
                        <div class="gmail-email-header">
                            <span class="gmail-email-sender">${email.sender}</span>
                            <span class="gmail-email-time">${formatTime(email.time)}</span>
                        </div>
                        <div class="gmail-email-subject">${email.subject}</div>
                        <div class="gmail-email-preview">${email.preview}</div>
                    </div>
                </div>
            `).join('');

            setInterval(() => {
                const timeElements = container.querySelectorAll('.gmail-email-time');
                timeElements.forEach((el, i) => {
                    el.textContent = formatTime(emails[i].time);
                });
            }, 60000);
        }

        // Format Time
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 60) return `منذ ${minutes} دقيقة`;
            if (hours < 24) return `منذ ${hours} ساعة`;
            if (days === 1) return 'أمس';
            if (days < 7) return `منذ ${days} يوم`;
            
            return date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
        }

        // Setup Tabs
        function setupTabs() {
            document.querySelectorAll('.home-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.home-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const tabName = tab.dataset.tab;
                    if (tabName === 'chats') {
                        document.getElementById('chats-tab').classList.remove('hidden');
                        document.getElementById('requests-tab').classList.add('hidden');
                    } else if (tabName === 'requests') {
                        document.getElementById('chats-tab').classList.add('hidden');
                        document.getElementById('requests-tab').classList.remove('hidden');
                        loadFriendRequests();
                    }
                });
            });

            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
                    const panelId = 'admin-' + tab.dataset.tab;
                    document.getElementById(panelId).classList.add('active');
                    
                    if (tab.dataset.tab === 'users') loadUsers();
                    if (tab.dataset.tab === 'conversations') loadConversations();
                });
            });
        }

        // Setup Message Input
        function setupMessageInput() {
            const input = document.getElementById('message-input');
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 100) + 'px';
            });
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        // Show/Hide Screens
        function showGmail() {
            document.getElementById('fake-gmail').classList.remove('hidden');
            document.getElementById('code-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('admin-screen').classList.add('hidden');
        }

        function showCodeScreen() {
            document.getElementById('fake-gmail').classList.add('hidden');
            document.getElementById('code-screen').classList.remove('hidden');
            document.getElementById('code-input').focus();
        }

        function showHomeScreen() {
            document.getElementById('fake-gmail').classList.add('hidden');
            document.getElementById('code-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('admin-screen').classList.add('hidden');
            loadChats();
        }

        function showChatScreen(user) {
            currentChatUser = user;
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');
            document.getElementById('chat-header-avatar').src = user.avatar || 'https://via.placeholder.com/40';
            document.getElementById('chat-header-name').textContent = user.name;
            loadMessages(user.code);
        }

        function showAdminScreen() {
            document.getElementById('fake-gmail').classList.add('hidden');
            document.getElementById('code-screen').classList.add('hidden');
            document.getElementById('admin-screen').classList.remove('hidden');
        }

        function backToGmail() {
            showGmail();
            document.getElementById('code-input').value = '';
            document.getElementById('code-error').classList.add('hidden');
        }

        function backToHome() {
            if (messagesListener) messagesListener.off();
            showHomeScreen();
        }

        // Submit Code
        async function submitCode() {
            const code = document.getElementById('code-input').value.trim().toUpperCase();
            const errorEl = document.getElementById('code-error');
            
            if (!code) {
                errorEl.textContent = 'الرجاء إدخال الكود';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                // Check Admin Code
                const adminCodeSnapshot = await database.ref('adminCode').once('value');
                const adminCode = adminCodeSnapshot.val() || 'ADMIN';
                
                if (code === adminCode) {
                    isAdmin = true;
                    currentUser = { code: 'ADMIN', name: 'المسؤول', isAdmin: true };
                    showAdminScreen();
                    return;
                }

                // Check User Code
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val() || {};
                
                const user = Object.values(users).find(u => u.code === code);
                
                if (user) {
                    if (user.blocked) {
                        errorEl.textContent = 'هذا الحساب محظور';
                        errorEl.classList.remove('hidden');
                        return;
                    }
                    
                    currentUser = user;
                    isAdmin = false;
                    
                    // Update last seen
                    await database.ref(`users/${user.code}`).update({
                        lastSeen: Date.now(),
                        online: true
                    });
                    
                    showHomeScreen();
                } else {
                    errorEl.textContent = 'الكود غير صحيح';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                errorEl.textContent = 'حدث خطأ، حاول مرة أخرى';
                errorEl.classList.remove('hidden');
            }
        }

        // Load Chats
        async function loadChats() {
            const container = document.getElementById('chats-tab');
            
            try {
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val() || {};
                
                // Get friends only
                const friendsSnapshot = await database.ref(`friends/${currentUser.code}`).once('value');
                const friends = friendsSnapshot.val() || {};
                
                const friendsList = Object.keys(friends).filter(code => friends[code] === true);
                
                if (friendsList.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <p>لا توجد محادثات</p>
                            <small>ابحث عن مستخدمين وأضفهم لبدء المحادثة</small>
                        </div>
                    `;
                    return;
                }
                
                // Get chats with unread count
                const chatsPromises = friendsList.map(async (friendCode) => {
                    const friend = users[friendCode];
                    if (!friend) return null;
                    
                    const chatId = [currentUser.code, friendCode].sort().join('_');
                    const messagesSnapshot = await database.ref(`chats/${chatId}`).orderByChild('timestamp').limitToLast(1).once('value');
                    const messages = messagesSnapshot.val() || {};
                    const lastMessage = Object.values(messages)[0];
                    
                    // Count unread messages
                    const unreadSnapshot = await database.ref(`chats/${chatId}`).orderByChild('read').equalTo(false).once('value');
                    const unreadMessages = unreadSnapshot.val() || {};
                    const unreadCount = Object.values(unreadMessages).filter(m => m.to === currentUser.code).length;
                    
                    return {
                        user: friend,
                        lastMessage,
                        unreadCount,
                        timestamp: lastMessage?.timestamp || 0
                    };
                });
                
                const chats = (await Promise.all(chatsPromises)).filter(c => c !== null);
                chats.sort((a, b) => b.timestamp - a.timestamp);
                
                container.innerHTML = chats.map(chat => {
                    const time = chat.lastMessage ? formatTime(new Date(chat.lastMessage.timestamp)) : '';
                    const preview = chat.lastMessage 
                        ? (chat.lastMessage.type === 'image' ? '📷 صورة' : 
                           chat.lastMessage.type === 'voice' ? '🎤 رسالة صوتية' : 
                           chat.lastMessage.text || '')
                        : '';
                    
                    return `
                        <div class="chat-item" onclick='openChat(${JSON.stringify(chat.user)})'>
                            <div class="chat-item-avatar-wrapper">
                                <img class="chat-item-avatar" src="${chat.user.avatar || 'https://via.placeholder.com/50'}" alt="">
                                ${chat.user.online ? '<div class="chat-item-status"></div>' : ''}
                            </div>
                            <div class="chat-item-content">
                                <div class="chat-item-header">
                                    <span class="chat-item-name">${chat.user.name}</span>
                                    <span class="chat-item-time">${time}</span>
                                </div>
                                <div class="chat-item-message">
                                    ${preview}
                                </div>
                            </div>
                            ${chat.unreadCount > 0 ? `<div class="chat-item-badge">${chat.unreadCount}</div>` : ''}
                        </div>
                    `;
                }).join('');
                
                // Update requests count
                const requestsSnapshot = await database.ref(`friendRequests/${currentUser.code}`).once('value');
                const requests = requestsSnapshot.val() || {};
                const pendingRequests = Object.values(requests).filter(r => r.status === 'pending');
                
                const badge = document.getElementById('requests-badge');
                if (pendingRequests.length > 0) {
                    badge.textContent = pendingRequests.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading chats:', error);
            }
        }

        // Open Chat
        function openChat(user) {
            showChatScreen(user);
        }

        // Load Messages
        async function loadMessages(friendCode) {
            const container = document.getElementById('chat-messages');
            const chatId = [currentUser.code, friendCode].sort().join('_');
            
            // Listen for new messages in real-time
            messagesListener = database.ref(`chats/${chatId}`).orderByChild('timestamp');
            
            messagesListener.on('value', (snapshot) => {
                const messages = snapshot.val() || {};
                const messagesArray = Object.entries(messages).map(([id, msg]) => ({ id, ...msg }));
                messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                
                container.innerHTML = '';
                
                messagesArray.forEach(msg => {
                    const isSent = msg.from === currentUser.code;
                    const messageEl = createMessageElement(msg, isSent);
                    container.appendChild(messageEl);
                    
                    // Mark as read
                    if (!isSent && !msg.read) {
                        database.ref(`chats/${chatId}/${msg.id}`).update({ 
                            read: true,
                            readAt: Date.now()
                        });
                    }
                });
                
                container.scrollTop = container.scrollHeight;
            });
        }

        // Create Message Element
        function createMessageElement(msg, isSent) {
            const div = document.createElement('div');
            div.className = `message ${isSent ? 'sent' : 'received'}`;
            div.dataset.messageId = msg.id;
            
            let content = '';
            
            if (msg.deleted) {
                content = `
                    <div class="message-content">
                        <div class="message-bubble">
                            <div class="message-text message-deleted">
                                <i class="fas fa-ban"></i> تم حذف هذه الرسالة
                            </div>
                            <div class="message-footer">
                                <span class="message-time">${formatTime(new Date(msg.timestamp))}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else if (msg.type === 'image') {
                content = `
                    <div class="message-content">
                        <div class="message-bubble">
                            <img class="message-image" src="${msg.imageUrl}" alt="" onclick="viewImage('${msg.imageUrl}')">
                            ${msg.text ? `<div class="message-text">${escapeHtml(msg.text)}</div>` : ''}
                            <div class="message-footer">
                                <span class="message-time">${formatTime(new Date(msg.timestamp))}</span>
                                ${isSent ? getStatusIcon(msg) : ''}
                            </div>
                        </div>
                        ${isSent ? `<div class="message-options"><button class="message-menu-btn" onclick="showMessageMenu(event, '${msg.id}')">⋮</button></div>` : ''}
                    </div>
                `;
            } else if (msg.type === 'voice') {
                content = `
                    <div class="message-content">
                        <div class="message-bubble">
                            <div class="message-voice">
                                <button class="voice-play-btn" onclick="playVoice('${msg.voiceUrl}', this)">
                                    <i class="fas fa-play"></i>
                                </button>
                                <div class="voice-waveform">
                                    ${Array(20).fill().map(() => `<div class="voice-wave" style="height: ${Math.random() * 100}%"></div>`).join('')}
                                </div>
                                <span class="voice-duration">${msg.duration || '0:00'}</span>
                            </div>
                            <div class="message-footer">
                                <span class="message-time">${formatTime(new Date(msg.timestamp))}</span>
                                ${isSent ? getStatusIcon(msg) : ''}
                            </div>
                        </div>
                        ${isSent ? `<div class="message-options"><button class="message-menu-btn" onclick="showMessageMenu(event, '${msg.id}')">⋮</button></div>` : ''}
                    </div>
                `;
            } else {
                content = `
                    <div class="message-content">
                        <div class="message-bubble">
                            <div class="message-text">${escapeHtml(msg.text)}</div>
                            <div class="message-footer">
                                <span class="message-time">${formatTime(new Date(msg.timestamp))}</span>
                                ${isSent ? getStatusIcon(msg) : ''}
                            </div>
                        </div>
                        ${isSent ? `<div class="message-options"><button class="message-menu-btn" onclick="showMessageMenu(event, '${msg.id}')">⋮</button></div>` : ''}
                    </div>
                `;
            }
            
            div.innerHTML = content;
            return div;
        }

        // Get Status Icon
        function getStatusIcon(msg) {
            if (!msg.sent) {
                return '<i class="message-status sending fas fa-clock"></i>';
            }
            if (msg.read) {
                return '<i class="message-status read fas fa-check-double"></i>';
            }
            if (msg.delivered) {
                return '<i class="message-status delivered fas fa-check-double"></i>';
            }
            return '<i class="message-status sent fas fa-check"></i>';
        }

        // Send Message
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !currentChatUser) return;
            
            input.value = '';
            input.style.height = 'auto';
            
            const chatId = [currentUser.code, currentChatUser.code].sort().join('_');
            const messageId = database.ref(`chats/${chatId}`).push().key;
            
            const message = {
                id: messageId,
                from: currentUser.code,
                to: currentChatUser.code,
                text: text,
                type: 'text',
                timestamp: Date.now(),
                sent: false,
                delivered: false,
                read: false
            };
            
            // Add to UI immediately
            const container = document.getElementById('chat-messages');
            const messageEl = createMessageElement(message, true);
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
            
            // Send to Firebase
            try {
                await database.ref(`chats/${chatId}/${messageId}`).set({
                    ...message,
                    sent: true,
                    delivered: true
                });
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Image Upload
        function triggerImageUpload() {
            document.getElementById('image-input').click();
        }

        async function handleImageSelect(event) {
            const file = event.target.files[0];
            if (!file || !currentChatUser) return;
            
            document.getElementById('upload-loading').classList.remove('hidden');
            
            try {
                const storageRef = storage.ref(`messages/${Date.now()}_${file.name}`);
                const snapshot = await storageRef.put(file);
                const imageUrl = await snapshot.ref.getDownloadURL();
                
                const chatId = [currentUser.code, currentChatUser.code].sort().join('_');
                const messageId = database.ref(`chats/${chatId}`).push().key;
                
                await database.ref(`chats/${chatId}/${messageId}`).set({
                    id: messageId,
                    from: currentUser.code,
                    to: currentChatUser.code,
                    type: 'image',
                    imageUrl: imageUrl,
                    text: '',
                    timestamp: Date.now(),
                    sent: true,
                    delivered: true,
                    read: false
                });
                
                event.target.value = '';
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('فشل رفع الصورة');
            } finally {
                document.getElementById('upload-loading').classList.add('hidden');
            }
        }

        // Voice Recording
        async function startVoiceRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                recordingSeconds = 0;
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    audioChunks.push(event.data);
                });
                
                mediaRecorder.start();
                
                document.getElementById('chat-input-container').style.display = 'none';
                document.getElementById('voice-recording').classList.remove('hidden');
                
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    document.getElementById('recording-time').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('فشل الوصول إلى الميكروفون');
            }
        }

        function cancelVoiceRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            
            clearInterval(recordingTimer);
            audioChunks = [];
            recordingSeconds = 0;
            
            document.getElementById('chat-input-container').style.display = 'flex';
            document.getElementById('voice-recording').classList.add('hidden');
        }

        async function sendVoiceRecording() {
            if (!mediaRecorder || !currentChatUser) return;
            
            mediaRecorder.stop();
            
            mediaRecorder.addEventListener('stop', async () => {
                document.getElementById('upload-loading').classList.remove('hidden');
                
                try {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                    const storageRef = storage.ref(`voices/${Date.now()}.mp3`);
                    const snapshot = await storageRef.put(audioBlob);
                    const voiceUrl = await snapshot.ref.getDownloadURL();
                    
                    const chatId = [currentUser.code, currentChatUser.code].sort().join('_');
                    const messageId = database.ref(`chats/${chatId}`).push().key;
                    
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    const duration = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    await database.ref(`chats/${chatId}/${messageId}`).set({
                        id: messageId,
                        from: currentUser.code,
                        to: currentChatUser.code,
                        type: 'voice',
                        voiceUrl: voiceUrl,
                        duration: duration,
                        timestamp: Date.now(),
                        sent: true,
                        delivered: true,
                        read: false
                    });
                    
                    mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    clearInterval(recordingTimer);
                    audioChunks = [];
                    recordingSeconds = 0;
                    
                    document.getElementById('chat-input-container').style.display = 'flex';
                    document.getElementById('voice-recording').classList.add('hidden');
                } catch (error) {
                    console.error('Error sending voice:', error);
                    alert('فشل إرسال الرسالة الصوتية');
                } finally {
                    document.getElementById('upload-loading').classList.add('hidden');
                }
            });
        }

        // Play Voice
        function playVoice(url, button) {
            const audio = new Audio(url);
            const icon = button.querySelector('i');
            
            icon.classList.remove('fa-play');
            icon.classList.add('fa-pause');
            
            audio.play();
            
            audio.addEventListener('ended', () => {
                icon.classList.remove('fa-pause');
                icon.classList.add('fa-play');
            });
            
            button.onclick = () => {
                if (audio.paused) {
                    audio.play();
                    icon.classList.remove('fa-play');
                    icon.classList.add('fa-pause');
                } else {
                    audio.pause();
                    icon.classList.remove('fa-pause');
                    icon.classList.add('fa-play');
                }
            };
        }

        // Message Menu
        function showMessageMenu(event, messageId) {
            event.stopPropagation();
            
            if (currentMessageMenu) {
                currentMessageMenu.remove();
            }
            
            const menu = document.createElement('div');
            menu.className = 'message-menu';
            menu.innerHTML = `
                <div class="message-menu-item" onclick="deleteMessageForMe('${messageId}')">
                    <i class="fas fa-trash"></i>
                    حذف لدي فقط
                </div>
                <div class="message-menu-item danger" onclick="deleteMessageForEveryone('${messageId}')">
                    <i class="fas fa-trash-alt"></i>
                    حذف للطرفين
                </div>
            `;
            
            const button = event.target.closest('.message-menu-btn');
            const rect = button.getBoundingClientRect();
            menu.style.position = 'fixed';
            menu.style.top = rect.bottom + 5 + 'px';
            menu.style.right = window.innerWidth - rect.right + 'px';
            
            document.body.appendChild(menu);
            currentMessageMenu = menu;
            
            setTimeout(() => {
                document.addEventListener('click', closeMessageMenu);
            }, 100);
        }

        function closeMessageMenu() {
            if (currentMessageMenu) {
                currentMessageMenu.remove();
                currentMessageMenu = null;
            }
            document.removeEventListener('click', closeMessageMenu);
        }

        async function deleteMessageForMe(messageId) {
            closeMessageMenu();
            // Just hide from UI (you could implement local storage filtering)
            const messageEl = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) messageEl.remove();
        }

        async function deleteMessageForEveryone(messageId) {
            closeMessageMenu();
            
            if (!confirm('هل تريد حذف هذه الرسالة للطرفين؟')) return;
            
            const chatId = [currentUser.code, currentChatUser.code].sort().join('_');
            
            try {
                await database.ref(`chats/${chatId}/${messageId}`).update({
                    deleted: true,
                    deletedAt: Date.now()
                });
            } catch (error) {
                console.error('Error deleting message:', error);
            }
        }

        // Search Users
        function showSearchUsers() {
            document.getElementById('search-users-modal').classList.remove('hidden');
            searchUsers();
        }

        function closeSearchUsers() {
            document.getElementById('search-users-modal').classList.add('hidden');
            document.getElementById('search-users-input').value = '';
        }

        async function searchUsers() {
            const query = document.getElementById('search-users-input').value.trim().toLowerCase();
            const container = document.getElementById('search-users-list');
            
            try {
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val() || {};
                
                const friendsSnapshot = await database.ref(`friends/${currentUser.code}`).once('value');
                const friends = friendsSnapshot.val() || {};
                
                const requestsSnapshot = await database.ref(`friendRequests`).once('value');
                const allRequests = requestsSnapshot.val() || {};
                
                const filteredUsers = Object.values(users)
                    .filter(u => u.code !== currentUser.code)
                    .filter(u => !friends[u.code])
                    .filter(u => !query || u.name.toLowerCase().includes(query));
                
                if (filteredUsers.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-slash"></i>
                            <p>لم يتم العثور على مستخدمين</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = filteredUsers.map(user => {
                    const sentRequest = allRequests[user.code] && 
                                       Object.values(allRequests[user.code]).some(r => r.from === currentUser.code && r.status === 'pending');
                    
                    return `
                        <div class="search-user-item">
                            <img class="search-user-avatar" src="${user.avatar || 'https://via.placeholder.com/50'}" alt="">
                            <div class="search-user-info">
                                <div class="search-user-name">${user.name}</div>
                            </div>
                            <button class="search-user-btn ${sentRequest ? 'requested' : ''}" 
                                    onclick='${sentRequest ? '' : `sendFriendRequest("${user.code}")`}'
                                    ${sentRequest ? 'disabled' : ''}>
                                ${sentRequest ? 'تم الإرسال' : 'إضافة'}
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error searching users:', error);
            }
        }

        // Friend Requests
        async function sendFriendRequest(toCode) {
            try {
                const requestId = database.ref(`friendRequests/${toCode}`).push().key;
                
                await database.ref(`friendRequests/${toCode}/${requestId}`).set({
                    id: requestId,
                    from: currentUser.code,
                    fromName: currentUser.name,
                    fromAvatar: currentUser.avatar,
                    to: toCode,
                    status: 'pending',
                    timestamp: Date.now()
                });
                
                searchUsers(); // Refresh list
                alert('تم إرسال طلب الصداقة');
            } catch (error) {
                console.error('Error sending friend request:', error);
                alert('فشل إرسال الطلب');
            }
        }

        async function loadFriendRequests() {
            const container = document.getElementById('requests-tab');
            
            try {
                const requestsSnapshot = await database.ref(`friendRequests/${currentUser.code}`).once('value');
                const requests = requestsSnapshot.val() || {};
                
                const pendingRequests = Object.values(requests).filter(r => r.status === 'pending');
                
                if (pendingRequests.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-clock"></i>
                            <p>لا توجد طلبات صداقة</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = pendingRequests.map(request => `
                    <div class="friend-request-item">
                        <img class="friend-request-avatar" src="${request.fromAvatar || 'https://via.placeholder.com/50'}" alt="">
                        <div class="friend-request-content">
                            <div class="friend-request-name">${request.fromName}</div>
                            <div class="friend-request-text">أرسل لك طلب صداقة</div>
                            <div class="friend-request-actions">
                                <button class="friend-request-btn accept" onclick='acceptFriendRequest("${request.id}", "${request.from}")'>قبول</button>
                                <button class="friend-request-btn reject" onclick='rejectFriendRequest("${request.id}")'>رفض</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        async function acceptFriendRequest(requestId, fromCode) {
            try {
                // Update request status
                await database.ref(`friendRequests/${currentUser.code}/${requestId}`).update({
                    status: 'accepted'
                });
                
                // Add to friends
                await database.ref(`friends/${currentUser.code}/${fromCode}`).set(true);
                await database.ref(`friends/${fromCode}/${currentUser.code}`).set(true);
                
                loadFriendRequests();
                loadChats();
            } catch (error) {
                console.error('Error accepting request:', error);
            }
        }

        async function rejectFriendRequest(requestId) {
            try {
                await database.ref(`friendRequests/${currentUser.code}/${requestId}`).update({
                    status: 'rejected'
                });
                
                loadFriendRequests();
            } catch (error) {
                console.error('Error rejecting request:', error);
            }
        }

        // Image Viewer
        function viewImage(url) {
            document.getElementById('viewer-image').src = url;
            document.getElementById('image-viewer').classList.remove('hidden');
        }

        function closeImageViewer() {
            document.getElementById('image-viewer').classList.add('hidden');
        }

        function downloadImage() {
            const url = document.getElementById('viewer-image').src;
            const a = document.createElement('a');
            a.href = url;
            a.download = 'image.jpg';
            a.click();
        }

        // QR Scanner
        function showQRScanner() {
            document.getElementById('qr-scanner').classList.remove('hidden');
            startCamera();
        }

        function closeQRScanner() {
            document.getElementById('qr-scanner').classList.add('hidden');
            stopCamera();
        }

        let cameraStream = null;

        async function startCamera() {
            try {
                const video = document.getElementById('scanner-video');
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                video.srcObject = cameraStream;
                video.play();
                
                // Note: You would need to integrate jsQR library here for actual QR code scanning
                // For now, this is just the UI
            } catch (error) {
                console.error('Camera error:', error);
                alert('فشل الوصول إلى الكاميرا');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        // Admin Functions
        async function createUser() {
            const name = document.getElementById('new-username').value.trim();
            const code = document.getElementById('new-usercode').value.trim().toUpperCase();
            const avatar = document.getElementById('new-useravatar').value.trim();
            const messageEl = document.getElementById('create-message');
            
            if (!name || !code) {
                messageEl.className = 'error-message';
                messageEl.textContent = 'الرجاء إدخال جميع البيانات';
                messageEl.classList.remove('hidden');
                return;
            }
            
            if (code.length < 5) {
                messageEl.className = 'error-message';
                messageEl.textContent = 'الكود يجب أن يكون 5 أحرف على الأقل';
                messageEl.classList.remove('hidden');
                return;
            }
            
            try {
                const userSnapshot = await database.ref(`users/${code}`).once('value');
                if (userSnapshot.exists()) {
                    messageEl.className = 'error-message';
                    messageEl.textContent = 'الكود مستخدم مسبقاً';
                    messageEl.classList.remove('hidden');
                    return;
                }
                
                await database.ref(`users/${code}`).set({
                    name: name,
                    code: code,
                    avatar: avatar || 'https://via.placeholder.com/50',
                    createdAt: Date.now(),
                    online: false,
                    blocked: false
                });
                
                messageEl.className = 'success-message';
                messageEl.textContent = 'تم إنشاء المستخدم بنجاح';
                messageEl.classList.remove('hidden');
                
                // Generate QR Code
                const qrContainer = document.getElementById('qr-display');
                qrContainer.innerHTML = '<h3>QR Code للمستخدم</h3>';
                qrContainer.classList.remove('hidden');
                
                new QRCode(qrContainer, {
                    text: code,
                    width: 250,
                    height: 250
                });
                
                // Clear inputs
                document.getElementById('new-username').value = '';
                document.getElementById('new-usercode').value = '';
                document.getElementById('new-useravatar').value = '';
            } catch (error) {
                console.error('Error creating user:', error);
                messageEl.className = 'error-message';
                messageEl.textContent = 'حدث خطأ، حاول مرة أخرى';
                messageEl.classList.remove('hidden');
            }
        }

        async function loadUsers() {
            const container = document.getElementById('admin-users');
            
            try {
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val() || {};
                
                const usersArray = Object.values(users);
                
                if (usersArray.length === 0) {
                    container.innerHTML = '<p>لا يوجد مستخدمين</p>';
                    return;
                }
                
                container.innerHTML = usersArray.map(user => `
                    <div class="user-card">
                        <img class="user-card-avatar" src="${user.avatar || 'https://via.placeholder.com/50'}" alt="">
                        <div class="user-card-info">
                            <div class="user-card-name">${user.name}</div>
                            <span class="user-card-code">${user.code}</span>
                        </div>
                        <div class="user-card-actions">
                            <button class="btn-icon btn-view" onclick='showUserQR("${user.code}")' title="عرض QR">
                                <i class="fas fa-qrcode"></i>
                            </button>
                            <button class="btn-icon btn-chat" onclick='chatWithUser(${JSON.stringify(user)})' title="دردشة">
                                <i class="fas fa-comment"></i>
                            </button>
                            <button class="btn-icon btn-block" onclick='toggleBlock("${user.code}", ${!user.blocked})' title="${user.blocked ? 'فك الحظر' : 'حظر'}">
                                <i class="fas fa-${user.blocked ? 'unlock' : 'ban'}"></i>
                            </button>
                            <button class="btn-icon btn-delete" onclick='deleteUser("${user.code}")' title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function showUserQR(code) {
            const qrContainer = document.createElement('div');
            qrContainer.className = 'modal';
            qrContainer.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>QR Code</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="qr-code-container" id="temp-qr"></div>
                        <p style="text-align: center; margin-top: 10px; font-family: monospace; font-size: 18px; font-weight: bold;">${code}</p>
                    </div>
                </div>
            `;
            document.body.appendChild(qrContainer);
            
            new QRCode(document.getElementById('temp-qr'), {
                text: code,
                width: 250,
                height: 250
            });
        }

        function chatWithUser(user) {
            currentUser = { code: 'ADMIN', name: 'المسؤول', avatar: 'https://via.placeholder.com/40', isAdmin: true };
            showChatScreen(user);
        }

        async function toggleBlock(code, block) {
            if (!confirm(`هل تريد ${block ? 'حظر' : 'فك حظر'} هذا المستخدم؟`)) return;
            
            try {
                await database.ref(`users/${code}`).update({ blocked: block });
                loadUsers();
            } catch (error) {
                console.error('Error toggling block:', error);
            }
        }

        async function deleteUser(code) {
            if (!confirm('هل تريد حذف هذا المستخدم نهائياً؟')) return;
            
            try {
                await database.ref(`users/${code}`).remove();
                loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
            }
        }

        async function loadConversations() {
            const container = document.getElementById('admin-conversations');
            
            try {
                const chatsSnapshot = await database.ref('chats').once('value');
                const chats = chatsSnapshot.val() || {};
                
                if (Object.keys(chats).length === 0) {
                    container.innerHTML = '<p>لا توجد محادثات</p>';
                    return;
                }
                
                const usersSnapshot = await database.ref('users').once('value');
                const users = usersSnapshot.val() || {};
                
                container.innerHTML = Object.keys(chats).map(chatId => {
                    const [code1, code2] = chatId.split('_');
                    const user1 = users[code1];
                    const user2 = users[code2];
                    
                    if (!user1 || !user2) return '';
                    
                    return `
                        <div class="user-card">
                            <img class="user-card-avatar" src="${user1.avatar || 'https://via.placeholder.com/50'}" alt="">
                            <div class="user-card-info">
                                <div class="user-card-name">${user1.name} ⟷ ${user2.name}</div>
                                <span class="user-card-code">${chatId}</span>
                            </div>
                            <button class="btn btn-primary" onclick='viewConversation("${chatId}", ${JSON.stringify(user1)}, ${JSON.stringify(user2)})'>
                                عرض المحادثة
                            </button>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading conversations:', error);
            }
        }

        function viewConversation(chatId, user1, user2) {
            alert(`عرض محادثة بين ${user1.name} و ${user2.name}\n(هذه الميزة قيد التطوير)`);
        }

        async function changeAdminCode() {
            const current = document.getElementById('current-admin-code').value.trim();
            const newCode = document.getElementById('new-admin-code').value.trim().toUpperCase();
            const messageEl = document.getElementById('settings-message');
            
            if (!current || !newCode) {
                messageEl.className = 'error-message';
                messageEl.textContent = 'الرجاء إدخال جميع البيانات';
                messageEl.classList.remove('hidden');
                return;
            }
            
            try {
                const adminCodeSnapshot = await database.ref('adminCode').once('value');
                const adminCode = adminCodeSnapshot.val() || 'ADMIN';
                
                if (current !== adminCode) {
                    messageEl.className = 'error-message';
                    messageEl.textContent = 'الكود الحالي غير صحيح';
                    messageEl.classList.remove('hidden');
                    return;
                }
                
                await database.ref('adminCode').set(newCode);
                
                messageEl.className = 'success-message';
                messageEl.textContent = 'تم تغيير الكود بنجاح';
                messageEl.classList.remove('hidden');
                
                document.getElementById('current-admin-code').value = '';
                document.getElementById('new-admin-code').value = '';
            } catch (error) {
                console.error('Error changing admin code:', error);
                messageEl.className = 'error-message';
                messageEl.textContent = 'حدث خطأ، حاول مرة أخرى';
                messageEl.classList.remove('hidden');
            }
        }

        function logout() {
            if (!confirm('هل تريد تسجيل الخروج؟')) return;
            
            currentUser = null;
            isAdmin = false;
            showGmail();
        }

        function openSettings() {
            alert('الإعدادات (قيد التطوير)');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update online status
        window.addEventListener('beforeunload', () => {
            if (currentUser && !currentUser.isAdmin) {
                database.ref(`users/${currentUser.code}`).update({
                    online: false,
                    lastSeen: Date.now()
                });
            }
        });

        // Keep connection alive
        if (currentUser && !currentUser.isAdmin) {
            setInterval(() => {
                database.ref(`users/${currentUser.code}/lastSeen`).set(Date.now());
            }, 60000);
        }
    </script>
</body>
</html>
