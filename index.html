<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail</title>
    <link rel="icon" href="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico" type="image/x-icon">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f0f2f5;
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* ==================== Gmail Fake Interface ==================== */
        #gmail-screen {
            background: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .gmail-header {
            background: linear-gradient(135deg, #c71610 0%, #d44638 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(199, 22, 16, 0.3);
            position: relative;
            z-index: 100;
        }

        .gmail-menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            margin-left: 15px;
            padding: 5px;
            transition: background 0.2s;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gmail-menu-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .gmail-search {
            flex: 1;
            margin: 0 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }

        .gmail-search:hover {
            background: rgba(255,255,255,0.25);
        }

        .gmail-search input {
            background: none;
            border: none;
            color: white;
            width: 100%;
            outline: none;
            font-size: 15px;
        }

        .gmail-search input::placeholder {
            color: rgba(255,255,255,0.9);
        }

        .gmail-search i {
            color: white;
            margin-left: 10px;
        }

        .gmail-profile-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            color: #c71610;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .gmail-profile-icon:hover {
            transform: scale(1.05);
        }

        .gmail-content {
            background: #f5f5f5;
            flex: 1;
            overflow-y: auto;
        }

        .email-category {
            background: #e8f0fe;
            padding: 8px 20px;
            font-weight: 500;
            color: #1967d2;
            border-bottom: 1px solid #d2e3fc;
        }

        .email-item {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            position: relative;
        }

        .email-item:hover {
            background: #f8f8f8;
            box-shadow: inset 3px 0 0 #c71610;
        }

        .email-item.unread {
            background: #f6f8fc;
            font-weight: 500;
        }

        .email-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c71610, #d44638);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-left: 15px;
            font-size: 16px;
            flex-shrink: 0;
        }

        .email-info {
            flex: 1;
            min-width: 0;
        }

        .email-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            align-items: center;
        }

        .email-sender {
            font-weight: 600;
            color: #202124;
            font-size: 14px;
        }

        .email-time {
            color: #5f6368;
            font-size: 12px;
            white-space: nowrap;
        }

        .email-subject {
            font-weight: 500;
            color: #202124;
            margin-bottom: 2px;
            font-size: 13px;
        }

        .email-preview {
            color: #5f6368;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .unread-badge {
            background: #c71610;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 8px;
        }

        /* Email Modal */
        .email-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .email-modal-content {
            background: white;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .email-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }

        .email-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #202124;
        }

        .email-modal-close {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #5f6368;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .email-modal-close:hover {
            background: #e8eaed;
        }

        .email-modal-body {
            padding: 25px;
        }

        .email-modal-from {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .email-modal-from-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c71610, #d44638);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-left: 15px;
            font-size: 20px;
        }

        .email-modal-from-info h3 {
            color: #202124;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .email-modal-from-info p {
            color: #5f6368;
            font-size: 13px;
        }

        .email-modal-text {
            color: #202124;
            line-height: 1.6;
            font-size: 14px;
        }

        /* ==================== Login Screen ==================== */
        #login-screen {
            background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        #login-screen::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: moveBackground 20s linear infinite;
        }

        @keyframes moveBackground {
            from { transform: translate(0, 0); }
            to { transform: translate(30px, 30px); }
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
            z-index: 1;
        }

        .login-logo {
            font-size: 60px;
            color: #128C7E;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 28px;
            font-weight: bold;
            color: #075E54;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #667781;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9edef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border 0.3s;
            text-align: center;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .login-input:focus {
            outline: none;
            border-color: #128C7E;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(7, 94, 84, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(7, 94, 84, 0.4);
        }

        .login-btn:active {
            transform: translateY(0);
        }

        .login-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f2f5;
            border-radius: 10px;
            font-size: 13px;
            color: #667781;
            text-align: right;
        }

        /* ==================== Main Chat Screen ==================== */
        #chat-screen {
            height: 100vh;
            display: flex;
            background: #f0f2f5;
        }

        /* Sidebar */
        .sidebar {
            width: 400px;
            background: white;
            border-left: 1px solid #e9edef;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: #f0f2f5;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            color: #111b21;
            font-size: 20px;
        }

        .sidebar-actions {
            display: flex;
            gap: 15px;
        }

        .sidebar-btn {
            background: transparent;
            border: none;
            color: #54656f;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .sidebar-btn:hover {
            background: #f0f2f5;
        }

        .sidebar-search {
            padding: 10px 15px;
            background: #f0f2f5;
        }

        .search-box {
            background: white;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-box i {
            color: #54656f;
        }

        .search-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 14px;
            color: #111b21;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #e9edef;
            transition: background 0.2s;
            position: relative;
        }

        .chat-item:hover {
            background: #f5f6f6;
        }

        .chat-item.active {
            background: #f0f2f5;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-left: 15px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .default-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #128C7E, #075E54);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            margin-left: 15px;
            flex-shrink: 0;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .chat-name {
            font-weight: 500;
            color: #111b21;
            font-size: 16px;
        }

        .chat-time {
            font-size: 12px;
            color: #667781;
        }

        .chat-last-message {
            color: #667781;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .unread-count {
            background: #25d366;
            color: white;
            border-radius: 12px;
            padding: 2px 7px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #efeae2;
        }

        .chat-area-header {
            background: #f0f2f5;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e9edef;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            cursor: pointer;
            flex: 1;
        }

        .chat-user-info:hover {
            opacity: 0.8;
        }

        .chat-actions {
            display: flex;
            gap: 15px;
        }

        .chat-action-btn {
            background: transparent;
            border: none;
            color: #54656f;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chat-action-btn:hover {
            background: #e9edef;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23efeae2" width="100" height="100"/><path fill="%23e1d9ce" d="M0 0L100 100M100 0L0 100" opacity="0.05"/></svg>');
            background-size: 100px 100px;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
            animation: messageSlide 0.3s;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 8px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.sent .message-bubble {
            background: #d9fdd3;
            border-bottom-left-radius: 2px;
        }

        .message.received .message-bubble {
            background: white;
            border-bottom-right-radius: 2px;
        }

        .message-text {
            color: #111b21;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .message-image {
            max-width: 100%;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 5px;
        }

        .message-audio {
            width: 100%;
            margin-bottom: 5px;
        }

        .message-meta {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5px;
            margin-top: 4px;
            font-size: 11px;
            color: #667781;
        }

        .message-time {
            font-size: 11px;
            color: #667781;
        }

        .message-status {
            color: #53bdeb;
            font-size: 16px;
        }

        .message-deleted {
            font-style: italic;
            color: #667781;
        }

        .message-options {
            position: absolute;
            top: -30px;
            left: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            gap: 5px;
            padding: 5px;
            z-index: 10;
        }

        .message-option-btn {
            background: transparent;
            border: none;
            color: #667781;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            transition: background 0.2s;
        }

        .message-option-btn:hover {
            background: #f5f6f6;
        }

        .message-option-btn.delete {
            color: #ea4335;
        }

        /* Input Area */
        .input-area {
            background: #f0f2f5;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-btn {
            background: transparent;
            border: none;
            color: #54656f;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .input-btn:hover {
            transform: scale(1.1);
        }

        .input-box {
            flex: 1;
            background: white;
            border-radius: 25px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-box input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 15px;
            color: #111b21;
        }

        .send-btn {
            background: #128C7E;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s;
        }

        .send-btn:hover {
            background: #075E54;
            transform: scale(1.05);
        }

        .send-btn:active {
            transform: scale(0.95);
        }

        /* Image Preview Modal */
        .image-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            z-index: 10001;
            animation: fadeIn 0.3s;
        }

        .preview-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.5);
        }

        .preview-title {
            color: white;
            font-size: 18px;
        }

        .preview-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }

        .preview-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .preview-images {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90%;
            overflow-y: auto;
        }

        .preview-image-item {
            position: relative;
            max-width: 300px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
        }

        .remove-preview-image {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,0,0,0.8);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-footer {
            padding: 20px;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .preview-input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 25px;
            padding: 12px 20px;
            color: white;
            font-size: 15px;
        }

        .preview-input::placeholder {
            color: rgba(255,255,255,0.6);
        }

        .preview-send-btn {
            background: #25d366;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .preview-send-btn:hover {
            background: #1da851;
            transform: scale(1.05);
        }

        /* Voice Recording */
        .recording-indicator {
            background: #ef4444;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .recording-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Profile Modal */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .profile-content {
            background: white;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        .profile-header {
            background: linear-gradient(135deg, #128C7E, #075E54);
            padding: 30px 20px;
            text-align: center;
            color: white;
            position: relative;
        }

        .profile-close {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            object-fit: cover;
            border: 4px solid white;
        }

        .profile-default-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 50px;
            margin: 0 auto 15px;
            border: 4px solid white;
        }

        .profile-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-code {
            font-size: 14px;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
        }

        .profile-body {
            padding: 20px;
        }

        .profile-section {
            margin-bottom: 20px;
        }

        .profile-section-title {
            font-size: 14px;
            color: #667781;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .profile-info {
            background: #f0f2f5;
            padding: 15px;
            border-radius: 8px;
            font-size: 15px;
            color: #111b21;
        }

        .profile-qr {
            text-align: center;
            background: #f0f2f5;
            padding: 20px;
            border-radius: 8px;
        }

        .profile-qr canvas {
            border: 4px solid white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Friend Requests */
        .friend-requests-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .friend-requests-content {
            background: white;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .friend-requests-header {
            padding: 20px;
            border-bottom: 1px solid #e9edef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .friend-requests-title {
            font-size: 20px;
            font-weight: bold;
            color: #111b21;
        }

        .friend-requests-close {
            background: transparent;
            border: none;
            color: #54656f;
            font-size: 24px;
            cursor: pointer;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .friend-requests-close:hover {
            background: #f0f2f5;
        }

        .friend-requests-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .friend-request-item {
            padding: 15px;
            border-bottom: 1px solid #e9edef;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .friend-request-info {
            flex: 1;
        }

        .friend-request-name {
            font-weight: 600;
            color: #111b21;
            margin-bottom: 4px;
        }

        .friend-request-code {
            font-size: 13px;
            color: #667781;
        }

        .friend-request-actions {
            display: flex;
            gap: 10px;
        }

        .accept-btn, .reject-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .accept-btn {
            background: #25d366;
            color: white;
        }

        .accept-btn:hover {
            background: #1da851;
        }

        .reject-btn {
            background: #f0f2f5;
            color: #667781;
        }

        .reject-btn:hover {
            background: #e9edef;
        }

        /* Search User Modal */
        .search-user-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s;
        }

        .search-user-content {
            background: white;
            border-radius: 12px;
            width: 450px;
            max-width: 90%;
            padding: 25px;
        }

        .search-user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .search-user-title {
            font-size: 20px;
            font-weight: bold;
            color: #111b21;
        }

        .search-user-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .search-tab {
            flex: 1;
            padding: 10px;
            background: #f0f2f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .search-tab.active {
            background: #128C7E;
            color: white;
        }

        .search-user-input-group {
            margin-bottom: 20px;
        }

        .search-user-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9edef;
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s;
        }

        .search-user-input:focus {
            outline: none;
            border-color: #128C7E;
        }

        .qr-scanner-container {
            background: #f0f2f5;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        #qr-reader {
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .search-result {
            background: #f0f2f5;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .search-result-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            object-fit: cover;
        }

        .search-result-default-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #128C7E, #075E54);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 35px;
            margin: 0 auto 15px;
        }

        .search-result-name {
            font-size: 20px;
            font-weight: bold;
            color: #111b21;
            margin-bottom: 8px;
        }

        .search-result-code {
            font-size: 14px;
            color: #667781;
            margin-bottom: 20px;
        }

        .add-friend-btn {
            background: #25d366;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .add-friend-btn:hover {
            background: #1da851;
            transform: scale(1.05);
        }

        .add-friend-btn:disabled {
            background: #e9edef;
            color: #667781;
            cursor: not-allowed;
            transform: none;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #667781;
        }

        .empty-state i {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #111b21;
        }

        /* No Chat Selected */
        .no-chat-selected {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f0f2f5;
            padding: 40px;
            text-align: center;
        }

        .no-chat-icon {
            font-size: 80px;
            color: #d9d9d9;
            margin-bottom: 20px;
        }

        .no-chat-title {
            font-size: 32px;
            color: #41525d;
            margin-bottom: 15px;
        }

        .no-chat-subtitle {
            font-size: 14px;
            color: #667781;
            line-height: 1.6;
            max-width: 500px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }

            .chat-area {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 100;
            }

            .message-bubble {
                max-width: 85%;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Gmail Fake Screen -->
    <div id="gmail-screen" class="hidden">
        <div class="gmail-header">
            <button class="gmail-menu-btn" onclick="showLoginScreen()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="gmail-search">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ®ÿ±ŸäÿØ" id="gmail-search-input">
            </div>
            <div class="gmail-profile-icon" onclick="showMyProfile()">
                <span id="gmail-profile-letter">G</span>
            </div>
        </div>
        <div class="gmail-content" id="gmail-emails">
            <!-- Emails will be populated here -->
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-comments"></i>
            </div>
            <h1 class="login-title">ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ!</h1>
            <p class="login-subtitle">ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ŸÑŸÑÿØÿÆŸàŸÑ</p>
            <input type="text" class="login-input" id="user-code-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ" maxlength="8">
            <button class="login-btn" onclick="loginUser()">ÿØÿÆŸàŸÑ</button>
            <div class="login-info">
                <p><strong>üí° ŸÖŸÑÿßÿ≠ÿ∏ÿ©:</strong> ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ Ÿáÿ∞Ÿá ÿ£ŸàŸÑ ŸÖÿ±ÿ© ÿ™ÿØÿÆŸÑ ŸÅŸäŸáÿßÿå ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ ŸÑŸÉ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã</p>
            </div>
        </div>
    </div>

    <!-- Main Chat Screen -->
    <div id="chat-screen" class="hidden">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ</h2>
                <div class="sidebar-actions">
                    <button class="sidebar-btn" onclick="showFriendRequests()" title="ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿµÿØÿßŸÇÿ©">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <button class="sidebar-btn" onclick="showSearchUserModal()" title="ÿ•ÿ∂ÿßŸÅÿ© ÿµÿØŸäŸÇ">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="sidebar-btn" onclick="showMyProfile()" title="ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <button class="sidebar-btn" onclick="showGmailScreen()" title="Ÿàÿßÿ¨Ÿáÿ© Gmail">
                        <i class="fas fa-envelope"></i>
                    </button>
                </div>
            </div>
            <div class="sidebar-search">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="ÿ®ÿ≠ÿ´ ÿ£Ÿà ÿ®ÿØÿ° ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ©">
                </div>
            </div>
            <div class="chats-list" id="chats-list">
                <!-- Chats will be populated here -->
            </div>
        </div>

        <div class="no-chat-selected" id="no-chat-selected">
            <div class="no-chat-icon">
                <i class="fas fa-comments"></i>
            </div>
            <h2 class="no-chat-title">ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™</h2>
            <p class="no-chat-subtitle">
                ÿ£ÿ±ÿ≥ŸÑ Ÿàÿßÿ≥ÿ™ŸÇÿ®ŸÑ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ÿ®ÿØŸàŸÜ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ÿπŸÑŸâ Ÿáÿßÿ™ŸÅŸÉ ÿßŸÑŸÖÿ≠ŸÖŸàŸÑ.<br>
                ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ <i class="fas fa-search"></i> ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ÿµÿØŸÇÿßÿ° ÿ¨ÿØÿØ.
            </p>
        </div>

        <div class="chat-area hidden" id="chat-area">
            <div class="chat-area-header">
                <div class="chat-user-info" onclick="showUserProfile(currentChatUser)">
                    <img id="current-chat-avatar" class="chat-avatar" style="display: none;">
                    <div id="current-chat-default-avatar" class="default-avatar"></div>
                    <div>
                        <div class="chat-name" id="current-chat-name"></div>
                        <div class="chat-time" style="font-size: 12px;">ŸÖÿ™ÿµŸÑ ÿßŸÑÿ¢ŸÜ</div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="chat-action-btn">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="chat-action-btn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>

            <div class="messages-container" id="messages-container">
                <!-- Messages will be populated here -->
            </div>

            <div class="input-area">
                <button class="input-btn" onclick="document.getElementById('emoji-picker').classList.toggle('hidden')">
                    <i class="fas fa-smile"></i>
                </button>
                <button class="input-btn" onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="file-input" accept="image/*" multiple style="display: none;">
                <div class="input-box" id="input-box">
                    <input type="text" id="message-input" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©">
                    <button class="input-btn" onclick="startRecording()" id="mic-btn">
                        <i class="fas fa-microphone"></i>
                    </button>
                </div>
                <button class="send-btn hidden" id="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Global Variables
        let currentUser = null;
        let currentChatUser = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let selectedImages = [];

        // Initialize App
        window.onload = function() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showGmailScreen();
            } else {
                showLoginScreen();
            }
        };

        // Login Function
        function loginUser() {
            const codeInput = document.getElementById('user-code-input');
            const code = codeInput.value.trim().toUpperCase();

            if (code.length < 4) {
                alert('ÿßŸÑŸÉŸàÿØ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 4 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }

            // Check if user exists
            database.ref('users/' + code).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    // User exists
                    currentUser = snapshot.val();
                    currentUser.code = code;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showGmailScreen();
                } else {
                    // Create new user
                    const newUser = {
                        name: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ' + code,
                        code: code,
                        avatar: '',
                        createdAt: Date.now(),
                        friends: {},
                        friendRequests: {}
                    };

                    database.ref('users/' + code).set(newUser).then(() => {
                        currentUser = newUser;
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        alert('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ ÿ®ŸÜÿ¨ÿßÿ≠! üéâ');
                        showGmailScreen();
                    });
                }
            });
        }

        function showLoginScreen() {
            document.getElementById('gmail-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function showGmailScreen() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.add('hidden');
            document.getElementById('gmail-screen').classList.remove('hidden');
            
            // Update profile letter
            if (currentUser) {
                document.getElementById('gmail-profile-letter').textContent = currentUser.name.charAt(0);
                loadFakeEmails();
                loadFriendRequests();
            }
        }

        function showChatScreen() {
            document.getElementById('gmail-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');
            loadChats();
        }

        // Load Fake Gmail Emails
        function loadFakeEmails() {
            const fakeEmails = [
                { sender: 'Facebook', subject: 'ŸÑÿØŸäŸÉ ÿ•ÿ¥ÿπÿßÿ± ÿ¨ÿØŸäÿØ', preview: 'ÿ£ÿ≠ŸÖÿØ ÿπŸÑŸä ÿ£ÿπÿ¨ÿ® ÿ®ŸÖŸÜÿ¥Ÿàÿ±ŸÉ', time: 'ŸÇÿ®ŸÑ ÿ≥ÿßÿπÿ©', unread: true },
                { sender: 'Instagram', subject: 'ŸÖÿ™ÿßÿ®ÿπ ÿ¨ÿØŸäÿØ', preview: 'ŸÖÿ≠ŸÖÿØ ÿ≥ÿπÿØ ÿ®ÿØÿ£ ÿ®ŸÖÿ™ÿßÿ®ÿπÿ™ŸÉ', time: 'ŸÇÿ®ŸÑ ÿ≥ÿßÿπÿ™ŸäŸÜ', unread: true },
                { sender: 'YouTube', subject: 'ŸÅŸäÿØŸäŸà ÿ¨ÿØŸäÿØ', preview: 'ŸÇŸÜÿßÿ™ŸÉ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ© ŸÜÿ¥ÿ±ÿ™ ŸÅŸäÿØŸäŸà ÿ¨ÿØŸäÿØ', time: 'ŸÇÿ®ŸÑ 3 ÿ≥ÿßÿπÿßÿ™', unread: false },
                { sender: 'Twitter', subject: 'ÿ•ÿ¥ÿπÿßÿ±', preview: 'ÿπŸÑŸä ÿ≠ÿ≥ŸÜ ÿ£ÿπÿßÿØ ÿ™ÿ∫ÿ±ŸäÿØ ÿ™ÿ∫ÿ±ŸäÿØÿ™ŸÉ', time: 'ÿ£ŸÖÿ≥', unread: false },
                { sender: 'LinkedIn', subject: 'ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä', preview: 'ÿ¥ÿÆÿµ ŸÖÿß ÿ¥ÿßŸáÿØ ŸÖŸÑŸÅŸÉ ÿßŸÑÿ¥ÿÆÿµŸä', time: 'ÿ£ŸÖÿ≥', unread: false }
            ];

            const emailsContainer = document.getElementById('gmail-emails');
            emailsContainer.innerHTML = '<div class="email-category">ÿßŸÑŸàÿßÿ±ÿØ</div>';

            fakeEmails.forEach((email, index) => {
                const emailDiv = document.createElement('div');
                emailDiv.className = 'email-item' + (email.unread ? ' unread' : '');
                emailDiv.innerHTML = `
                    <div class="email-avatar">${email.sender.charAt(0)}</div>
                    <div class="email-info">
                        <div class="email-header">
                            <span class="email-sender">${email.sender}</span>
                            <span class="email-time">${email.time}</span>
                        </div>
                        <div class="email-subject">${email.subject}</div>
                        <div class="email-preview">${email.preview}</div>
                    </div>
                    ${email.unread ? '<span class="unread-badge">ÿ¨ÿØŸäÿØ</span>' : ''}
                `;
                emailDiv.onclick = () => showEmailModal(email);
                emailsContainer.appendChild(emailDiv);
            });
        }

        function showEmailModal(email) {
            const modal = document.createElement('div');
            modal.className = 'email-modal';
            modal.innerHTML = `
                <div class="email-modal-content">
                    <div class="email-modal-header">
                        <div class="email-modal-title">${email.subject}</div>
                        <button class="email-modal-close" onclick="this.closest('.email-modal').remove()">√ó</button>
                    </div>
                    <div class="email-modal-body">
                        <div class="email-modal-from">
                            <div class="email-modal-from-avatar">${email.sender.charAt(0)}</div>
                            <div class="email-modal-from-info">
                                <h3>${email.sender}</h3>
                                <p>${email.time}</p>
                            </div>
                        </div>
                        <div class="email-modal-text">
                            ${email.preview}<br><br>
                            Ÿáÿ∞Ÿá ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸÖŸÜ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ÿßŸÑŸÖÿ™ÿÆŸÅŸä.<br>
                            ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ÿå ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÅŸä ÿßŸÑÿ£ÿπŸÑŸâ.
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Load Chats
        function loadChats() {
            const chatsList = document.getElementById('chats-list');
            chatsList.innerHTML = '';

            if (!currentUser || !currentUser.friends) {
                chatsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <h3>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ° ÿ®ÿπÿØ</h3>
                        <p>ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ÿµÿØŸÇÿßÿ° ÿ¨ÿØÿØ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ≤ÿ± ÿßŸÑÿ®ÿ≠ÿ´</p>
                    </div>
                `;
                return;
            }

            Object.keys(currentUser.friends).forEach(friendCode => {
                database.ref('users/' + friendCode).once('value', (snapshot) => {
                    if (snapshot.exists()) {
                        const friend = snapshot.val();
                        const chatDiv = document.createElement('div');
                        chatDiv.className = 'chat-item';
                        
                        const avatarHTML = friend.avatar ? 
                            `<img src="${friend.avatar}" class="chat-avatar">` :
                            `<div class="default-avatar">${friend.name.charAt(0)}</div>`;
                        
                        chatDiv.innerHTML = `
                            ${avatarHTML}
                            <div class="chat-info">
                                <div class="chat-header">
                                    <div class="chat-name">${friend.name}</div>
                                    <div class="chat-time">ÿßŸÑÿ¢ŸÜ</div>
                                </div>
                                <div class="chat-last-message">ÿßŸÜŸÇÿ± ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©</div>
                            </div>
                        `;
                        chatDiv.onclick = () => openChat(friend);
                        chatsList.appendChild(chatDiv);
                    }
                });
            });
        }

        // Open Chat
        function openChat(friend) {
            currentChatUser = friend;
            document.getElementById('no-chat-selected').classList.add('hidden');
            document.getElementById('chat-area').classList.remove('hidden');
            
            document.getElementById('current-chat-name').textContent = friend.name;
            
            if (friend.avatar) {
                document.getElementById('current-chat-avatar').src = friend.avatar;
                document.getElementById('current-chat-avatar').style.display = 'block';
                document.getElementById('current-chat-default-avatar').style.display = 'none';
            } else {
                document.getElementById('current-chat-default-avatar').textContent = friend.name.charAt(0);
                document.getElementById('current-chat-avatar').style.display = 'none';
                document.getElementById('current-chat-default-avatar').style.display = 'flex';
            }

            loadMessages(friend.code);
        }

        // Load Messages
        function loadMessages(friendCode) {
            const messagesContainer = document.getElementById('messages-container');
            messagesContainer.innerHTML = '';

            const chatId = [currentUser.code, friendCode].sort().join('_');
            
            database.ref('chats/' + chatId + '/messages').on('value', (snapshot) => {
                messagesContainer.innerHTML = '';
                
                if (snapshot.exists()) {
                    const messages = snapshot.val();
                    Object.keys(messages).forEach(messageId => {
                        const message = messages[messageId];
                        displayMessage(message);
                    });
                }
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        // Display Message
        function displayMessage(message) {
            const messagesContainer = document.getElementById('messages-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ' + (message.senderId === currentUser.code ? 'sent' : 'received');
            messageDiv.setAttribute('data-message-id', message.id);

            let content = '';
            
            if (message.deleted) {
                content = '<div class="message-bubble"><div class="message-text message-deleted">üö´ ÿ™ŸÖ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©</div></div>';
            } else {
                if (message.type === 'text') {
                    content = `
                        <div class="message-bubble">
                            <div class="message-text">${message.text}</div>
                            <div class="message-meta">
                                <span class="message-time">${formatTime(message.timestamp)}</span>
                                ${message.senderId === currentUser.code ? '<i class="fas fa-check-double message-status"></i>' : ''}
                            </div>
                        </div>
                    `;
                } else if (message.type === 'image') {
                    content = `
                        <div class="message-bubble">
                            <img src="${message.imageUrl}" class="message-image" onclick="viewImage('${message.imageUrl}')">
                            ${message.text ? `<div class="message-text">${message.text}</div>` : ''}
                            <div class="message-meta">
                                <span class="message-time">${formatTime(message.timestamp)}</span>
                                ${message.senderId === currentUser.code ? '<i class="fas fa-check-double message-status"></i>' : ''}
                            </div>
                        </div>
                    `;
                } else if (message.type === 'audio') {
                    content = `
                        <div class="message-bubble">
                            <audio controls class="message-audio" src="${message.audioUrl}"></audio>
                            <div class="message-meta">
                                <span class="message-time">${formatTime(message.timestamp)}</span>
                                ${message.senderId === currentUser.code ? '<i class="fas fa-check-double message-status"></i>' : ''}
                            </div>
                        </div>
                    `;
                }
            }

            messageDiv.innerHTML = content;
            
            if (!message.deleted && message.senderId === currentUser.code) {
                messageDiv.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showMessageOptions(e, message);
                });
            }

            messagesContainer.appendChild(messageDiv);
        }

        // Show Message Options
        function showMessageOptions(event, message) {
            // Remove existing options
            document.querySelectorAll('.message-options').forEach(el => el.remove());

            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'message-options';
            optionsDiv.innerHTML = `
                <button class="message-option-btn delete" onclick="deleteMessage('${message.id}')">
                    <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ
                </button>
            `;

            const messageDiv = event.currentTarget;
            messageDiv.style.position = 'relative';
            messageDiv.appendChild(optionsDiv);

            // Remove options when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', function removeOptions(e) {
                    if (!optionsDiv.contains(e.target)) {
                        optionsDiv.remove();
                        document.removeEventListener('click', removeOptions);
                    }
                }, { once: false });
            }, 100);
        }

        // Delete Message
        function deleteMessage(messageId) {
            if (!confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©ÿü')) return;

            const chatId = [currentUser.code, currentChatUser.code].sort().join('_');
            database.ref('chats/' + chatId + '/messages/' + messageId).update({
                deleted: true,
                text: ''
            });

            document.querySelectorAll('.message-options').forEach(el => el.remove());
        }

        // Send Message
        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();

            if (!text || !currentChatUser) return;

            const chatId = [currentUser.code, currentChatUser.code].sort().join('_');
            const messageId = 'msg_' + Date.now();

            const message = {
                id: messageId,
                senderId: currentUser.code,
                receiverId: currentChatUser.code,
                type: 'text',
                text: text,
                timestamp: Date.now(),
                deleted: false
            };

            database.ref('chats/' + chatId + '/messages/' + messageId).set(message);
            input.value = '';
            toggleSendButton();
        }

        // Toggle Send Button
        const messageInput = document.getElementById('message-input');
        messageInput.addEventListener('input', toggleSendButton);

        function toggleSendButton() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const micBtn = document.getElementById('mic-btn');

            if (input.value.trim()) {
                sendBtn.classList.remove('hidden');
                micBtn.classList.add('hidden');
            } else {
                sendBtn.classList.add('hidden');
                micBtn.classList.remove('hidden');
            }
        }

        // Handle Enter Key
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // File Input Handler
        document.getElementById('file-input').addEventListener('change', (e) => {
            selectedImages = Array.from(e.target.files);
            if (selectedImages.length > 0) {
                showImagePreview();
            }
        });

        // Show Image Preview
        function showImagePreview() {
            const modal = document.createElement('div');
            modal.className = 'image-preview-modal';
            
            let imagesHTML = '';
            selectedImages.forEach((file, index) => {
                const url = URL.createObjectURL(file);
                imagesHTML += `
                    <div class="preview-image-item">
                        <img src="${url}" class="preview-image">
                        <button class="remove-preview-image" onclick="removePreviewImage(${index})">√ó</button>
                    </div>
                `;
            });

            modal.innerHTML = `
                <div class="preview-header">
                    <div class="preview-title">ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿµŸàÿ± (${selectedImages.length})</div>
                    <button class="preview-close" onclick="closeImagePreview()">√ó</button>
                </div>
                <div class="preview-content">
                    <div class="preview-images">${imagesHTML}</div>
                </div>
                <div class="preview-footer">
                    <input type="text" class="preview-input" id="preview-caption" placeholder="ÿ£ÿ∂ŸÅ ÿ™ÿπŸÑŸäŸÇ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)">
                    <button class="preview-send-btn" onclick="sendImages()">
                        <i class="fas fa-paper-plane"></i> ÿ•ÿ±ÿ≥ÿßŸÑ
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function removePreviewImage(index) {
            selectedImages.splice(index, 1);
            if (selectedImages.length === 0) {
                closeImagePreview();
            } else {
                document.querySelector('.image-preview-modal').remove();
                showImagePreview();
            }
        }

        function closeImagePreview() {
            document.querySelector('.image-preview-modal')?.remove();
            selectedImages = [];
            document.getElementById('file-input').value = '';
        }

        function sendImages() {
            const caption = document.getElementById('preview-caption').value.trim();
            const chatId = [currentUser.code, currentChatUser.code].sort().join('_');

            selectedImages.forEach((file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const messageId = 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    const message = {
                        id: messageId,
                        senderId: currentUser.code,
                        receiverId: currentChatUser.code,
                        type: 'image',
                        imageUrl: e.target.result,
                        text: caption,
                        timestamp: Date.now(),
                        deleted: false
                    };

                    database.ref('chats/' + chatId + '/messages/' + messageId).set(message);
                };
                reader.readAsDataURL(file);
            });

            closeImagePreview();
        }

        // Voice Recording
        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });

                    mediaRecorder.addEventListener('stop', () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            sendAudioMessage(e.target.result);
                        };
                        reader.readAsDataURL(audioBlob);
                    });

                    mediaRecorder.start();
                    showRecordingUI();
                })
                .catch(err => {
                    alert('ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ: ' + err.message);
                });
        }

        function showRecordingUI() {
            const inputBox = document.getElementById('input-box');
            inputBox.innerHTML = `
                <div class="recording-indicator">
                    <div class="recording-dot"></div>
                    <span>ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ...</span>
                </div>
                <button class="input-btn" onclick="stopRecording()" style="color: #ef4444;">
                    <i class="fas fa-stop"></i>
                </button>
            `;
            document.getElementById('send-btn').classList.remove('hidden');
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                resetInputUI();
            }
        }

        function resetInputUI() {
            const inputBox = document.getElementById('input-box');
            inputBox.innerHTML = `
                <input type="text" id="message-input" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©">
                <button class="input-btn" onclick="startRecording()" id="mic-btn">
                    <i class="fas fa-microphone"></i>
                </button>
            `;
            document.getElementById('message-input').addEventListener('input', toggleSendButton);
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            document.getElementById('send-btn').classList.add('hidden');
        }

        function sendAudioMessage(audioData) {
            const chatId = [currentUser.code, currentChatUser.code].sort().join('_');
            const messageId = 'msg_' + Date.now();

            const message = {
                id: messageId,
                senderId: currentUser.code,
                receiverId: currentChatUser.code,
                type: 'audio',
                audioUrl: audioData,
                timestamp: Date.now(),
                deleted: false
            };

            database.ref('chats/' + chatId + '/messages/' + messageId).set(message);
        }

        // Profile Functions
        function showMyProfile() {
            showUserProfile(currentUser);
        }

        function showUserProfile(user) {
            const modal = document.createElement('div');
            modal.className = 'profile-modal';
            
            const avatarHTML = user.avatar ? 
                `<img src="${user.avatar}" class="profile-avatar-large">` :
                `<div class="profile-default-avatar">${user.name.charAt(0)}</div>`;
            
            modal.innerHTML = `
                <div class="profile-content">
                    <div class="profile-header">
                        <button class="profile-close" onclick="this.closest('.profile-modal').remove()">√ó</button>
                        ${avatarHTML}
                        <div class="profile-name">${user.name}</div>
                        <div class="profile-code">ÿßŸÑŸÉŸàÿØ: ${user.code}</div>
                    </div>
                    <div class="profile-body">
                        <div class="profile-section">
                            <div class="profile-section-title">ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ≥ÿßÿ®</div>
                            <div class="profile-info">
                                <p><strong>ÿßŸÑÿßÿ≥ŸÖ:</strong> ${user.name}</p>
                                <p><strong>ÿßŸÑŸÉŸàÿØ:</strong> ${user.code}</p>
                                <p><strong>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ°:</strong> ${formatDate(user.createdAt)}</p>
                            </div>
                        </div>
                        ${user.code === currentUser.code ? `
                        <div class="profile-section">
                            <div class="profile-section-title">ÿ±ŸÖÿ≤ QR ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ</div>
                            <div class="profile-qr">
                                <canvas id="profile-qr-code"></canvas>
                                <p style="margin-top: 15px; color: #667781; font-size: 13px;">
                                    ÿ¥ÿßÿ±ŸÉ Ÿáÿ∞ÿß ÿßŸÑÿ±ŸÖÿ≤ ŸÖÿπ ÿ£ÿµÿØŸÇÿßÿ¶ŸÉ ŸÑÿ•ÿ∂ÿßŸÅÿ™ŸÉ
                                </p>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Generate QR Code
            if (user.code === currentUser.code) {
                setTimeout(() => {
                    const canvas = document.getElementById('profile-qr-code');
                    if (canvas) {
                        QRCode.toCanvas(canvas, user.code, {
                            width: 200,
                            margin: 2,
                            color: {
                                dark: '#000000',
                                light: '#ffffff'
                            }
                        });
                    }
                }, 100);
            }
        }

        // Friend Requests
        function loadFriendRequests() {
            if (!currentUser) return;

            database.ref('users/' + currentUser.code + '/friendRequests').on('value', (snapshot) => {
                const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                // Update badge if needed
            });
        }

        function showFriendRequests() {
            const modal = document.createElement('div');
            modal.className = 'friend-requests-modal';
            
            modal.innerHTML = `
                <div class="friend-requests-content">
                    <div class="friend-requests-header">
                        <div class="friend-requests-title">ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿµÿØÿßŸÇÿ©</div>
                        <button class="friend-requests-close" onclick="this.closest('.friend-requests-modal').remove()">√ó</button>
                    </div>
                    <div class="friend-requests-list" id="friend-requests-list">
                        <div class="empty-state">
                            <i class="fas fa-user-plus"></i>
                            <h3>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™</h3>
                            <p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿµÿØÿßŸÇÿ© ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ÿßŸÑŸä</p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            database.ref('users/' + currentUser.code + '/friendRequests').once('value', (snapshot) => {
                const requestsList = document.getElementById('friend-requests-list');
                
                if (snapshot.exists()) {
                    requestsList.innerHTML = '';
                    const requests = snapshot.val();
                    
                    Object.keys(requests).forEach(requesterCode => {
                        database.ref('users/' + requesterCode).once('value', (userSnapshot) => {
                            if (userSnapshot.exists()) {
                                const requester = userSnapshot.val();
                                const requestDiv = document.createElement('div');
                                requestDiv.className = 'friend-request-item';
                                
                                const avatarHTML = requester.avatar ? 
                                    `<img src="${requester.avatar}" class="chat-avatar">` :
                                    `<div class="default-avatar">${requester.name.charAt(0)}</div>`;
                                
                                requestDiv.innerHTML = `
                                    ${avatarHTML}
                                    <div class="friend-request-info">
                                        <div class="friend-request-name">${requester.name}</div>
                                        <div class="friend-request-code">ÿßŸÑŸÉŸàÿØ: ${requesterCode}</div>
                                    </div>
                                    <div class="friend-request-actions">
                                        <button class="accept-btn" onclick="acceptFriendRequest('${requesterCode}')">ŸÇÿ®ŸàŸÑ</button>
                                        <button class="reject-btn" onclick="rejectFriendRequest('${requesterCode}')">ÿ±ŸÅÿ∂</button>
                                    </div>
                                `;
                                
                                requestsList.appendChild(requestDiv);
                            }
                        });
                    });
                }
            });
        }

        function acceptFriendRequest(requesterCode) {
            // Add to friends
            database.ref('users/' + currentUser.code + '/friends/' + requesterCode).set(true);
            database.ref('users/' + requesterCode + '/friends/' + currentUser.code).set(true);

            // Remove from requests
            database.ref('users/' + currentUser.code + '/friendRequests/' + requesterCode).remove();

            document.querySelector('.friend-requests-modal').remove();
            loadChats();
            alert('ÿ™ŸÖ ŸÇÿ®ŸàŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©! üéâ');
        }

        function rejectFriendRequest(requesterCode) {
            database.ref('users/' + currentUser.code + '/friendRequests/' + requesterCode).remove();
            document.querySelector('.friend-requests-modal').remove();
        }

        // Search User Modal
        function showSearchUserModal() {
            const modal = document.createElement('div');
            modal.className = 'search-user-modal';
            
            modal.innerHTML = `
                <div class="search-user-content">
                    <div class="search-user-header">
                        <div class="search-user-title">ÿ•ÿ∂ÿßŸÅÿ© ÿµÿØŸäŸÇ</div>
                        <button class="friend-requests-close" onclick="this.closest('.search-user-modal').remove()">√ó</button>
                    </div>
                    <div class="search-user-tabs">
                        <button class="search-tab active" onclick="switchSearchTab('code')">
                            <i class="fas fa-keyboard"></i> ÿßŸÑÿ®ÿ≠ÿ´ ÿ®ÿßŸÑŸÉŸàÿØ
                        </button>
                        <button class="search-tab" onclick="switchSearchTab('qr')">
                            <i class="fas fa-qrcode"></i> ŸÖÿ≥ÿ≠ QR
                        </button>
                    </div>
                    <div id="search-by-code">
                        <div class="search-user-input-group">
                            <input type="text" class="search-user-input" id="search-code-input" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">
                        </div>
                        <button class="add-friend-btn" onclick="searchUserByCode()">
                            <i class="fas fa-search"></i> ÿ®ÿ≠ÿ´
                        </button>
                    </div>
                    <div id="search-by-qr" class="hidden">
                        <div class="qr-scanner-container">
                            <div id="qr-reader"></div>
                            <button class="add-friend-btn" onclick="startQRScanner()">
                                <i class="fas fa-camera"></i> ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß
                            </button>
                        </div>
                    </div>
                    <div id="search-result" class="hidden"></div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function switchSearchTab(tab) {
            document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
            event.target.closest('.search-tab').classList.add('active');

            if (tab === 'code') {
                document.getElementById('search-by-code').classList.remove('hidden');
                document.getElementById('search-by-qr').classList.add('hidden');
            } else {
                document.getElementById('search-by-code').classList.add('hidden');
                document.getElementById('search-by-qr').classList.remove('hidden');
            }
        }

        function searchUserByCode() {
            const code = document.getElementById('search-code-input').value.trim().toUpperCase();
            
            if (!code) {
                alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÉŸàÿØ');
                return;
            }

            if (code === currentUser.code) {
                alert('ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÅÿ≥ŸÉ!');
                return;
            }

            database.ref('users/' + code).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    const user = snapshot.val();
                    displaySearchResult(user, code);
                } else {
                    alert('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                }
            });
        }

        function displaySearchResult(user, code) {
            const resultDiv = document.getElementById('search-result');
            
            const avatarHTML = user.avatar ? 
                `<img src="${user.avatar}" class="search-result-avatar">` :
                `<div class="search-result-default-avatar">${user.name.charAt(0)}</div>`;
            
            // Check if already friends
            const isFriend = currentUser.friends && currentUser.friends[code];
            const hasSentRequest = user.friendRequests && user.friendRequests[currentUser.code];

            let buttonHTML = '';
            if (isFriend) {
                buttonHTML = '<button class="add-friend-btn" disabled>ÿ£ŸÜÿ™ ÿ£ÿµÿØŸÇÿßÿ° ÿ®ÿßŸÑŸÅÿπŸÑ</button>';
            } else if (hasSentRequest) {
                buttonHTML = '<button class="add-friend-btn" disabled>ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®</button>';
            } else {
                buttonHTML = `<button class="add-friend-btn" onclick="sendFriendRequest('${code}')">
                    <i class="fas fa-user-plus"></i> ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿµÿØÿßŸÇÿ©
                </button>`;
            }

            resultDiv.innerHTML = `
                <div class="search-result">
                    ${avatarHTML}
                    <div class="search-result-name">${user.name}</div>
                    <div class="search-result-code">ÿßŸÑŸÉŸàÿØ: ${code}</div>
                    ${buttonHTML}
                </div>
            `;

            resultDiv.classList.remove('hidden');
        }

        function sendFriendRequest(recipientCode) {
            database.ref('users/' + recipientCode + '/friendRequests/' + currentUser.code).set(true)
                .then(() => {
                    alert('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑÿµÿØÿßŸÇÿ©! ‚úÖ');
                    document.querySelector('.search-user-modal').remove();
                })
                .catch(error => {
                    alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + error.message);
                });
        }

        function startQRScanner() {
            const qrReader = document.getElementById('qr-reader');
            
            const html5QrCode = new Html5Qrcode("qr-reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    html5QrCode.stop();
                    searchUserByCode();
                    document.getElementById('search-code-input').value = decodedText;
                    switchSearchTab('code');
                    searchUserByCode();
                }
            ).catch(err => {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß: ' + err);
            });
        }

        // Utility Functions
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('ar-EG');
        }

        function viewImage(url) {
            const modal = document.createElement('div');
            modal.className = 'image-preview-modal';
            modal.innerHTML = `
                <div class="preview-header">
                    <button class="preview-close" onclick="this.closest('.image-preview-modal').remove()">√ó</button>
                </div>
                <div class="preview-content">
                    <img src="${url}" style="max-width: 90%; max-height: 80vh; border-radius: 8px;">
                </div>
            `;
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
            document.body.appendChild(modal);
        }

        // Gmail Search Implementation
        document.getElementById('gmail-search-input').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const emails = document.querySelectorAll('.email-item');
            
            emails.forEach(email => {
                const text = email.textContent.toLowerCase();
                email.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        });
    </script>
</body>
</html>