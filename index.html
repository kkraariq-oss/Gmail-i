<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail</title>
    <link rel="icon" href="https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase v9 -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, update, remove, onValue, push, child } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBxXxXxXxXxXxXxXxXxXxXxXxXxXxXxXxX",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abc123def456"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Make database available globally
        window.firebaseDB = {
            database,
            ref,
            set,
            get,
            update,
            remove,
            onValue,
            push,
            child
        };
        
        console.log('‚úÖ Firebase initialized successfully');
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f0f2f5;
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }

        /* Loading Screen */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: white;
            font-size: 18px;
            margin-top: 20px;
            font-weight: 500;
        }

        /* Gmail Screen */
        #gmail-screen {
            background: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .gmail-header {
            background: linear-gradient(135deg, #c71610 0%, #d44638 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(199, 22, 16, 0.3);
        }

        .gmail-menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            margin-left: 15px;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }

        .gmail-menu-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .gmail-search {
            flex: 1;
            margin: 0 15px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
        }

        .gmail-search input {
            background: none;
            border: none;
            color: white;
            width: 100%;
            outline: none;
            font-size: 15px;
        }

        .gmail-search input::placeholder {
            color: rgba(255,255,255,0.9);
        }

        .gmail-profile-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: white;
            color: #c71610;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
        }

        .gmail-content {
            flex: 1;
            overflow-y: auto;
            background: #f5f5f5;
        }

        .email-item {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }

        .email-item:hover {
            background: #f8f8f8;
        }

        .email-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #c71610, #d44638);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-left: 15px;
        }

        .email-info {
            flex: 1;
        }

        .email-sender {
            font-weight: 600;
            color: #202124;
            margin-bottom: 4px;
        }

        .email-subject {
            color: #5f6368;
            font-size: 14px;
        }

        /* Login Screen */
        #login-screen {
            background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-logo {
            font-size: 60px;
            color: #128C7E;
            margin-bottom: 20px;
        }

        .login-title {
            font-size: 28px;
            font-weight: bold;
            color: #075E54;
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: #667781;
            margin-bottom: 30px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9edef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
            letter-spacing: 2px;
            font-weight: bold;
        }

        .login-input:focus {
            outline: none;
            border-color: #128C7E;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #128C7E 0%, #075E54 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        /* Chat Screen */
        #chat-screen {
            height: 100vh;
            display: flex;
            background: #f0f2f5;
        }

        .sidebar {
            width: 400px;
            background: white;
            border-left: 1px solid #e9edef;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: #f0f2f5;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            color: #111b21;
            font-size: 20px;
        }

        .sidebar-actions {
            display: flex;
            gap: 15px;
        }

        .sidebar-btn {
            background: transparent;
            border: none;
            color: #54656f;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }

        .sidebar-btn:hover {
            background: #e9edef;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #e9edef;
        }

        .chat-item:hover {
            background: #f5f6f6;
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #128C7E, #075E54);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            margin-left: 15px;
        }

        .chat-info {
            flex: 1;
        }

        .chat-name {
            font-weight: 500;
            color: #111b21;
            margin-bottom: 4px;
        }

        .chat-last-message {
            color: #667781;
            font-size: 14px;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #efeae2;
        }

        .chat-area-header {
            background: #f0f2f5;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #efeae2;
        }

        .message {
            margin-bottom: 12px;
            display: flex;
        }

        .message.sent {
            justify-content: flex-end;
        }

        .message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 8px;
            word-wrap: break-word;
        }

        .message.sent .message-bubble {
            background: #d9fdd3;
        }

        .message.received .message-bubble {
            background: white;
        }

        .message-text {
            color: #111b21;
            font-size: 14px;
            line-height: 1.5;
        }

        .message-time {
            font-size: 11px;
            color: #667781;
            margin-top: 4px;
            text-align: left;
        }

        /* Input Area */
        .input-area {
            background: #f0f2f5;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-box {
            flex: 1;
            background: white;
            border-radius: 25px;
            padding: 10px 20px;
            display: flex;
            align-items: center;
        }

        .input-box input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 15px;
        }

        .send-btn {
            background: #128C7E;
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }

        .send-btn:hover {
            background: #075E54;
        }

        /* No Chat Selected */
        .no-chat-selected {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .no-chat-icon {
            font-size: 80px;
            color: #d9d9d9;
            margin-bottom: 20px;
        }

        .no-chat-title {
            font-size: 32px;
            color: #41525d;
            margin-bottom: 15px;
        }

        .no-chat-subtitle {
            font-size: 14px;
            color: #667781;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #111b21;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #54656f;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9edef;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 15px;
        }

        .modal-input:focus {
            outline: none;
            border-color: #128C7E;
        }

        .modal-btn {
            background: #25d366;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
        }

        .modal-btn:hover {
            background: #1da851;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
            }
            
            .chat-area {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 100;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
    </div>

    <!-- Gmail Screen -->
    <div id="gmail-screen" class="hidden">
        <div class="gmail-header">
            <button class="gmail-menu-btn" onclick="app.showLoginScreen()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="gmail-search">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ®ÿ±ŸäÿØ">
            </div>
            <div class="gmail-profile-icon" onclick="app.showChatScreen()">
                <span id="gmail-profile-letter">G</span>
            </div>
        </div>
        <div class="gmail-content" id="gmail-emails"></div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-comments"></i>
            </div>
            <h1 class="login-title">ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ!</h1>
            <p class="login-subtitle">ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ŸÑŸÑÿØÿÆŸàŸÑ</p>
            <input type="text" class="login-input" id="user-code-input" placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ" maxlength="8">
            <button class="login-btn" onclick="app.loginUser()">ÿØÿÆŸàŸÑ</button>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen" class="hidden">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ</h2>
                <div class="sidebar-actions">
                    <button class="sidebar-btn" onclick="app.showSearchModal()" title="ÿ•ÿ∂ÿßŸÅÿ© ÿµÿØŸäŸÇ">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <button class="sidebar-btn" onclick="app.showGmailScreen()" title="Ÿàÿßÿ¨Ÿáÿ© Gmail">
                        <i class="fas fa-envelope"></i>
                    </button>
                </div>
            </div>
            <div class="chats-list" id="chats-list"></div>
        </div>

        <div class="no-chat-selected" id="no-chat-selected">
            <div class="no-chat-icon">
                <i class="fas fa-comments"></i>
            </div>
            <h2 class="no-chat-title">ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™</h2>
            <p class="no-chat-subtitle">
                ÿßÿ®ÿØÿ£ ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ© ŸÖÿπ ÿ£ÿµÿØŸÇÿßÿ¶ŸÉ
            </p>
        </div>

        <div class="chat-area hidden" id="chat-area">
            <div class="chat-area-header">
                <div class="chat-user-info">
                    <div class="chat-avatar" id="current-chat-avatar"></div>
                    <div>
                        <div class="chat-name" id="current-chat-name"></div>
                    </div>
                </div>
            </div>

            <div class="messages-container" id="messages-container"></div>

            <div class="input-area">
                <div class="input-box">
                    <input type="text" id="message-input" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©">
                </div>
                <button class="send-btn" onclick="app.sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Main Application
        const app = {
            currentUser: null,
            currentChatUser: null,
            db: null,

            // Initialize
            init() {
                console.log('üöÄ Initializing app...');
                
                // Wait for Firebase to load
                const checkFirebase = setInterval(() => {
                    if (window.firebaseDB) {
                        clearInterval(checkFirebase);
                        this.db = window.firebaseDB;
                        console.log('‚úÖ Firebase connected');
                        this.startApp();
                    }
                }, 100);

                // Timeout after 5 seconds
                setTimeout(() => {
                    if (!this.db) {
                        clearInterval(checkFirebase);
                        console.error('‚ùå Firebase failed to load');
                        alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ Firebase.');
                        this.hideLoading();
                        this.showLoginScreen();
                    }
                }, 5000);
            },

            startApp() {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.showGmailScreen();
                } else {
                    this.showLoginScreen();
                }
                this.hideLoading();
            },

            hideLoading() {
                document.getElementById('loading-screen').classList.add('hidden');
            },

            // Login
            async loginUser() {
                const codeInput = document.getElementById('user-code-input');
                const code = codeInput.value.trim().toUpperCase();

                if (code.length < 4) {
                    alert('ÿßŸÑŸÉŸàÿØ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ 4 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                    return;
                }

                try {
                    const userRef = this.db.ref(this.db.database, 'users/' + code);
                    const snapshot = await this.db.get(userRef);

                    if (snapshot.exists()) {
                        this.currentUser = snapshot.val();
                        this.currentUser.code = code;
                    } else {
                        // Create new user
                        this.currentUser = {
                            name: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ' + code,
                            code: code,
                            createdAt: Date.now(),
                            friends: {},
                            friendRequests: {}
                        };
                        await this.db.set(userRef, this.currentUser);
                        alert('ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ® ÿ¨ÿØŸäÿØ ÿ®ŸÜÿ¨ÿßÿ≠! üéâ');
                    }

                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    this.showGmailScreen();
                } catch (error) {
                    console.error('Login error:', error);
                    alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ' + error.message);
                }
            },

            // Screen Navigation
            showLoginScreen() {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('gmail-screen').classList.add('hidden');
                document.getElementById('chat-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            },

            showGmailScreen() {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('chat-screen').classList.add('hidden');
                document.getElementById('gmail-screen').classList.remove('hidden');
                
                if (this.currentUser) {
                    document.getElementById('gmail-profile-letter').textContent = 
                        this.currentUser.name.charAt(0);
                    this.loadFakeEmails();
                }
            },

            showChatScreen() {
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('gmail-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('chat-screen').classList.remove('hidden');
                this.loadChats();
            },

            // Load Fake Emails
            loadFakeEmails() {
                const emails = [
                    { sender: 'Facebook', subject: 'ŸÑÿØŸäŸÉ ÿ•ÿ¥ÿπÿßÿ± ÿ¨ÿØŸäÿØ', time: 'ŸÇÿ®ŸÑ ÿ≥ÿßÿπÿ©' },
                    { sender: 'Instagram', subject: 'ŸÖÿ™ÿßÿ®ÿπ ÿ¨ÿØŸäÿØ', time: 'ŸÇÿ®ŸÑ ÿ≥ÿßÿπÿ™ŸäŸÜ' },
                    { sender: 'YouTube', subject: 'ŸÅŸäÿØŸäŸà ÿ¨ÿØŸäÿØ', time: 'ŸÇÿ®ŸÑ 3 ÿ≥ÿßÿπÿßÿ™' },
                    { sender: 'Twitter', subject: 'ÿ•ÿ¥ÿπÿßÿ±', time: 'ÿ£ŸÖÿ≥' }
                ];

                const container = document.getElementById('gmail-emails');
                container.innerHTML = '';

                emails.forEach(email => {
                    const div = document.createElement('div');
                    div.className = 'email-item';
                    div.innerHTML = `
                        <div class="email-avatar">${email.sender.charAt(0)}</div>
                        <div class="email-info">
                            <div class="email-sender">${email.sender}</div>
                            <div class="email-subject">${email.subject} - ${email.time}</div>
                        </div>
                    `;
                    container.appendChild(div);
                });
            },

            // Load Chats
            async loadChats() {
                const chatsList = document.getElementById('chats-list');
                chatsList.innerHTML = '';

                if (!this.currentUser || !this.currentUser.friends) {
                    chatsList.innerHTML = `
                        <div style="padding: 40px; text-align: center; color: #667781;">
                            <i class="fas fa-user-friends" style="font-size: 50px; margin-bottom: 15px;"></i>
                            <h3>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ÿµÿØŸÇÿßÿ° ÿ®ÿπÿØ</h3>
                            <p>ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ÿµÿØŸÇÿßÿ° ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ≤ÿ± ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©</p>
                        </div>
                    `;
                    return;
                }

                const friends = Object.keys(this.currentUser.friends);
                for (const friendCode of friends) {
                    try {
                        const friendRef = this.db.ref(this.db.database, 'users/' + friendCode);
                        const snapshot = await this.db.get(friendRef);
                        
                        if (snapshot.exists()) {
                            const friend = snapshot.val();
                            const chatDiv = document.createElement('div');
                            chatDiv.className = 'chat-item';
                            chatDiv.innerHTML = `
                                <div class="chat-avatar">${friend.name.charAt(0)}</div>
                                <div class="chat-info">
                                    <div class="chat-name">${friend.name}</div>
                                    <div class="chat-last-message">ÿßŸÜŸÇÿ± ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©</div>
                                </div>
                            `;
                            chatDiv.onclick = () => this.openChat(friend);
                            chatsList.appendChild(chatDiv);
                        }
                    } catch (error) {
                        console.error('Error loading friend:', error);
                    }
                }
            },

            // Open Chat
            openChat(friend) {
                this.currentChatUser = friend;
                document.getElementById('no-chat-selected').classList.add('hidden');
                document.getElementById('chat-area').classList.remove('hidden');
                
                document.getElementById('current-chat-name').textContent = friend.name;
                document.getElementById('current-chat-avatar').textContent = friend.name.charAt(0);
                
                this.loadMessages(friend.code);
            },

            // Load Messages
            async loadMessages(friendCode) {
                const container = document.getElementById('messages-container');
                container.innerHTML = '';

                const chatId = [this.currentUser.code, friendCode].sort().join('_');
                const messagesRef = this.db.ref(this.db.database, 'chats/' + chatId + '/messages');
                
                this.db.onValue(messagesRef, (snapshot) => {
                    container.innerHTML = '';
                    
                    if (snapshot.exists()) {
                        const messages = snapshot.val();
                        Object.keys(messages).forEach(messageId => {
                            const message = messages[messageId];
                            this.displayMessage(message);
                        });
                    }
                    
                    container.scrollTop = container.scrollHeight;
                });
            },

            // Display Message
            displayMessage(message) {
                const container = document.getElementById('messages-container');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message ' + 
                    (message.senderId === this.currentUser.code ? 'sent' : 'received');
                
                messageDiv.innerHTML = `
                    <div class="message-bubble">
                        <div class="message-text">${message.text}</div>
                        <div class="message-time">${this.formatTime(message.timestamp)}</div>
                    </div>
                `;
                
                container.appendChild(messageDiv);
            },

            // Send Message
            async sendMessage() {
                const input = document.getElementById('message-input');
                const text = input.value.trim();

                if (!text || !this.currentChatUser) return;

                try {
                    const chatId = [this.currentUser.code, this.currentChatUser.code].sort().join('_');
                    const messageId = 'msg_' + Date.now();
                    
                    const message = {
                        id: messageId,
                        senderId: this.currentUser.code,
                        receiverId: this.currentChatUser.code,
                        type: 'text',
                        text: text,
                        timestamp: Date.now()
                    };

                    const messageRef = this.db.ref(
                        this.db.database, 
                        'chats/' + chatId + '/messages/' + messageId
                    );
                    
                    await this.db.set(messageRef, message);
                    input.value = '';
                } catch (error) {
                    console.error('Send message error:', error);
                    alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ');
                }
            },

            // Show Search Modal
            showSearchModal() {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <div class="modal-title">ÿ•ÿ∂ÿßŸÅÿ© ÿµÿØŸäŸÇ</div>
                            <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                        </div>
                        <input type="text" class="modal-input" id="search-code-input" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸàÿØ ÿßŸÑÿµÿØŸäŸÇ">
                        <button class="modal-btn" onclick="app.searchUser()">ÿ®ÿ≠ÿ´</button>
                        <div id="search-result" style="margin-top: 20px;"></div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            // Search User
            async searchUser() {
                const code = document.getElementById('search-code-input').value.trim().toUpperCase();
                const resultDiv = document.getElementById('search-result');

                if (!code) {
                    alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÉŸàÿØ');
                    return;
                }

                if (code === this.currentUser.code) {
                    alert('ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ŸÜŸÅÿ≥ŸÉ!');
                    return;
                }

                try {
                    const userRef = this.db.ref(this.db.database, 'users/' + code);
                    const snapshot = await this.db.get(userRef);

                    if (snapshot.exists()) {
                        const user = snapshot.val();
                        const isFriend = this.currentUser.friends && this.currentUser.friends[code];

                        resultDiv.innerHTML = `
                            <div style="text-align: center; padding: 20px; background: #f0f2f5; border-radius: 8px;">
                                <div style="font-size: 50px; margin-bottom: 10px;">üë§</div>
                                <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">${user.name}</div>
                                <div style="color: #667781; margin-bottom: 15px;">ÿßŸÑŸÉŸàÿØ: ${code}</div>
                                ${isFriend ? 
                                    '<button class="modal-btn" disabled>ÿ£ŸÜÿ™ ÿ£ÿµÿØŸÇÿßÿ° ÿ®ÿßŸÑŸÅÿπŸÑ</button>' :
                                    '<button class="modal-btn" onclick="app.addFriend(\'' + code + '\')">ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿµÿØÿßŸÇÿ©</button>'
                                }
                            </div>
                        `;
                    } else {
                        alert('ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´');
                }
            },

            // Add Friend
            async addFriend(friendCode) {
                try {
                    // Add to current user's friends
                    const userFriendRef = this.db.ref(
                        this.db.database,
                        'users/' + this.currentUser.code + '/friends/' + friendCode
                    );
                    await this.db.set(userFriendRef, true);

                    // Add to friend's friends
                    const friendUserRef = this.db.ref(
                        this.db.database,
                        'users/' + friendCode + '/friends/' + this.currentUser.code
                    );
                    await this.db.set(friendUserRef, true);

                    // Update local user
                    if (!this.currentUser.friends) this.currentUser.friends = {};
                    this.currentUser.friends[friendCode] = true;
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));

                    alert('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿµÿØŸäŸÇ ÿ®ŸÜÿ¨ÿßÿ≠! üéâ');
                    document.querySelector('.modal').remove();
                    this.loadChats();
                } catch (error) {
                    console.error('Add friend error:', error);
                    alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©');
                }
            },

            // Format Time
            formatTime(timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
            }
        };

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }

        // Handle Enter key for message input
        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('message-input');
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        app.sendMessage();
                    }
                });
            }
        });
    </script>
</body>
</html>
